##############################################################################
#                                                                            #
# IAR 8051 C-Compiler V5.20A/386                                             #
# Front End V4.20N                                       19/Sep/104  17:59:48 #
# Global Optimizer V1.04E                                                    #
#                                                                            #
#       Target option =  8051                                                #
#       Memory model  =  large                                               #
#       Source file   =  filesystem.c                                        #
#       List file     =  release\list\filesystem.lst                         #
#       Object file   =  release\obj\filesystem.r03                          #
#       Command line  =  FileSystem.c -S -ml -v0 -e -K -u -s9 -RCODE -gA     #
#                        -IC:\IAR\EW\8051\inc\ -ORelease\Obj\                #
#                        -LRelease\List\ -q -i -t8 -x                        #
#                                                                            #
#                                             (c) Copyright IAR Systems 1996 #
##############################################################################

   \   0000                    NAME    filesystem(18)
   \   0000                    RSEG    CODE(0)
   \   0000                    RSEG    CSTR(0)
   \   0000                    RSEG    X_UDATA(0)
   \   0000                    PUBLIC  Dir
   \   0000                    $DEFFN  Dir(0,0,19,0,32768,0,0,0),GetFileHead,SendStringRS232,SendStringRS232,
   \   0000                            myLong2HexStr,SendStringEOLRS232
   \   0000                    PUBLIC  EraseAll
   \   0000                    $DEFFN  EraseAll(0,0,2,0,32768,0,0,0),EraseBlock
   \   0000                    PUBLIC  EraseBlock
   \   0000                    $DEFFN  EraseBlock(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  EraseDynamic
   \   0000                    $DEFFN  EraseDynamic(0,0,5,0,32768,0,0,0),fopen,EraseBlock,fclose
   \   0000                    PUBLIC  FLASHKey
   \   0000                    PUBLIC  FLASHWriteState
   \   0000                    PUBLIC  FileOpen
   \   0000                    $DEFFN  FileOpen(0,0,3,0,32768,0,3,0),myStrCmpNoCase
   \   0000                    PUBLIC  FindEmptyFileStruct
   \   0000                    $DEFFN  FindEmptyFileStruct(0,0,1,0,32768,0,0,0)
   \   0000                    PUBLIC  GetFileHead
   \   0000                    $DEFFN  GetFileHead(0,0,5,0,32768,0,3,0),SetupSpareReadSeq,ReadFLASH,TerminateReadSeq,
   \   0000                            ReadFLASH,ReadFLASH,ReadFLASH,ReadFLASH,ReadFLASH,ReadFLASH,ReadFLASH,
   \   0000                            ReadFLASH,TerminateReadSeq
   \   0000                    PUBLIC  InitializeFileSystem
   \   0000                    $DEFFN  InitializeFileSystem(0,0,1,0,32768,0,0,0)
   \   0000                    PUBLIC  InitializeFlash
   \   0000                    $DEFFN  InitializeFlash(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  MemUsage
   \   0000                    $DEFFN  MemUsage(0,0,19,0,32768,0,0,0),GetFileHead
   \   0000                    PUBLIC  PerformWriteSeq
   \   0000                    $DEFFN  PerformWriteSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  ReadFLASH
   \   0000                    $DEFFN  ReadFLASH(0,0,3,0,32768,0,0,0),SetupReadSeq
   \   0000                    PUBLIC  ReleaseCurrFile
   \   0000                    $DEFFN  ReleaseCurrFile(0,0,2,0,32768,0,0,0),PerformWriteSeq,TerminateWriteSeq,
   \   0000                            TerminateReadSeq
   \   0000                    EXTERN  SendRS232
   \   0000                    $DEFFN  SendRS232(32768,0,1,0),fgetc
   \   0000                    EXTERN  SendStringEOLRS232
   \   0000                    $DEFFN  SendStringEOLRS232(32768,0,3,0)
   \   0000                    EXTERN  SendStringRS232
   \   0000                    $DEFFN  SendStringRS232(32768,0,3,0)
   \   0000                    PUBLIC  SetupReadSeq
   \   0000                    $DEFFN  SetupReadSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  SetupSpareReadSeq
   \   0000                    $DEFFN  SetupSpareReadSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  SetupSpareWriteSeq
   \   0000                    $DEFFN  SetupSpareWriteSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  SetupWriteSeq
   \   0000                    $DEFFN  SetupWriteSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  StartDynamic
   \   0000                    $DEFFN  StartDynamic(0,0,38,0,32768,0,0,0),GetFileHead,fopenA,SendStringEOLRS232,
   \   0000                            fputc,fclose
   \   0000                    PUBLIC  TerminateReadSeq
   \   0000                    $DEFFN  TerminateReadSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  TerminateWriteSeq
   \   0000                    $DEFFN  TerminateWriteSeq(0,0,0,0,32768,0,0,0)
   \   0000                    PUBLIC  Type
   \   0000                    $DEFFN  Type(0,0,9,0,32768,0,0,0),fopen,SendRS232,fgetc,fclose
   \   0000                    PUBLIC  TypeA
   \   0000                    $DEFFN  TypeA(0,0,10,0,32768,0,0,0),fopen,fgetc,SendRS232,fclose,SendStringEOLRS232
   \   0000                    EXTERN  WaitAndReceiveRS232
   \   0000                    $DEFFN  WaitAndReceiveRS232(32768,0,0,0)
   \   0000                    PUBLIC  WriteFLASH
   \   0000                    $DEFFN  WriteFLASH(0,0,2,0,32768,0,1,0),SetupWriteSeq,PerformWriteSeq
   \   0000                    PUBLIC  WriteFileHead
   \   0000                    $DEFFN  WriteFileHead(0,0,5,0,32768,0,7,0),SetupSpareWriteSeq,WriteFLASH,
   \   0000                            WriteFLASH,WriteFLASH,WriteFLASH,WriteFLASH,WriteFLASH,WriteFLASH,WriteFLASH,
   \   0000                            WriteFLASH,PerformWriteSeq,TerminateWriteSeq
   \   0000                    EXTERN  commandLine
   \   0000                    PUBLIC  dataFieldCounter
   \   0000                    PUBLIC  eraseAddress
   \   0000                    EXTERN  error
   \   0000                    PUBLIC  fSetPos
   \   0000                    $DEFFN  fSetPos(0,0,2,0,32768,0,7,0),TerminateReadSeq,SetupReadSeq
   \   0000                    PUBLIC  fclose
   \   0000                    $DEFFN  fclose(0,0,2,0,32768,0,3,0),PerformWriteSeq,TerminateWriteSeq,
   \   0000                            WriteFileHead,TerminateReadSeq
   \   0000                    PUBLIC  fdownLoad
   \   0000                    $DEFFN  fdownLoad(0,0,34,0,32768,0,0,0),SendRS232,GetFileHead,WaitAndReceiveRS232,
   \   0000                            SendRS232,SendStringRS232,SendRS232,WaitAndReceiveRS232,SendRS232,WaitAndReceiveRS232,
   \   0000                            SendRS232,WaitAndReceiveRS232,WaitAndReceiveRS232,GetFileHead,fopen,
   \   0000                            SendRS232,SendRS232,SendRS232,SendRS232,SendRS232,SendRS232,WaitAndReceiveRS232,
   \   0000                            fgetc,SendRS232,SendRS232,SendRS232,fclose,SendRS232
   \   0000                    PUBLIC  fgetLine
   \   0000                    $DEFFN  fgetLine(0,0,5,0,32768,0,8,0),fgetc,fgetc
   \   0000                    PUBLIC  fgetc
   \   0000                    $DEFFN  fgetc(0,0,2,0,32768,0,3,0),ReleaseCurrFile,SetupReadSeq,ReadFLASH
   \   0000                    PUBLIC  fopen
   \   0000                    $DEFFN  fopen(0,0,23,0,32768,0,6,0),FileOpen,FindEmptyFileStruct,GetFileHead,
   \   0000                            myStrCmpNoCase,myStrCpy,SetupReadSeq,GetFileHead,myStrCmpNoCase,myStrCpy,
   \   0000                            SetupWriteSeq
   \   0000                    PUBLIC  fopenA
   \   0000                    $DEFFN  fopenA(0,0,30,0,32768,0,11,0),FileOpen,FindEmptyFileStruct,GetFileHead,
   \   0000                            myStrCmpNoCase,myStrCpy,SetupReadSeq,ReadFLASH,ReadFLASH,SetupReadSeq,
   \   0000                            WriteFileHead,SetupWriteSeq
   \   0000                    PUBLIC  fputc
   \   0000                    $DEFFN  fputc(0,0,2,0,32768,0,4,0),ReleaseCurrFile,SetupWriteSeq,WriteFLASH,
   \   0000                            WriteFLASH
   \   0000                    PUBLIC  fs_currFilePtr
   \   0000                    PUBLIC  fs_files
   \   0000                    PUBLIC  ftell
   \   0000                    $DEFFN  ftell(0,0,0,0,32768,0,3,0)
   \   0000                    PUBLIC  fupLoad
   \   0000                    $DEFFN  fupLoad(0,0,268,0,32768,0,0,0),SendRS232,WaitAndReceiveRS232,SendRS232,
   \   0000                            WaitAndReceiveRS232,SendRS232,fopen,SendRS232,SendRS232,WaitAndReceiveRS232,
   \   0000                            WaitAndReceiveRS232,SendRS232,WaitAndReceiveRS232,WaitAndReceiveRS232,
   \   0000                            fputc,SendRS232,SendRS232,fclose,SendRS232
   \   0000                    EXTERN  msg
   \   0000                    EXTERN  myLong2HexStr
   \   0000                    $DEFFN  myLong2HexStr(32768,0,7,0)
   \   0000                    EXTERN  myStrCmpNoCase
   \   0000                    $DEFFN  myStrCmpNoCase(32768,0,6,0)
   \   0000                    EXTERN  myStrCpy
   \   0000                    $DEFFN  myStrCpy(32768,0,6,0)
   \   0000                    PUBLIC  readAddress
   \   0000                    EXTERN  timeout
   \   0000                    PUBLIC  writeAddress
   \   0000                    PUBLIC  writeInProgress
   \   0000                    EXTERN  ?L_ADD_L01
   \   0000                    EXTERN  ?L_SUB_L01
   \   0000                    EXTERN  ?L_AND_L01
   \   0000                    EXTERN  ?SL_SHR_L01
   \   0000                    EXTERN  ?L_SHL_L01
   \   0000                    EXTERN  ?L_CMP_L01
   \   0000                    EXTERN  ?L_ADD_ASG_R123_R4567_L01
   \   0000                    EXTERN  ?L_ADD_ASG_DPTR_R4567_L01
   \   0000                    EXTERN  ?L_ADD_ASG_R567_R0123_DISP_L01
   \   0000                    EXTERN  ?LD_A_R567_L17
   \   0000                    EXTERN  ?ST_A_R567_L17
   \   0000                    EXTERN  ?ST_R4567_R123_L17
   \   0000                    EXTERN  ?LD_A_R567_DISP_L17
   \   0000                    EXTERN  ?ST_A_R123_DISP_L17
   \   0000                    EXTERN  ?ST_A_R567_DISP_L17
   \   0000                    EXTERN  ?LD_R4567_R123_DISP_L17
   \   0000                    EXTERN  ?LD_R0123_R567_DISP_L17
   \   0000                    EXTERN  ?ST_R4567_R123_DISP_L17
   \   0000                    EXTERN  ?STO_R0123_DPTR_L20
   \   0000                    EXTERN  ?STO_R4567_DPTR_L20
   \   0000                    EXTERN  ?LD_R0123_XDPTR_L20
   \   0000                    EXTERN  ?LD_R4567_XDPTR_L20
   \   0000                    EXTERN  ?CL8051L_5_20_L17
   \   0000                    RSEG    CODE
      1          /*************************************************************
      2          Fil:            $Id: FileSystem.c,v 1.4 2003/11/20 22:08:52 Gemensam Exp $
      3          
      4          Beskrivning:    Procedurer och funktioner för hantering av
      5                          FLASH-minnen och filhantering
      6          
      7          Skapad:         99-09-20
      8          
      9          Ändrad:         $Date: 2003/11/20 22:08:52 $
     10          
     11          Ägare:          Fredrik Hoffman
     12          
     13          Revisionshistoria:
     14                                          $Log: FileSystem.c,v $
     15                                          Revision 1.4  2003/11/20 22:08:52  Gemensam
     16                                          Various declarations changes.
     17                                          Still version 0200.
     18                                          
     19                                          Revision 1.3  2003/11/18 19:17:36  Gemensam
     20                                          Added menu option of setting speaker volume (untested)
     21                                          Completely changed header files
     22                                          Version 0200.
     23                                          
     24                                          Revision 1.2  2003/11/10 22:44:45  Gemensam
     25                                          Added header information
     26                                          
     27          
     28          *************************************************************/
     29          
     30          //////////////////////
     31          // Inkluderingar
     32          
     33          #include <io517a.h>
      1          /*                     - IO517A.H -
      2          
      3             Special header for the Siemens SAB 80C517A/83C517A-5 processors.
      4          
      5             Version 5.20 [IMAF]
      6          
      7          */
      8          
      9          #pragma language=extended
     10          
     11          /* Pre-defined SFR byte addresses: */
     12          
     13          /* CPU */
     14          sfr     ACC    = 0xE0;
     15          sfr     B      = 0xF0;
     16          sfr     SP     = 0x81;
     17          sfr     DPL    = 0x82;
     18          sfr     DPH    = 0x83;
     19          sfr     DPSEL  = 0x92;
     20          sfr     PSW    = 0xD0;
     21          sfr     XPAGE  = 0x91;
     22          sfr     SYSCON = 0xB1;
     23          
     24          /* Timer 0/Timer 1 */
     25          sfr     TCON   = 0x88;
     26          sfr     TMOD   = 0x89;
     27          sfr     TL0    = 0x8A;
     28          sfr     TL1    = 0x8B;
     29          sfr     TH0    = 0x8C;
     30          sfr     TH1    = 0x8D;
     31          
     32          /* CCU */
     33          sfr     CCEN   = 0xC1;
     34          sfr     CC4EN  = 0xC9;
     35          sfr     CCL1   = 0xC2;
     36          sfr     CCH1   = 0xC3;
     37          sfr     CCL2   = 0xC4;
     38          sfr     CCH2   = 0xC5;
     39          sfr     CCL3   = 0xC6;
     40          sfr     CCH3   = 0xC7;
     41          sfr     CCL4   = 0xCE;
     42          sfr     CCH4   = 0xCF;
     43          sfr     CMEN   = 0xF6;
     44          sfr     CML0   = 0xD2;
     45          sfr     CMH0   = 0xD3;
     46          sfr     CML1   = 0xD4;
     47          sfr     CMH1   = 0xD5;
     48          sfr     CML2   = 0xD6;
     49          sfr     CMH2   = 0xD7;
     50          sfr     CML3   = 0xE2;
     51          sfr     CMH3   = 0xE3;
     52          sfr     CML4   = 0xE4;
     53          sfr     CMH4   = 0xE5;
     54          sfr     CML5   = 0xE6;
     55          sfr     CMH5   = 0xE7;
     56          sfr     CML6   = 0xF2;
     57          sfr     CMH6   = 0xF3;
     58          sfr     CML7   = 0xF4;
     59          sfr     CMH7   = 0xF5;
     60          sfr     CMSEL  = 0xF7;
     61          sfr     CRCL   = 0xCA;
     62          sfr     CRCH   = 0xCB;
     63          sfr     CTCON  = 0xE1;
     64          sfr     CTRELL = 0xDE;
     65          sfr     CTRELH = 0xDF;
     66          sfr     TL2    = 0xCC;
     67          sfr     TH2    = 0xCD;
     68          sfr     T2CON  = 0xC8;
     69          sfr     COMSETL= 0xA1;
     70          sfr     COMSETH= 0xA2;
     71          sfr     COMCLRL= 0xA3;
     72          sfr     COMCLRH= 0xA4;
     73          sfr     SETMSK = 0xA5;
     74          sfr     CLRMSK = 0xA6;
     75          
     76          /* Ports */
     77          sfr     P0     = 0x80;
     78          sfr     P1     = 0x90;
     79          sfr     P2     = 0xA0;
     80          sfr     P3     = 0xB0;
     81          sfr     P4     = 0xE8;
     82          sfr     P5     = 0xF8;
     83          sfr     P6     = 0xFA;
     84          sfr     P7     = 0xDB;        /* Analog/Digital Input */
     85          sfr     P8     = 0xDD;        /* Analog/Digital Input, 4 Bit */
     86          
     87          /* Serial Channels */
     88          sfr     PCON   = 0x87;
     89          sfr     S0CON  = 0x98;
     90          sfr     S0BUF  = 0x99;
     91          sfr     S1CON  = 0x9B;
     92          sfr     S1BUF  = 0x9C;
     93          sfr     S0RELL = 0xAA;
     94          sfr     S0RELH = 0xBA;
     95          sfr     S1RELL = 0x9D;
     96          sfr     S1RELH = 0xBB;
     97          
     98          /* A/D Converter */
     99          sfr     ADCON0 = 0xD8;
    100          sfr     ADCON1 = 0xDC;
    101          sfr     ADDATH = 0xD9;
    102          sfr     ADDATL = 0xDA;
    103          
    104          /* MUL/DIV Unit */
    105          sfr     ARCON  = 0xEF;
    106          sfr     MD0    = 0xE9;
    107          sfr     MD1    = 0xEA;
    108          sfr     MD2    = 0xEB;
    109          sfr     MD3    = 0xEC;
    110          sfr     MD4    = 0xED;
    111          sfr     MD5    = 0xEE;
    112          
    113          /* Interrupt System */
    114          sfr     IEN0   = 0xA8;
    115          sfr     IP0    = 0xA9;
    116          sfr     IEN1   = 0xB8;
    117          sfr     IP1    = 0xB9;
    118          sfr     IEN2   = 0x9A;
    119          sfr     IRCON0 = 0xC0;
    120          sfr     IRCON1 = 0xD1;
    121          
    122          
    123          /* Watchdog */
    124          sfr     WDTREL = 0x86;
    125          
    126          
    127          /* Pre-defined SFR bit addresses */
    128          
    129          /*========ADCON0=======*/
    130          
    131          bit     BD     = 0xDF;
    132          bit     CLK    = 0xDE;
    133          bit     ADEX   = 0xDD;
    134          bit     BSY    = 0xDC;
    135          bit     ADM    = 0xDB;
    136          bit     MX2    = 0xDA;
    137          bit     MX1    = 0xD9;
    138          bit     MX0    = 0xD8;
    139          
    140          
    141          /*========IRCON0=======*/
    142          
    143          bit     EXF2   = 0xC7;
    144          bit     TF2    = 0xC6;
    145          bit     IEX6   = 0xC5;
    146          bit     IEX5   = 0xC4;
    147          bit     IEX4   = 0xC3;
    148          bit     IEX3   = 0xC2;
    149          bit     IEX2   = 0xC1;
    150          bit     IADC   = 0xC0;
    151          
    152          /*========T2CON=======*/
    153          
    154          bit     T2PS   = 0xCF;
    155          bit     I3FR   = 0xCE;
    156          bit     I2FR   = 0xCD;
    157          bit     T2R1   = 0xCC;
    158          bit     T2R0   = 0xCB;
    159          bit     T2CM   = 0xCA;
    160          bit     T2I1   = 0xC9;
    161          bit     T2I0   = 0xC8;
    162          
    163          /*========PSW=========*/
    164          
    165          bit     CY     = 0xD7;
    166          bit     AC     = 0xD6;
    167          bit     F0     = 0xD5;
    168          bit     RS1    = 0xD4;
    169          bit     RS0    = 0xD3;
    170          bit     OV     = 0xD2;
    171          bit     F1     = 0xD1;
    172          bit     P      = 0xD0;
    173          
    174          /*========TCON========*/
    175          
    176          bit     TF1    = 0x8F;
    177          bit     TR1    = 0x8E;
    178          bit     TF0    = 0x8D;
    179          bit     TR0    = 0x8C;
    180          bit     IE1    = 0x8B;
    181          bit     IT1    = 0x8A;
    182          bit     IE0    = 0x89;
    183          bit     IT0    = 0x88;
    184          
    185          /*========IEN0========*/
    186          
    187          bit     EAL    = 0xAF;
    188          bit     WDT    = 0xAE;
    189          bit     ET2    = 0xAD;
    190          bit     ES0    = 0xAC;
    191          bit     ET1    = 0xAB;
    192          bit     EX1    = 0xAA;
    193          bit     ET0    = 0xA9;
    194          bit     EX0    = 0xA8;
    195          
    196          /*========IEN1========*/
    197          
    198          bit     EXEN2  = 0xBF;
    199          bit     SWDT   = 0xBE;
    200          bit     EX6    = 0xBD;
    201          bit     EX5    = 0xBC;
    202          bit     EX4    = 0xBB;
    203          bit     EX3    = 0xBA;
    204          bit     EX2    = 0xB9;
    205          bit     EADC   = 0xB8;
    206          
    207          /*========P3=========*/
    208          
    209          bit     RD     = 0xB7;
    210          bit     WR     = 0xB6;
    211          bit     T1     = 0xB5;
    212          bit     T0     = 0xB4;
    213          bit     INT1   = 0xB3;
    214          bit     INT0   = 0xB2;
    215          bit     TXD    = 0xB1;
    216          bit     RXD    = 0xB0;
    217          
    218          /*========S0CON========*/
    219          
    220          bit     SM0    = 0x9F;
    221          bit     SM1    = 0x9E;
    222          bit     SM20   = 0x9D;
    223          bit     REN0   = 0x9C;
    224          bit     TB80   = 0x9B;
    225          bit     RB80   = 0x9A;
    226          bit     TI0    = 0x99;
    227          bit     RI0    = 0x98;
    228          
    229          
    230          /* Interrupt Vector Definitions */
    231          
    232          interrupt [0x03] void EX0_int (void);     /* External Interrupt 0 */
    233          
    234          interrupt [0x0B] void T0_int (void);      /* Timer 0 Overflow */
    235          
    236          interrupt [0x13] void EX1_int (void);     /* External Interrupt 1 */
    237          
    238          interrupt [0x1B] void T1_int (void);      /* Timer 1 Overflow */
    239          
    240          interrupt [0x23] void SCON0_int (void);   /* Serial Port 0 */
    241          
    242          interrupt [0x2B] void T2_int (void);      /* Timer 2 Overflow */
    243          
    244          interrupt [0x2B] void T2EX_int (void);    /* Negative Transition on T2EX */
    245          
    246          interrupt [0x43] void ADC_int (void);     /* ADC Interrupt */
    247          
    248          interrupt [0x4B] void EX2_int (void);     /* External Interrupt 2 */
    249          
    250          interrupt [0x53] void EX3_int (void);     /* External Interrupt 3 */
    251          
    252          interrupt [0x5B] void EX4_int (void);     /* External Interrupt 4 */
    253          
    254          interrupt [0x63] void EX5_int (void);     /* External Interrupt 5 */
    255          
    256          interrupt [0x6B] void EX6_int (void);     /* External Interrupt 6 */
    257          
    258          interrupt [0x83] void SCON1_int (void);   /* Serial Port 1 */
    259          
    260          interrupt [0x93] void ICMP_int (void);    /* Compare match interrupt */
    261          
    262          interrupt [0x9B] void CT_int (void);      /* Compare Timer Overflow */
    263          
    264          interrupt [0xA3] void ICS_int (void);     /* COMSET interrupt */
    265          
    266          interrupt [0xAB] void ICR_int (void);     /* COMCLR interrupt */
    267          
    268          
     34          #include <stdio.h>
      1          /*                      - STDIO.H -
      2          
      3             Subset of ANSI standard I/O function declarations.
      4          
      5             Version: 3.30 04/Nov/94 IHAW
      6          
      7          
      8          */
      9          
     10          #ifndef _STDIO_INCLUDED
     11          #define _STDIO_INCLUDED
     12          
     13          #ifndef NULL
     14          #define NULL    (void *) 0
     15          #endif
     16          
     17          #ifndef EOF
     18          #define EOF     (-1)
     19          #endif
     20          
     21          #ifndef size_t
     22          #if     sizeof((char*)0 - (char*)0) <= sizeof(int)
     23          #define size_t  unsigned int
     24          #else
     25          #define size_t  unsigned long 
     26          #endif
     27          #endif
     28          
     29          /* ===
     30          
     31          #if __TID__ & 0x8000
     32          #pragma function=intrinsic(0)
     33          #endif
     34          
     35          === */
     36          
     37          #ifndef MEMORY_ATTRIBUTE
     38          #define MEMORY_ATTRIBUTE
     39          #endif
     40          
     41          MEMORY_ATTRIBUTE int    puts(const char *__s);
     42          MEMORY_ATTRIBUTE int    putchar(int __value);
     43          MEMORY_ATTRIBUTE int    getchar(void);
     44          MEMORY_ATTRIBUTE int    sprintf(char *__s,const char *__format,...);
     45          MEMORY_ATTRIBUTE int    printf(const char *__format,...);
     46          MEMORY_ATTRIBUTE int    scanf(const char *__format,...);
     47          MEMORY_ATTRIBUTE int    sscanf(const char *__s, const char *__format,...);
     48          MEMORY_ATTRIBUTE char   *gets(char *__s);
     49          
     50          #if __TID__ & 0x8000
     51          #pragma function=default
     52          #endif
     53          
     54          #endif
     55          
     56          
     57          
     35          #include <string.h>
      1          /*                       - STRING.H -
      2          
      3             The ANSI 'string' function declarations.
      4                     
      5             Version: 3.30 04/Nov/94 IHAW
      6                             
      7          */
      8          
      9          #ifndef _STRING_INCLUDED
     10          #define _STRING_INCLUDED
     11          
     12          #ifndef NULL
     13          #define NULL    (void*)0     /* changed from char* 93.01.21 ICLM */
     14          #endif
     15          
     16          #ifndef size_t
     17          #if sizeof((char *)0 - (char *)0) <= sizeof(int)
     18          #define size_t          unsigned int
     19          #else
     20          #define size_t          unsigned long
     21          #endif
     22          #endif
     23          
     24          #if __TID__ & 0x8000
     25          #pragma function=intrinsic(0)
     26          #endif
     27          
     28          #ifndef MEMORY_ATTRIBUTE
     29          #define MEMORY_ATTRIBUTE
     30          #endif
     31          
     32          MEMORY_ATTRIBUTE void *memcpy(void *s1, const void *s2, size_t n);
     33          
     34          MEMORY_ATTRIBUTE void *memmove(void *s1, const void *s2, size_t n);
     35          
     36          MEMORY_ATTRIBUTE void *memchr(const void *s, int c, size_t n);
     37          
     38          MEMORY_ATTRIBUTE void *memset(void *s, int c, size_t n);
     39          
     40          MEMORY_ATTRIBUTE int memcmp(const void *s1, const void *s2, size_t n);
     41          
     42          MEMORY_ATTRIBUTE char *strchr(const char *s, int c);
     43          
     44          MEMORY_ATTRIBUTE int strcmp(const char *s1, const char *s2);
     45          
     46          MEMORY_ATTRIBUTE int strncmp(const char *s1, const char *s2, size_t n);
     47          
     48          MEMORY_ATTRIBUTE int strcoll(const char *s1, const char *s2);
     49          
     50          MEMORY_ATTRIBUTE size_t strlen(const char *s);
     51          
     52          MEMORY_ATTRIBUTE size_t strcspn(const char *s1, const char *s2);
     53          
     54          MEMORY_ATTRIBUTE size_t strspn(const char *s1, const char *s2);
     55          
     56          MEMORY_ATTRIBUTE char *strpbrk(const char *s1, const char *s2);
     57          
     58          MEMORY_ATTRIBUTE char *strrchr(const char *s, int c);
     59          
     60          MEMORY_ATTRIBUTE char *strstr(const char *s1, const char *s2);
     61          
     62          MEMORY_ATTRIBUTE char *strcat(char *s1, const char *s2);
     63          
     64          MEMORY_ATTRIBUTE char *strncat(char *s1, const char *s2, size_t n);
     65          
     66          MEMORY_ATTRIBUTE char *strcpy(char *s1, const char *s2);
     67          
     68          MEMORY_ATTRIBUTE char *strncpy(char *s1, const char *s2, size_t n);
     69          
     70          MEMORY_ATTRIBUTE char *strerror(int errnum);
     71          
     72          MEMORY_ATTRIBUTE char *strtok(char *s1, const char *s2);
     73          
     74          MEMORY_ATTRIBUTE size_t strxfrm(char *s1, const char *s2, size_t n);
     75          
     76          #if __TID__ & 0x8000
     77          #pragma function=default
     78          #endif
     79          
     80          #endif
     81          
     82          
     36          #include "main.h"
      1          /*************************************************************
      2          Fil:            $Id: Main.h,v 1.10 2003/12/26 16:17:01 Gemensam Exp $
      3          
      4          Ändrad:         $Date: 2003/12/26 16:17:01 $
      5          
      6          Revisionshistoria:
      7                                          $Log: Main.h,v $
      8                                          Revision 1.10  2003/12/26 16:17:01  Gemensam
      9                                          Reinstate 500 ms wait for hang up detection to settle (if not PPD is used).
     10                                          Fixed PPD detection by decreasing phone volume from 63 to 15.
     11                                          Version 0304.
     12                                          
     13                                          Revision 1.9  2003/12/09 20:52:49  Gemensam
     14                                          Commented out PPD detection since the HW not work yet.
     15                                          Ver 0302.
     16                                          
     17                                          Revision 1.8  2003/11/29 22:35:59  Gemensam
     18                                          Fixed problem with to short pulse width on PPD.
     19                                          Ver 0302.
     20                                          
     21                                          Revision 1.7  2003/11/24 22:44:36  Gemensam
     22                                          Fixed PPD, not working yet,
     23                                          New command: speaker volume.
     24                                          Version 0301.
     25                                          
     26                                          Revision 1.6  2003/11/23 21:40:03  Gemensam
     27                                          Parallell phone detection included.
     28                                          Removed obsolete #define's regarding LCD interface.
     29                                          Ver 0300
     30                                          
     31                                          Revision 1.5  2003/11/23 20:29:34  Gemensam
     32                                          Complete and tested volume setting in options menu.
     33                                          Ver 0201
     34                                          
     35                                          Revision 1.4  2003/11/20 22:08:53  Gemensam
     36                                          Various declarations changes.
     37                                          Still version 0200.
     38                                          
     39                                          Revision 1.3  2003/11/18 19:17:36  Gemensam
     40                                          Added menu option of setting speaker volume (untested)
     41                                          Completely changed header files
     42                                          Version 0200.
     43                                          
     44                                          Revision 1.2  2003/11/10 22:44:45  Gemensam
     45                                          Added header information
     46                                          
     47          *************************************************************/
     48          
     49          #ifndef _MAIN_INCLUDED_
     50          #define _MAIN_INCLUDED_
     51          
     52          #include "FileSystem.h"
      1          /**************************************************************************************
      2          Fil:            $Id: FileSystem.h,v 1.4 2003/11/20 22:08:53 Gemensam Exp $
      3          
      4          Ändrad:         $Date: 2003/11/20 22:08:53 $
      5          
      6          Kommentarer:    Filhuvudet befinner sig i "Spare" arean tillhörande filens första sida. Huvudet består 
      7                                          av 16 bytes enligt följande lista:
      8                                          0       Huvud       0xAA = Legalt filhuvud, annat tillsvidare odefinierat
      9                                          1-4     Fillängd    Pos 1 = MSB, pos 4 = LSB
     10                                          5-12    Filtitel    Enl "Titel.ext". Om titeln är mindre än 8 tecken avslutas det med nollor
     11                                          13-15   Filext      Enl "Titel.ext". Om ext är mindre än 3 tecken avslutas det med nollor
     12          
     13                                          En nolla skriven i fileName[0] indikerar att
     14                                          filstrukturen är ledig.
     15                  
     16          Revisionshistoria:
     17                                          $Log: FileSystem.h,v $
     18                                          Revision 1.4  2003/11/20 22:08:53  Gemensam
     19                                          Various declarations changes.
     20                                          Still version 0200.
     21                                          
     22                                          Revision 1.3  2003/11/18 19:17:36  Gemensam
     23                                          Added menu option of setting speaker volume (untested)
     24                                          Completely changed header files
     25                                          Version 0200.
     26                                          
     27                                          Revision 1.2  2003/11/10 22:44:45  Gemensam
     28                                          Added header information
     29                                          
     30          
     31          **************************************************************************************/
     32          
     33          #ifndef _FILESYSTEM_INCLUDED_
     34          #define _FILESYSTEM_INCLUDED_
     35          
     36          ///////////////////////////////////
     37          // Definitioner
     38          
     39          #define FS_MAXFILES         8 
     40          #define FS_FILENAMELENGTH   13
     41          #define FS_FLASHSIZE        0x800000
     42          
     43          #define OFF            0
     44          #define READY        1
     45          #define NEMPTY        2
     46          #define WRITING        3
     47          #define OCCUPIED    4
     48          
     49          #define CLE     P4.0                                //Command Latch Enable
     50          #define ALE     P4.1                                //Address Latch Enable
     51          #define WP      P4.2                                //Write Protect
     52          #define SE      P4.3                                //Spare Enable
     53          //#define CE      P4.4                                //Chip Enable
     54          #define FBUSY   P4.5                                //Busy
     55          
     56          #define FREG (*(unsigned char xdata *) 0xE000)
     57          #define FLASH (*(unsigned char xdata *) 0xB000) 
     58          
     59          ///////////////////////////////////
     60          // Strukturer
     61          
     62          struct ST_FILE_HEAD {
     63              unsigned long   length;
     64              char            name[FS_FILENAMELENGTH];
     65          };
     66          #define FILE_HEAD struct ST_FILE_HEAD
     67          
     68          
     69          struct ST_FILE {
     70              char            fileName[FS_FILENAMELENGTH];
     71              unsigned long   startAddress;
     72              unsigned long   length; 
     73              unsigned long   offset; 
     74              char            write;
     75              char            append;
     76          };
     77          #define FILE struct ST_FILE 
     78          
     79          
     80          
     81          ///////////////////////////////////
     82          // Funktioner och procedurer
     83          
     84          extern void            InitializeFileSystem( void );
     85          extern void            InitializeFlash( void );
     86          extern void            SetupReadSeq( void );
     87          extern unsigned char   ReadFLASH( void );
     88          extern void            TerminateReadSeq( void );
     89          extern void            GetDeviceIDRS232(void);
     90          extern void            SetupWriteSeq( void );
     91          extern void            WriteFLASH(unsigned char);
     92          extern void            TerminateWriteSeq( void );
     93          extern void            PerformWriteSeq( void );
     94          extern void            EraseBlock( void );
     95          extern void            WriteFileHead(const char* name, long size);
     96          extern FILE*           fopen(const char* name, const char* def);
     97          extern FILE*               fopenA(const char* name, long maxSize, long offset);
     98          extern void            fputc(FILE* filePtr, char c);
     99          extern void            fputLine(FILE* filePtr, const char* str);
    100          extern void            fupLoad( void );
    101          extern int             fgetc(FILE* filePtr);
    102          extern void            fgetLine(FILE* filePtr, char* str, int maxLen);
    103          extern void            fdownLoad( void );
    104          extern void            fclose(FILE* filePtr);
    105          extern long            ftell(FILE* filePtr);
    106          //void            Rewind(FILE* filePtr);
    107          extern void            fSetPos(FILE* filePtr, long offset);
    108          extern void            ReleaseCurrFile( void );
    109          extern void            EraseAll( void );
    110          extern void            StartDynamic( void );
    111          extern void            EraseDynamic( void );
    112          extern char                        MemUsage( void );
    113          extern void                        Dir( void );
    114          extern void                        Type( void );
    115          extern void                        TypeA( void );
    116          
    117          #endif
     53          
     54          
     55          ///////////////////////////////////
     56          // Definitioner
     57          
     58          #define VERSION_MENU_STRING     "Telestation 3.5       (c) 2004-09-19 FRHA"
     59          
     60          #define CM_PARSIZE              24
     61          #define CM_NRPAR                16
     62          
     63          #define MAX_LABEL_LEN   8
     64          #define MAX_LABELS      64
     65          
     66          // Nedan var ett försök till multipla bat-filer, kanske införs senare
     67          /*
     68          #define MAX_BATFILES    8
     69          */
     70          
     71          ///////////////////////////////////
     72          // Strukturer
     73          
     74          // Nedan var ett försök till multipla bat-filer, kanske införs senare
     75          /*
     76          struct ST_Label {
     77              char    name[MAX_LABEL_LEN];
     78              long    pos;
     79          };
     80          #define Label struct ST_Label
     81           
     82          struct ST_BatFileObj {
     83              FILE*       fp;                 //Filpekare till bat-filen
     84              Label*      labels;             //Pekare till lista med ingående labels
     85              char        labelIndex;         //Pekar på nästa lediga label
     86              BatFileObj* caller;             //Den batfil som kallade på denna. Om användaren gav kommandot 
     87                                              //skall den inehålla NULL
     88              char        occupied;           //1 om detta objekt används, 0 annars
     89          };    
     90          #define BatFileObj struct ST_BatFileObj
     91          */
     92          
     93          ///////////////////////////////////
     94          // Funktioner och procedurer
     95          
     96          extern void    InitializeComputer1( void );
     97          extern void    InitializePhoneAnsApp( void );
     98          extern void    MainShell( void );
     99          extern char    DecodeAndPerform(const char* cmdStr);
    100          //int     MainCommandInterper(char c);
    101          extern void    Hello( void );
    102          extern void    TestHW( void );
    103          extern void    FlashID( void );
    104          extern void    Erase( void );
    105          extern void    BackRead( void );
    106          extern void    ReadSpare( void );
    107          extern void    WF1( void );
    108          extern void    WF2( void );
    109          extern void    WF3( void );
    110          extern void    RF1( void );
    111          extern void    RF2( void );
    112          extern void    RF3( void );
    113          extern void    CreateLong( void );
    114          extern void    ReadSpare2( void );
    115          extern void    Append( void );
    116          
    117          extern void    SetupBatFile( void );
    118          extern void    ClearLabelList( void );
    119          extern void    ExecuteBatFile(const char* batFileName);
    120          extern char    InsertLabel(const char* name, long pos);
    121          extern int     FindLabel(const char *name);
    122          extern char    GotoLabel(const char* name);
    123          
    124          extern void    myStrCpy(char* dest, const char* src);
    125          extern int     myStrLen(char* str);
    126          extern void    myLong2HexStr(long v, char* str);
    127          extern void    myInt2DecStr(int v, char* str);
    128          extern void    myInt2DecStr00(char v, char* str);
    129          extern int     myStr2Int(const char* str);
    130          extern char    myStrCmpNoCase(const char* s1, const char* s2);
    131          
    132          // Nedan var ett försök till multipla bat-filer, kanske införs senare
    133          /*
    134          void    SetupBatFile( void );
    135          void    ClearLabelList( void );
    136          void    ClearLabelList(Label* list);
    137          BatFileObj*    VacantBatFileObj(FILE* fp);
    138          void    ExecuteBatFile(const char* batFileName);
    139          char    InsertLabel(const char* name, long pos);
    140          char    FindLabel(const char *name, Label* l);
    141          char    GotoLabel(const char* name);
    142          */
    143          
    144          ///////////////////////////
    145          // Globala variabler
    146          
    147          
    148          ///////////////////////////
    149          // Lokala variabler
    150          
    151          
    152          #endif
     37          #include "ErrorCodes.h"
      1          /***********************************************
      2          Fil:            $Id: ErrorCodes.h,v 1.3 2003/11/20 22:08:52 Gemensam Exp $
      3          
      4          Ändrad:         $Date: 2003/11/20 22:08:52 $
      5          
      6          Revisionshistoria:
      7                                          $Log: ErrorCodes.h,v $
      8                                          Revision 1.3  2003/11/20 22:08:52  Gemensam
      9                                          Various declarations changes.
     10                                          Still version 0200.
     11                                          
     12                                          Revision 1.2  2003/11/10 22:44:45  Gemensam
     13                                          Added header information
     14                                          
     15          
     16          
     17          ***********************************************/
     18          
     19          #ifndef _ERRORCODES_INCLUDED_
     20          #define _ERRORCODES_INCLUDED_
     21          
     22          
     23          //Felkoder
     24          
     25          //Generellt
     26          #define EM_NOERROR          0x00
     27          
     28          
     29          
     30          //Filsystem
     31          #define EM_FILEEXISTS       0x10
     32          #define EM_FILENOTEXISTS    0x11
     33          #define EM_OUTOFFILEMEMORY  0x12
     34          #define EM_TOOMANYFILES     0x13
     35          #define EM_FILEOPEN         0x14
     36          #define EM_FILENOTOPEN      0x15
     37          #define EM_FILEREADONLY     0x16
     38          #define EM_FILEWRITEONLY    0x17
     39          #define EM_WRITEFILEOPEN    0x18
     40          
     41          //Phone
     42          #define EM_TOOMANYTIMERS    0x19
     43          
     44          //BAtfiles
     45          #define EM_TOOMANYBATFILES  0x20
     46          #define EM_REDEFLABELATTEMPT    0x21
     47          #define EM_TOOMANYLABELS    0x22
     48          #define EM_NOLABEL          0x23
     49          
     50          
     51          //PhoneAns
     52          #define EM_PARAMETER_SYNTAX    0x24
     53          
     54          #endif
     38          #include "FileSystem.h"
      1          /**************************************************************************************
      2          Fil:            $Id: FileSystem.h,v 1.4 2003/11/20 22:08:53 Gemensam Exp $
      3          
      4          Ändrad:         $Date: 2003/11/20 22:08:53 $
      5          
      6          Kommentarer:    Filhuvudet befinner sig i "Spare" arean tillhörande filens första sida. Huvudet består 
      7                                          av 16 bytes enligt följande lista:
      8                                          0       Huvud       0xAA = Legalt filhuvud, annat tillsvidare odefinierat
      9                                          1-4     Fillängd    Pos 1 = MSB, pos 4 = LSB
     10                                          5-12    Filtitel    Enl "Titel.ext". Om titeln är mindre än 8 tecken avslutas det med nollor
     11                                          13-15   Filext      Enl "Titel.ext". Om ext är mindre än 3 tecken avslutas det med nollor
     12          
     13                                          En nolla skriven i fileName[0] indikerar att
     14                                          filstrukturen är ledig.
     15                  
     16          Revisionshistoria:
     17                                          $Log: FileSystem.h,v $
     18                                          Revision 1.4  2003/11/20 22:08:53  Gemensam
     19                                          Various declarations changes.
     20                                          Still version 0200.
     21                                          
     22                                          Revision 1.3  2003/11/18 19:17:36  Gemensam
     23                                          Added menu option of setting speaker volume (untested)
     24                                          Completely changed header files
     25                                          Version 0200.
     26                                          
     27                                          Revision 1.2  2003/11/10 22:44:45  Gemensam
     28                                          Added header information
     29                                          
     30          
     31          **************************************************************************************/
     32          
     33          #ifndef _FILESYSTEM_INCLUDED_
     34          #define _FILESYSTEM_INCLUDED_
     35          
     36          ///////////////////////////////////
     37          // Definitioner
     38          
     39          #define FS_MAXFILES         8 
     40          #define FS_FILENAMELENGTH   13
     41          #define FS_FLASHSIZE        0x800000
     42          
     43          #define OFF            0
     44          #define READY        1
     45          #define NEMPTY        2
     46          #define WRITING        3
     47          #define OCCUPIED    4
     48          
     49          #define CLE     P4.0                                //Command Latch Enable
     50          #define ALE     P4.1                                //Address Latch Enable
     51          #define WP      P4.2                                //Write Protect
     52          #define SE      P4.3                                //Spare Enable
     53          //#define CE      P4.4                                //Chip Enable
     54          #define FBUSY   P4.5                                //Busy
     55          
     56          #define FREG (*(unsigned char xdata *) 0xE000)
     57          #define FLASH (*(unsigned char xdata *) 0xB000) 
     58          
     59          ///////////////////////////////////
     60          // Strukturer
     61          
     62          struct ST_FILE_HEAD {
     63              unsigned long   length;
     64              char            name[FS_FILENAMELENGTH];
     65          };
     66          #define FILE_HEAD struct ST_FILE_HEAD
     67          
     68          
     69          struct ST_FILE {
     70              char            fileName[FS_FILENAMELENGTH];
     71              unsigned long   startAddress;
     72              unsigned long   length; 
     73              unsigned long   offset; 
     74              char            write;
     75              char            append;
     76          };
     77          #define FILE struct ST_FILE 
     78          
     79          
     80          
     81          ///////////////////////////////////
     82          // Funktioner och procedurer
     83          
     84          extern void            InitializeFileSystem( void );
     85          extern void            InitializeFlash( void );
     86          extern void            SetupReadSeq( void );
     87          extern unsigned char   ReadFLASH( void );
     88          extern void            TerminateReadSeq( void );
     89          extern void            GetDeviceIDRS232(void);
     90          extern void            SetupWriteSeq( void );
     91          extern void            WriteFLASH(unsigned char);
     92          extern void            TerminateWriteSeq( void );
     93          extern void            PerformWriteSeq( void );
     94          extern void            EraseBlock( void );
     95          extern void            WriteFileHead(const char* name, long size);
     96          extern FILE*           fopen(const char* name, const char* def);
     97          extern FILE*               fopenA(const char* name, long maxSize, long offset);
     98          extern void            fputc(FILE* filePtr, char c);
     99          extern void            fputLine(FILE* filePtr, const char* str);
    100          extern void            fupLoad( void );
    101          extern int             fgetc(FILE* filePtr);
    102          extern void            fgetLine(FILE* filePtr, char* str, int maxLen);
    103          extern void            fdownLoad( void );
    104          extern void            fclose(FILE* filePtr);
    105          extern long            ftell(FILE* filePtr);
    106          //void            Rewind(FILE* filePtr);
    107          extern void            fSetPos(FILE* filePtr, long offset);
    108          extern void            ReleaseCurrFile( void );
    109          extern void            EraseAll( void );
    110          extern void            StartDynamic( void );
    111          extern void            EraseDynamic( void );
    112          extern char                        MemUsage( void );
    113          extern void                        Dir( void );
    114          extern void                        Type( void );
    115          extern void                        TypeA( void );
    116          
    117          #endif
     39          #include "RS232.h"
      1          /********************************************************
      2          Fil:            $Id: RS232.h,v 1.2 2003/11/20 22:08:53 Gemensam Exp $
      3          
      4          Ändrad:         $Date: 2003/11/20 22:08:53 $
      5          
      6          Revisionshistoria:
      7                                          $Log: RS232.h,v $
      8                                          Revision 1.2  2003/11/20 22:08:53  Gemensam
      9                                          Various declarations changes.
     10                                          Still version 0200.
     11                                          
     12                                          Revision 1.1  2003/11/18 19:17:36  Gemensam
     13                                          Added menu option of setting speaker volume (untested)
     14                                          Completely changed header files
     15                                          Version 0200.
     16                                          
     17                                          
     18          
     19          ********************************************************/
     20          
     21          #ifndef _RS232_INCLUDED_
     22          #define _RS232_INCLUDED_
     23          
     24          ///////////////////////////////////
     25          // Definitioner
     26          
     27          
     28          ///////////////////////////////////
     29          // Strukturer
     30          
     31          
     32          ///////////////////////////////////
     33          // Funktioner och procedurer
     34          
     35          extern void             InitializeRS232( void );
     36          extern void             SendRS232(char tecken);
     37          extern void             SendStringRS232(const char *str);
     38          extern void             SendStringEOLRS232(const char *str);
     39          extern char             WaitAndReceiveRS232( void );
     40          extern char             WaitAndReceiveTimeout( void );
     41          extern int      ReceiveLineRS232(char* str, int maxLen);
     42          
     43          #endif
     40          
     41          
     42          
     43          //////////////////////
     44          // Globala variabler
     45          
     46          extern xdata int        error;                          //Error-kod
     47          extern xdata char       timeout;                        //Tidsmätningsvariabel
     48          extern xdata char       msg[100];
     49          extern xdata char       commandLine[CM_PARSIZE][CM_NRPAR];      //Här lagras kommandot och alla parametrar
     50                                                                                          //Varje kommando/parameter får vara max cmParSize tecken
     51                                                                                          //Till varje kommando kan cmNrPar-1 kopplas
     52          
     53          xdata long          writeAddress;               //Innehåller den address som en skriv-operation kommer att använda.
     54          xdata int           FLASHWriteState;    //Håller reda på i vilket tillstånd skriv-sekvensen befinner sig enl:
     55                                                                                          // OFF = SetupWriteSeq ej körd, skrivning ej möjlig.
     56                                                                                          // READY = SetupWriteSeq har körts, data kan läggas in i registret.
     57                                                                                          // NEMPTY = Registret innehåller data, skrivning till celler kan göras.
     58                                                                                          // WRITING = Programmeringen har startats (250 us). Inför nästa 
     59                                                                                          //           skrivning måste SetupWriteSeq köras.
     60          
     61          
     62          //////////////////////
     63          // Lokala variabler
     64          
     65          xdata FILE          fs_files[FS_MAXFILES];
     66          xdata FILE*         fs_currFilePtr;
     67          xdata char          FLASHKey;                   //Nyckel som måste innehålla 0xAA för att det skall gå att radera
     68                                                                                          //flashminnet. Denna sätts till noll av EraseBlock().         
     69          xdata int           dataFieldCounter;   //Håller reda på var i en sida man skriver. Används för att man
     70                                                                                          //skall veta när man skall utföra skrivningen vid sid-byte.
     71          xdata long          readAddress;                //Innehåller den address som en läs-operation kommer att använda.
     72          xdata long          eraseAddress;               //Det 8Kbyte-block som innehåller adressen som denna pekar på
     73                                                                                          //kommer att raderas med EraseBlock() 
     74          xdata char          writeInProgress;    //Indikerar att någon fil är öppen för skrivning, vilket skall
     75                                                                                          //hindra andra filer från att öppnas för skrivning
     76          
     77          //////////////////////
     78          // Kod
     79          
     80          void    InitializeFileSystem( void )
     81          {
   \   0000            InitializeFileSystem:
     82              xdata char    i;
     83              
     84              for (i=0 ; i<FS_MAXFILES ; i++) {
   \   0000  900000            MOV     DPTR,#$LOCBX InitializeFileSystem
   \   0003  E0                MOVX    A,@DPTR
   \   0004  7F00              MOV     R7,#0
   \   0006            ?0001:
   \   0006  EF                MOV     A,R7
   \   0007  24F8              ADD     A,#248
   \   0009  4013              JC      ?0000
   \   000B            ?0002:
     85                  fs_files[i].fileName[0] = 0;
   \   000B  EF                MOV     A,R7
   \   000C  75F01B            MOV     B,#27
   \   000F  A4                MUL     AB
   \   0010  2406              ADD     A,#LOW(fs_files)
   \   0012  F582              MOV     DPL,A
   \   0014  E4                CLR     A
   \   0015  3400              ADDC    A,#HIGH(fs_files)
   \   0017  F583              MOV     DPH,A
   \   0019  E4                CLR     A
   \   001A  F0                MOVX    @DPTR,A
   \   001B  0F                INC     R7
   \   001C  80E8              SJMP    ?0001
   \   001E            ?0000:
   \   001E  EF                MOV     A,R7
   \   001F  900000            MOV     DPTR,#$LOCBX InitializeFileSystem
   \   0022  F0                MOVX    @DPTR,A
     86              }
     87              
     88              fs_currFilePtr = NULL;
   \   0023  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0026  E4                CLR     A
   \   0027  F0                MOVX    @DPTR,A
   \   0028  A3                INC     DPTR
   \   0029  F0                MOVX    @DPTR,A
   \   002A  A3                INC     DPTR
   \   002B  F0                MOVX    @DPTR,A
     89              writeInProgress = 0;
   \   002C  9000EC            MOV     DPTR,#writeInProgress
   \   002F  F0                MOVX    @DPTR,A
     90          }
   \   0030  22                RET
     91                  
     92          
     93          
     94          void InitializeFlash( void )
     95          {
   \   0031            InitializeFlash:
     96              SE = 1;             //Endast datafälten används i en sida, inte det extra fältet (spare-field).
   \   0031  D2EB              SETB    232.3
     97                                  //Detta ger 512 bytes per sida.
     98                          
     99              CLE = 0;            //Ej i kommandoskrivningsmod
   \   0033  C2E8              CLR     232.0
    100              ALE = 0;            //Ej i addressskrivningsmod 
   \   0035  C2E9              CLR     232.1
    101          }                                                                        
   \   0037  22                RET
    102          
    103              
    104                      
    105                  
    106          
    107          /////////////////////////////////////////////////////////////////////
    108          // Läsning från FLASH-minnet
    109          
    110          void SetupReadSeq( void )
    111          //Sätter upp FLASH-minnet på adressen som finns i variabeln readAddress så att ReadFLASH() 
    112          //kan användas för att läsa en byte.
    113          {
   \   0038            SetupReadSeq:
    114              SE = 1;             //Endast datafälten används i en sida, inte det extra fältet (spare-field).
   \   0038  D2EB              SETB    232.3
    115           
    116          //    FREG = 8 + 0;
    117              FREG = ((readAddress >> 22) & 0x03) + 0x08;            //Väljer rätt FLASH-chip och sätter dess CE till 0
   \   003A  9000E4            MOV     DPTR,#readAddress
   \   003D  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0040  7816              MOV     R0,#22
   \   0042  120000            LCALL   ?SL_SHR_L01
   \   0045  EC                MOV     A,R4
   \   0046  5403              ANL     A,#3
   \   0048  2408              ADD     A,#8
   \   004A  90E000            MOV     DPTR,#57344
   \   004D  F0                MOVX    @DPTR,A
    118              ALE = 0;                                            //Sätter minnet i Kommandomod
   \   004E  C2E9              CLR     232.1
    119              CLE = 1;
   \   0050  D2E8              SETB    232.0
    120              
    121              FLASH = ((readAddress >> 8) & 1);                  //Adresserar första eller andra sidhälften med 
   \   0052  9000E6            MOV     DPTR,#readAddress+2
   \   0055  E0                MOVX    A,@DPTR
   \   0056  5401              ANL     A,#1
   \   0058  90B000            MOV     DPTR,#45056
   \   005B  F0                MOVX    @DPTR,A
    122                                                                  //kommandokod 0x00 eller 0x01, dvs kommando = bit 8 i adressen
    123              
    124              CLE = 0;                                            //Sätter minnet i adresseringsmod
   \   005C  C2E8              CLR     232.0
    125              ALE = 1;
   \   005E  D2E9              SETB    232.1
    126              
    127              FLASH = (readAddress & 0xFF);                      // A0 - A7 OBS: A8 skriven i kommandot ovan
   \   0060  9000E7            MOV     DPTR,#readAddress+3
   \   0063  E0                MOVX    A,@DPTR
   \   0064  90B000            MOV     DPTR,#45056
   \   0067  F0                MOVX    @DPTR,A
    128              FLASH = ((readAddress >> 9) & 0xFF);               // A9 - A16
   \   0068  9000E4            MOV     DPTR,#readAddress
   \   006B  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   006E  7809              MOV     R0,#9
   \   0070  120000            LCALL   ?SL_SHR_L01
   \   0073  EC                MOV     A,R4
   \   0074  90B000            MOV     DPTR,#45056
   \   0077  F0                MOVX    @DPTR,A
    129              FLASH = ((readAddress >> 17) & 0xFF);              //A17 - A21
   \   0078  9000E4            MOV     DPTR,#readAddress
   \   007B  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   007E  7811              MOV     R0,#17
   \   0080  120000            LCALL   ?SL_SHR_L01
   \   0083  EC                MOV     A,R4
   \   0084  90B000            MOV     DPTR,#45056
   \   0087  F0                MOVX    @DPTR,A
    130          
    131              ALE = 0;                                            //Sätter minnet i datamod
   \   0088  C2E9              CLR     232.1
   \   008A            ?0005:
    132              
    133           
    134          //OBS: Väntan på att FLASH-minnet skall föra över data från FLASH-arean till registerarean görs
    135          //inte här! Endast väntan tills BUSY aktiveras (går låg) görs här. Processorn kan sedan jobba 
    136          //under tiden som FLASH-minnet jobbar. Detta gör att innan varje läsning måste BUSY-flaggan kollas.
    137          
    138              while (FBUSY);                                      //Väntar tills busy går låg (max 100 ns enligt datablad)
   \   008A  30ED02            JNB     232.5,?0004
   \   008D            ?0006:
    139           
    140          }
   \   008D  80FB              SJMP    ?0005
   \   008F            ?0004:
   \   008F  22                RET
    141          
    142          void SetupSpareReadSeq( void )
    143          //Sätter upp FLASH-minnet på "spare"-arean vid adressen som finns i variabeln readAddress så att ReadFLASH() 
    144          //kan användas för att läsa en byte.
    145          {
   \   0090            SetupSpareReadSeq:
    146              SE = 0;             //Både datafälten och det extra fältet (spare-field) används.
   \   0090  C2EB              CLR     232.3
    147           
    148          //    FREG = 8 + 0;
    149              FREG = ((readAddress >> 22) & 0x03) + 0x08;            //Väljer rätt FLASH-chip och sätter dess CE till 0
   \   0092  9000E4            MOV     DPTR,#readAddress
   \   0095  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0098  7816              MOV     R0,#22
   \   009A  120000            LCALL   ?SL_SHR_L01
   \   009D  EC                MOV     A,R4
   \   009E  5403              ANL     A,#3
   \   00A0  2408              ADD     A,#8
   \   00A2  90E000            MOV     DPTR,#57344
   \   00A5  F0                MOVX    @DPTR,A
    150              ALE = 0;                                            //Sätter minnet i Kommandomod
   \   00A6  C2E9              CLR     232.1
    151              CLE = 1;
   \   00A8  D2E8              SETB    232.0
    152              
    153              FLASH = 0x50;                                       //Adresserar "spare" arean
   \   00AA  7450              MOV     A,#80
   \   00AC  90B000            MOV     DPTR,#45056
   \   00AF  F0                MOVX    @DPTR,A
    154              
    155              CLE = 0;                                            //Sätter minnet i adresseringsmod
   \   00B0  C2E8              CLR     232.0
    156              ALE = 1;
   \   00B2  D2E9              SETB    232.1
    157              
    158              FLASH = (readAddress & 0xFF);                      // A0 - A7 OBS: A8 skriven i kommandot ovan
   \   00B4  9000E7            MOV     DPTR,#readAddress+3
   \   00B7  E0                MOVX    A,@DPTR
   \   00B8  90B000            MOV     DPTR,#45056
   \   00BB  F0                MOVX    @DPTR,A
    159              FLASH = ((readAddress >> 9) & 0xFF);               // A9 - A16
   \   00BC  9000E4            MOV     DPTR,#readAddress
   \   00BF  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   00C2  7809              MOV     R0,#9
   \   00C4  120000            LCALL   ?SL_SHR_L01
   \   00C7  EC                MOV     A,R4
   \   00C8  90B000            MOV     DPTR,#45056
   \   00CB  F0                MOVX    @DPTR,A
    160              FLASH = ((readAddress >> 17) & 0xFF);              //A17 - A21
   \   00CC  9000E4            MOV     DPTR,#readAddress
   \   00CF  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   00D2  7811              MOV     R0,#17
   \   00D4  120000            LCALL   ?SL_SHR_L01
   \   00D7  EC                MOV     A,R4
   \   00D8  90B000            MOV     DPTR,#45056
   \   00DB  F0                MOVX    @DPTR,A
    161          
    162              ALE = 0;                                            //Sätter minnet i datamod
   \   00DC  C2E9              CLR     232.1
   \   00DE            ?0008:
    163              
    164           
    165          //OBS: Väntan på att FLASH-minnet skall föra över data från FLASH-arean till registerarean görs
    166          //inte här! Endast väntan tills BUSY aktiveras (går låg) görs här. Processorn kan sedan jobba 
    167          //under tiden som FLASH-minnet jobbar. Detta gör att innan varje läsning måste BUSY-flaggan kollas.
    168          
    169              while (FBUSY);                                      //Väntar tills busy går låg (max 100 ns enligt datablad)
   \   00DE  30ED02            JNB     232.5,?0007
   \   00E1            ?0009:
    170           
    171          }
   \   00E1  80FB              SJMP    ?0008
   \   00E3            ?0007:
   \   00E3  22                RET
    172          
    173          unsigned char ReadFLASH( void )
    174          //Hämtar en byte ifrån FLASH-minnet. Kan endast kallas efter att SetupReadSeq() har körts.
    175          {      
   \   00E4            ReadFLASH:
   \   00E4  900000            MOV     DPTR,#$LOCBX ReadFLASH+1
   \   00E7  D0E0              POP     ACC
   \   00E9  F0                MOVX    @DPTR,A
   \   00EA  A3                INC     DPTR
   \   00EB  D0E0              POP     ACC
   \   00ED  F0                MOVX    @DPTR,A
   \   00EE            ?0011:
    176              xdata char   c;
    177          
    178              while (!FBUSY);                                     //Väntar tills busy går hög...
   \   00EE  20ED02            JB      232.5,?0010
   \   00F1            ?0012:
   \   00F1  80FB              SJMP    ?0011
   \   00F3            ?0010:
    179              readAddress++;                                     //...(vid sidbyte max 10 us enl. datablad, annars 0)
   \   00F3  9000E4            MOV     DPTR,#readAddress
   \   00F6  E4                CLR     A
   \   00F7  FD                MOV     R5,A
   \   00F8  FE                MOV     R6,A
   \   00F9  FF                MOV     R7,A
   \   00FA  04                INC     A
   \   00FB  FC                MOV     R4,A
   \   00FC  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
    180          //    return FLASH;
    181              c = FLASH;
   \   00FF  90B000            MOV     DPTR,#45056
   \   0102  E0                MOVX    A,@DPTR
   \   0103  900000            MOV     DPTR,#$LOCBX ReadFLASH
   \   0106  F0                MOVX    @DPTR,A
    182              if ((readAddress & 0x3FFFFF) == 0) SetupReadSeq();    //Detta kommer endast att göras efter
   \   0107  9000E4            MOV     DPTR,#readAddress
   \   010A  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   010D  E4                CLR     A
   \   010E  FB                MOV     R3,A
   \   010F  7A3F              MOV     R2,#63
   \   0111  14                DEC     A
   \   0112  F8                MOV     R0,A
   \   0113  F9                MOV     R1,A
   \   0114  120000            LCALL   ?L_AND_L01
   \   0117  7003              JNZ     ?0014
   \   0119            ?0013:
   \   0119  120000            LCALL   $REFFN SetupReadSeq
   \   011C            ?0014:
    183                                                                  //att adress 0x3FFFFF har skrivits
    184              return c;
   \   011C  900000            MOV     DPTR,#$LOCBX ReadFLASH
   \   011F  E0                MOVX    A,@DPTR
   \   0120  FC                MOV     R4,A
    185          }
   \   0121  900000            MOV     DPTR,#$LOCBX ReadFLASH+1
   \   0124  E0                MOVX    A,@DPTR
   \   0125  F8                MOV     R0,A
   \   0126  A3                INC     DPTR
   \   0127  E0                MOVX    A,@DPTR
   \   0128  C0E0              PUSH    ACC
   \   012A  E8                MOV     A,R0
   \   012B  C0E0              PUSH    ACC
   \   012D  22                RET
    186          
    187          void TerminateReadSeq( void )
    188          //Avslutar en lässekvens. Efter detta måste SetupReadSeq() köras innan ReadFLASH() kan användas igen.
    189          {
   \   012E            TerminateReadSeq:
    190              FREG = 0;                                           //FLASH-minnet är inte längre valt
   \   012E  E4                CLR     A
   \   012F  90E000            MOV     DPTR,#57344
   \   0132  F0                MOVX    @DPTR,A
    191          }
   \   0133  22                RET
    192          
    193          
    194          
    195          
    196          
    197          /////////////////////////////////////////////////////////////////////
    198          // Skrivning till FLASH-minnet
    199          
    200          //Kommenarer till skrivning av minnet:
    201          //FLASH minnet har en register area och en cell area. Registerarean innehåller 512 bytes och 
    202          //består av vanliga register som alltså inte behåller informationen efter strömavslag. Cellarean
    203          //är själva FLASH-minnet (4 Mbyte). Cellarean är uppdelad i sidor (page) om 512 bytes. När man 
    204          //skriver till minnet skriver (programmerar) man en sida i taget. Först startar man skrivkommandot
    205          //och anger vilken adress man vill skriva till. Man måste inte börja på första adressen i en sida.
    206          //Sedan skriver man datat som man vill lagra till registerarean. När man är klar utför man ett kommando 
    207          //som för över data från registerarean till cellarean. När det är gjort måste man starta om skrivkommandot.
    208          //Oavsett var på sidan man börjar måste man starta överföringen när man når slutet
    209          //registerarean.
    210          //Implementationen här automatiserar detta något. En global variabel (writeAddress) innehåller den 
    211          //adress som man skall skriva till. Man kallar på SetupWriteSeq() som ställer in minnet för skrivning.
    212          //Sedan använder man WriteFLASH(byte) för att lägga in data i minnet. WriteFLASH(byte) kollar om 
    213          //man når slutet på en sida och startar då en överföring av data (register till cell) automatiskt.
    214          //WriteFLASH(byte) kollar också om en överföring håller på. Om den gör det så väntar funktionen
    215          //tills den är klar, kör SetupWriteSeq() för att starta om skrivningsförfarandet på nytt och lägger
    216          //in det önskade datat på första platsen i registerarean. Alltså behöver man inte kalla på något annat 
    217          //än SetupWriteSeq() en gång, och sedan WriteFLASH() tills man inte vill skriva något till 
    218          //minnet längre. Då kallar man på PerformWriteSeq() som startar överföringen och sedan 
    219          //TerminateWriteSeq() som avslutar skrivningen. Om man inte vill göra något annat med FLASH-minnet
    220          //kan man ha skrivsekvensen igång under hela applikationskörningen. 
    221          
    222          void SetupWriteSeq( void )
    223          //Initierar ett skrivkommando till FLASH-minnet. WriteFLASH(byte) används sedan för att skriva data till
    224          //minnet. Datat hamnar på adressen angiven i writeAddress.
    225          {
   \   0134            SetupWriteSeq:
    226              if (FLASHWriteState == OCCUPIED) {
   \   0134  900005            MOV     DPTR,#FLASHWriteState+1
   \   0137  E0                MOVX    A,@DPTR
   \   0138  6404              XRL     A,#4
   \   013A  7004              JNZ     ?0382
   \   013C  900004            MOV     DPTR,#FLASHWriteState
   \   013F  E0                MOVX    A,@DPTR
   \   0140            ?0382:
   \   0140  700C              JNZ     ?0016
   \   0142            ?0015:
    227              
    228                  error = EM_OUTOFFILEMEMORY;
   \   0142  900000            MOV     DPTR,#error
   \   0145  E4                CLR     A
   \   0146  F0                MOVX    @DPTR,A
   \   0147  A3                INC     DPTR
   \   0148  7412              MOV     A,#18
   \   014A  F0                MOVX    @DPTR,A
    229          
    230              } else {
   \   014B  0201DE            LJMP    ?0017
   \   014E            ?0016:
    231              
    232                  if (writeAddress >= FS_FLASHSIZE) {
   \   014E  900000            MOV     DPTR,#writeAddress
   \   0151  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0154  E4                CLR     A
   \   0155  F8                MOV     R0,A
   \   0156  F9                MOV     R1,A
   \   0157  FB                MOV     R3,A
   \   0158  7A80              MOV     R2,#128
   \   015A  7402              MOV     A,#2
   \   015C  120000            LCALL   ?L_CMP_L01
   \   015F  7014              JNZ     ?0019
   \   0161            ?0018:
    233                      FLASHWriteState = OCCUPIED;
   \   0161  900004            MOV     DPTR,#FLASHWriteState
   \   0164  E4                CLR     A
   \   0165  F0                MOVX    @DPTR,A
   \   0166  A3                INC     DPTR
   \   0167  7404              MOV     A,#4
   \   0169  F0                MOVX    @DPTR,A
    234                      error = EM_OUTOFFILEMEMORY;
   \   016A  900000            MOV     DPTR,#error
   \   016D  E4                CLR     A
   \   016E  F0                MOVX    @DPTR,A
   \   016F  A3                INC     DPTR
   \   0170  7412              MOV     A,#18
   \   0172  F0                MOVX    @DPTR,A
    235                  } else {
   \   0173  8069              SJMP    ?0020
   \   0175            ?0019:
    236                      SE = 1;             //Endast datafälten används i en sida, inte det extra fältet (spare-field).
   \   0175  D2EB              SETB    232.3
    237          
    238                  //    FREG = 8 + 0;
    239                      FREG = ((writeAddress >> 22) & 0x03) + 0x08;        //Väljer rätt FLASH-chip och sätter dess CE till 0
   \   0177  7816              MOV     R0,#22
   \   0179  120000            LCALL   ?SL_SHR_L01
   \   017C  EC                MOV     A,R4
   \   017D  5403              ANL     A,#3
   \   017F  2408              ADD     A,#8
   \   0181  90E000            MOV     DPTR,#57344
   \   0184  F0                MOVX    @DPTR,A
    240                      ALE = 0;                                            //Sätter minnet i Kommandomod
   \   0185  C2E9              CLR     232.1
    241                      CLE = 1;
   \   0187  D2E8              SETB    232.0
    242              
    243                      FLASH = ((writeAddress >> 8) & 1);                 //Adresserar första eller andra sidhälften med 
   \   0189  900002            MOV     DPTR,#writeAddress+2
   \   018C  E0                MOVX    A,@DPTR
   \   018D  5401              ANL     A,#1
   \   018F  90B000            MOV     DPTR,#45056
   \   0192  F0                MOVX    @DPTR,A
    244                                                                          //kommandokod 0x00 eller 0x01, 
    245                                                                          //dvs kommando = bit 8 i adressen
    246              
    247                      FLASH = 0x80;                                       //Sätter minnet i programmeringsmod
   \   0193  7480              MOV     A,#128
   \   0195  F0                MOVX    @DPTR,A
    248          
    249                      CLE = 0;                                            //Sätter minnet i adresseringsmod
   \   0196  C2E8              CLR     232.0
    250                      ALE = 1;
   \   0198  D2E9              SETB    232.1
    251              
    252                      FLASH = (writeAddress & 0xFF);                     // A0 - A7 OBS: A8 skriven i kommandot ovan
   \   019A  900003            MOV     DPTR,#writeAddress+3
   \   019D  E0                MOVX    A,@DPTR
   \   019E  90B000            MOV     DPTR,#45056
   \   01A1  F0                MOVX    @DPTR,A
    253                      FLASH = ((writeAddress >> 9) & 0xFF);              // A9 - A16
   \   01A2  900000            MOV     DPTR,#writeAddress
   \   01A5  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   01A8  7809              MOV     R0,#9
   \   01AA  120000            LCALL   ?SL_SHR_L01
   \   01AD  EC                MOV     A,R4
   \   01AE  90B000            MOV     DPTR,#45056
   \   01B1  F0                MOVX    @DPTR,A
    254                      FLASH = ((writeAddress >> 17) & 0xFF);             //A17 - A21
   \   01B2  900000            MOV     DPTR,#writeAddress
   \   01B5  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   01B8  7811              MOV     R0,#17
   \   01BA  120000            LCALL   ?SL_SHR_L01
   \   01BD  EC                MOV     A,R4
   \   01BE  90B000            MOV     DPTR,#45056
   \   01C1  F0                MOVX    @DPTR,A
    255          
    256                      ALE = 0;                                            //Sätter minnet i datamod
   \   01C2  C2E9              CLR     232.1
    257              
    258                      dataFieldCounter = (writeAddress & 0x1FF);
   \   01C4  900003            MOV     DPTR,#writeAddress+3
   \   01C7  E0                MOVX    A,@DPTR
   \   01C8  FC                MOV     R4,A
   \   01C9  900002            MOV     DPTR,#writeAddress+2
   \   01CC  E0                MOVX    A,@DPTR
   \   01CD  5401              ANL     A,#1
   \   01CF  9000E2            MOV     DPTR,#dataFieldCounter
   \   01D2  F0                MOVX    @DPTR,A
   \   01D3  A3                INC     DPTR
   \   01D4  EC                MOV     A,R4
   \   01D5  F0                MOVX    @DPTR,A
    259              
    260                      FLASHWriteState = READY;
   \   01D6  900004            MOV     DPTR,#FLASHWriteState
   \   01D9  E4                CLR     A
   \   01DA  F0                MOVX    @DPTR,A
   \   01DB  A3                INC     DPTR
   \   01DC  04                INC     A
   \   01DD  F0                MOVX    @DPTR,A
   \   01DE            ?0020:
   \   01DE            ?0017:
    261                  }
    262              }
    263          }
   \   01DE  22                RET
    264          
    265          void SetupSpareWriteSeq( void )
    266          //Initierar ett skrivkommando till FLASH-minnet. WriteFLASH(byte) används sedan för att skriva data till
    267          //minnet. Datat hamnar på adressen angiven i writeAddress.
    268          {
   \   01DF            SetupSpareWriteSeq:
    269              if (FLASHWriteState == OCCUPIED) {
   \   01DF  900005            MOV     DPTR,#FLASHWriteState+1
   \   01E2  E0                MOVX    A,@DPTR
   \   01E3  6404              XRL     A,#4
   \   01E5  7004              JNZ     ?0383
   \   01E7  900004            MOV     DPTR,#FLASHWriteState
   \   01EA  E0                MOVX    A,@DPTR
   \   01EB            ?0383:
   \   01EB  700B              JNZ     ?0022
   \   01ED            ?0021:
    270              
    271                  error = EM_OUTOFFILEMEMORY;
   \   01ED  900000            MOV     DPTR,#error
   \   01F0  E4                CLR     A
   \   01F1  F0                MOVX    @DPTR,A
   \   01F2  A3                INC     DPTR
   \   01F3  7412              MOV     A,#18
   \   01F5  F0                MOVX    @DPTR,A
    272          
    273              } else {
   \   01F6  8079              SJMP    ?0023
   \   01F8            ?0022:
    274                  if (FLASHWriteState != OCCUPIED) {
   \   01F8  900005            MOV     DPTR,#FLASHWriteState+1
   \   01FB  E0                MOVX    A,@DPTR
   \   01FC  6404              XRL     A,#4
   \   01FE  7006              JNZ     ?0384
   \   0200  900004            MOV     DPTR,#FLASHWriteState
   \   0203  E0                MOVX    A,@DPTR
   \   0204  606B              JZ      ?0025
   \   0206            ?0384:
   \   0206            ?0024:
    275                      SE = 0;             //Både datafälten och det extra fältet (spare-field) används.
   \   0206  C2EB              CLR     232.3
    276          
    277                  //    FREG = 8 + 0;
    278                      FREG = ((writeAddress >> 22) & 0x03) + 0x08;        //Väljer rätt FLASH-chip och sätter dess CE till 0
   \   0208  900000            MOV     DPTR,#writeAddress
   \   020B  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   020E  7816              MOV     R0,#22
   \   0210  120000            LCALL   ?SL_SHR_L01
   \   0213  EC                MOV     A,R4
   \   0214  5403              ANL     A,#3
   \   0216  2408              ADD     A,#8
   \   0218  90E000            MOV     DPTR,#57344
   \   021B  F0                MOVX    @DPTR,A
    279                      ALE = 0;                                            //Sätter minnet i Kommandomod
   \   021C  C2E9              CLR     232.1
    280                      CLE = 1;
   \   021E  D2E8              SETB    232.0
    281              
    282                      FLASH = 0x50;                                       //Adresserar "spare"-arean 
   \   0220  7450              MOV     A,#80
   \   0222  90B000            MOV     DPTR,#45056
   \   0225  F0                MOVX    @DPTR,A
    283              
    284                      FLASH = 0x80;                                       //Sätter minnet i programmeringsmod
   \   0226  7480              MOV     A,#128
   \   0228  F0                MOVX    @DPTR,A
    285          
    286                      CLE = 0;                                            //Sätter minnet i adresseringsmod
   \   0229  C2E8              CLR     232.0
    287                      ALE = 1;
   \   022B  D2E9              SETB    232.1
    288              
    289                      FLASH = (writeAddress & 0xFF);                     // A0 - A7 OBS: A8 skriven i kommandot ovan
   \   022D  900003            MOV     DPTR,#writeAddress+3
   \   0230  E0                MOVX    A,@DPTR
   \   0231  90B000            MOV     DPTR,#45056
   \   0234  F0                MOVX    @DPTR,A
    290                      FLASH = ((writeAddress >> 9) & 0xFF);              // A9 - A16
   \   0235  900000            MOV     DPTR,#writeAddress
   \   0238  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   023B  7809              MOV     R0,#9
   \   023D  120000            LCALL   ?SL_SHR_L01
   \   0240  EC                MOV     A,R4
   \   0241  90B000            MOV     DPTR,#45056
   \   0244  F0                MOVX    @DPTR,A
    291                      FLASH = ((writeAddress >> 17) & 0xFF);             //A17 - A21
   \   0245  900000            MOV     DPTR,#writeAddress
   \   0248  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   024B  7811              MOV     R0,#17
   \   024D  120000            LCALL   ?SL_SHR_L01
   \   0250  EC                MOV     A,R4
   \   0251  90B000            MOV     DPTR,#45056
   \   0254  F0                MOVX    @DPTR,A
    292          
    293                      ALE = 0;                                            //Sätter minnet i datamod
   \   0255  C2E9              CLR     232.1
    294              
    295                      dataFieldCounter = (writeAddress & 0x1FF);
   \   0257  900003            MOV     DPTR,#writeAddress+3
   \   025A  E0                MOVX    A,@DPTR
   \   025B  FC                MOV     R4,A
   \   025C  900002            MOV     DPTR,#writeAddress+2
   \   025F  E0                MOVX    A,@DPTR
   \   0260  5401              ANL     A,#1
   \   0262  9000E2            MOV     DPTR,#dataFieldCounter
   \   0265  F0                MOVX    @DPTR,A
   \   0266  A3                INC     DPTR
   \   0267  EC                MOV     A,R4
   \   0268  F0                MOVX    @DPTR,A
    296              
    297                      FLASHWriteState = READY;
   \   0269  900004            MOV     DPTR,#FLASHWriteState
   \   026C  E4                CLR     A
   \   026D  F0                MOVX    @DPTR,A
   \   026E  A3                INC     DPTR
   \   026F  04                INC     A
   \   0270  F0                MOVX    @DPTR,A
   \   0271            ?0025:
   \   0271            ?0023:
    298                  }
    299              }
    300          }
   \   0271  22                RET
    301          
    302          void WriteFLASH(unsigned char byte)
    303          //Skriver en byte till FLASH-minnet. Datat hamnar på addressen angiven i writeAddress. Denna ökas 
    304          //automatiskt varje gång.
    305          {                              
   \   0272            WriteFLASH:
   \   0272  900000            MOV     DPTR,#$LOCBX WriteFLASH
   \   0275  D0E0              POP     ACC
   \   0277  F0                MOVX    @DPTR,A
   \   0278  A3                INC     DPTR
   \   0279  D0E0              POP     ACC
   \   027B  F0                MOVX    @DPTR,A
    306              if (FLASHWriteState == OCCUPIED) {
   \   027C  EC                MOV     A,R4
   \   027D  A3                INC     DPTR
   \   027E  F0                MOVX    @DPTR,A
   \   027F  900005            MOV     DPTR,#FLASHWriteState+1
   \   0282  E0                MOVX    A,@DPTR
   \   0283  6404              XRL     A,#4
   \   0285  7004              JNZ     ?0385
   \   0287  900004            MOV     DPTR,#FLASHWriteState
   \   028A  E0                MOVX    A,@DPTR
   \   028B            ?0385:
   \   028B  700B              JNZ     ?0027
   \   028D            ?0026:
    307                  error = EM_OUTOFFILEMEMORY;
   \   028D  900000            MOV     DPTR,#error
   \   0290  E4                CLR     A
   \   0291  F0                MOVX    @DPTR,A
   \   0292  A3                INC     DPTR
   \   0293  7412              MOV     A,#18
   \   0295  F0                MOVX    @DPTR,A
    308              } else {
   \   0296  8052              SJMP    ?0028
   \   0298            ?0027:
    309                  if (FLASHWriteState == WRITING) {             //Programmering utförs, måste vänta tills det är klart
   \   0298  900005            MOV     DPTR,#FLASHWriteState+1
   \   029B  E0                MOVX    A,@DPTR
   \   029C  6403              XRL     A,#3
   \   029E  7004              JNZ     ?0386
   \   02A0  900004            MOV     DPTR,#FLASHWriteState
   \   02A3  E0                MOVX    A,@DPTR
   \   02A4            ?0386:
   \   02A4  7008              JNZ     ?0030
   \   02A6            ?0029:
   \   02A6            ?0032:
    310                      while (!FBUSY);
   \   02A6  20ED02            JB      232.5,?0031
   \   02A9            ?0033:
   \   02A9  80FB              SJMP    ?0032
   \   02AB            ?0031:
    311                      SetupWriteSeq();
   \   02AB  120000            LCALL   $REFFN SetupWriteSeq
   \   02AE            ?0030:
    312                  }
    313           
    314                  FLASH = byte;
   \   02AE  900000            MOV     DPTR,#$LOCBX WriteFLASH+2
   \   02B1  E0                MOVX    A,@DPTR
   \   02B2  90B000            MOV     DPTR,#45056
   \   02B5  F0                MOVX    @DPTR,A
    315                  dataFieldCounter++;
   \   02B6  9000E3            MOV     DPTR,#dataFieldCounter+1
   \   02B9  E0                MOVX    A,@DPTR
   \   02BA  04                INC     A
   \   02BB  F0                MOVX    @DPTR,A
   \   02BC  9000E2            MOV     DPTR,#dataFieldCounter
   \   02BF  7003              JNZ     ?0387
   \   02C1  E0                MOVX    A,@DPTR
   \   02C2  04                INC     A
   \   02C3  F0                MOVX    @DPTR,A
   \   02C4            ?0387:
    316                  writeAddress++;
   \   02C4  900000            MOV     DPTR,#writeAddress
   \   02C7  E4                CLR     A
   \   02C8  FD                MOV     R5,A
   \   02C9  FE                MOV     R6,A
   \   02CA  FF                MOV     R7,A
   \   02CB  04                INC     A
   \   02CC  FC                MOV     R4,A
   \   02CD  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
    317                  FLASHWriteState = NEMPTY;
   \   02D0  900004            MOV     DPTR,#FLASHWriteState
   \   02D3  E4                CLR     A
   \   02D4  F0                MOVX    @DPTR,A
   \   02D5  A3                INC     DPTR
   \   02D6  7402              MOV     A,#2
   \   02D8  F0                MOVX    @DPTR,A
    318                  
    319                  if (dataFieldCounter == 512) {
   \   02D9  9000E3            MOV     DPTR,#dataFieldCounter+1
   \   02DC  E0                MOVX    A,@DPTR
   \   02DD  7006              JNZ     ?0388
   \   02DF  9000E2            MOV     DPTR,#dataFieldCounter
   \   02E2  E0                MOVX    A,@DPTR
   \   02E3  6402              XRL     A,#2
   \   02E5            ?0388:
   \   02E5  7003              JNZ     ?0035
   \   02E7            ?0034:
    320                      PerformWriteSeq();
   \   02E7  120000            LCALL   $REFFN PerformWriteSeq
   \   02EA            ?0035:
   \   02EA            ?0028:
    321                  }
    322              }
    323          }
   \   02EA  900000            MOV     DPTR,#$LOCBX WriteFLASH
   \   02ED  E0                MOVX    A,@DPTR
   \   02EE  F8                MOV     R0,A
   \   02EF  A3                INC     DPTR
   \   02F0  E0                MOVX    A,@DPTR
   \   02F1  C0E0              PUSH    ACC
   \   02F3  E8                MOV     A,R0
   \   02F4  C0E0              PUSH    ACC
   \   02F6  22                RET
    324          
    325          void TerminateWriteSeq( void )
    326          //Avslutar en skrivsekvens. 
    327          {
   \   02F7            TerminateWriteSeq:
    328              if (FLASHWriteState == WRITING) {                 //Programmering utförs, måste vänta tills det är klart
   \   02F7  900005            MOV     DPTR,#FLASHWriteState+1
   \   02FA  E0                MOVX    A,@DPTR
   \   02FB  6403              XRL     A,#3
   \   02FD  7004              JNZ     ?0389
   \   02FF  900004            MOV     DPTR,#FLASHWriteState
   \   0302  E0                MOVX    A,@DPTR
   \   0303            ?0389:
   \   0303  7005              JNZ     ?0037
   \   0305            ?0036:
   \   0305            ?0039:
    329                  while (!FBUSY);
   \   0305  20ED02            JB      232.5,?0038
   \   0308            ?0040:
    330              }
   \   0308  80FB              SJMP    ?0039
   \   030A            ?0038:
   \   030A            ?0037:
    331          
    332          //    CE = 1;                                             //FLASH-minnet är inte längre valt
    333              FREG = 0;                                           //FLASH-minnet är inte längre valt
   \   030A  E4                CLR     A
   \   030B  90E000            MOV     DPTR,#57344
   \   030E  F0                MOVX    @DPTR,A
    334              FLASHWriteState = OFF;
   \   030F  900004            MOV     DPTR,#FLASHWriteState
   \   0312  F0                MOVX    @DPTR,A
   \   0313  A3                INC     DPTR
   \   0314  F0                MOVX    @DPTR,A
    335          }
   \   0315  22                RET
    336          
    337          
    338          void PerformWriteSeq( void )
    339          //Utför en skrivsekvens. Om det inte finns något inskrivet i registerarean så görs ingenting.
    340          {
   \   0316            PerformWriteSeq:
    341              if (FLASHWriteState == NEMPTY) {                  //Skall endast utföras om det har skrivits saker till registret
   \   0316  900005            MOV     DPTR,#FLASHWriteState+1
   \   0319  E0                MOVX    A,@DPTR
   \   031A  6402              XRL     A,#2
   \   031C  7004              JNZ     ?0390
   \   031E  900004            MOV     DPTR,#FLASHWriteState
   \   0321  E0                MOVX    A,@DPTR
   \   0322            ?0390:
   \   0322  7013              JNZ     ?0042
   \   0324            ?0041:
    342                  CLE = 1;                                        //Sätter minnet i kommandomod
   \   0324  D2E8              SETB    232.0
    343                  FLASH = 0x10;                                   //Startar programmering av FLASH-celler. Tar ca 250 us enl. datablad.
   \   0326  7410              MOV     A,#16
   \   0328  90B000            MOV     DPTR,#45056
   \   032B  F0                MOVX    @DPTR,A
    344                  FLASHWriteState = WRITING;
   \   032C  900004            MOV     DPTR,#FLASHWriteState
   \   032F  E4                CLR     A
   \   0330  F0                MOVX    @DPTR,A
   \   0331  A3                INC     DPTR
   \   0332  7403              MOV     A,#3
   \   0334  F0                MOVX    @DPTR,A
    345                  CLE = 0;                                        //Sätter minnet i datamod
   \   0335  C2E8              CLR     232.0
   \   0337            ?0042:
    346              }
    347          }
   \   0337  22                RET
    348          
    349          /////////////////////////////////////////////////////////////////////
    350          // Radering av FLASH-minnet
    351           
    352          void EraseBlock( void )
    353          {
   \   0338            EraseBlock:
    354              if (FLASHKey == 0xAA) {                             //Nyckeln måste vara satt till 0xAA för att 
   \   0338  9000E1            MOV     DPTR,#FLASHKey
   \   033B  E0                MOVX    A,@DPTR
   \   033C  B4AA5B            CJNE    A,#170,?0044
   \   033F            ?0043:
    355                                                                  //radering skall utföras
    356                  FLASHKey = 0;                                   //Nollställer nyckeln
   \   033F  E4                CLR     A
   \   0340  F0                MOVX    @DPTR,A
    357          
    358                  FREG = ((eraseAddress >> 22) & 0x03) + 0x08;        //Väljer rätt FLASH-chip och sätter dess CE till 0
   \   0341  9000E8            MOV     DPTR,#eraseAddress
   \   0344  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0347  7816              MOV     R0,#22
   \   0349  120000            LCALL   ?SL_SHR_L01
   \   034C  EC                MOV     A,R4
   \   034D  5403              ANL     A,#3
   \   034F  2408              ADD     A,#8
   \   0351  90E000            MOV     DPTR,#57344
   \   0354  F0                MOVX    @DPTR,A
    359          //        CE = 0;                                         //FLASH-minnet är valt
    360                  ALE = 0;                                        //Sätter minnet i Kommandomod
   \   0355  C2E9              CLR     232.1
    361                  CLE = 1;
   \   0357  D2E8              SETB    232.0
    362              
    363                  FLASH = 0x60;                                   //"Block erase"-kommando
   \   0359  7460              MOV     A,#96
   \   035B  90B000            MOV     DPTR,#45056
   \   035E  F0                MOVX    @DPTR,A
    364          
    365                  CLE = 0;                                        //Sätter minnet i adresseringsmod
   \   035F  C2E8              CLR     232.0
    366                  ALE = 1;
   \   0361  D2E9              SETB    232.1
    367              
    368                  FLASH = ((eraseAddress >> 9) & 0xFF);          // A9 - A16
   \   0363  9000E8            MOV     DPTR,#eraseAddress
   \   0366  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0369  7809              MOV     R0,#9
   \   036B  120000            LCALL   ?SL_SHR_L01
   \   036E  EC                MOV     A,R4
   \   036F  90B000            MOV     DPTR,#45056
   \   0372  F0                MOVX    @DPTR,A
    369                  FLASH = ((eraseAddress >> 17) & 0xFF);         //A17 - A21
   \   0373  9000E8            MOV     DPTR,#eraseAddress
   \   0376  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0379  7811              MOV     R0,#17
   \   037B  120000            LCALL   ?SL_SHR_L01
   \   037E  EC                MOV     A,R4
   \   037F  90B000            MOV     DPTR,#45056
   \   0382  F0                MOVX    @DPTR,A
    370          
    371                  ALE = 0;                                        //Sätter minnet i kommandomod
   \   0383  C2E9              CLR     232.1
    372                  CLE = 1;
   \   0385  D2E8              SETB    232.0
    373              
    374                  FLASH = 0xD0;                                   //Raderingskommando
   \   0387  74D0              MOV     A,#208
   \   0389  F0                MOVX    @DPTR,A
    375                  
    376                  CLE = 0;
   \   038A  C2E8              CLR     232.0
   \   038C            ?0046:
    377                  
    378                  while (!FBUSY) {
   \   038C  20ED06            JB      232.5,?0045
   \   038F            ?0047:
    379                      WDT = 1;
   \   038F  D2AE              SETB    IE.6
    380                      SWDT = 1;
   \   0391  D2BE              SETB    IP.6
   \   0393  80F7              SJMP    ?0046
   \   0395            ?0045:
    381                  }
    382                  FREG = 0;
   \   0395  E4                CLR     A
   \   0396  90E000            MOV     DPTR,#57344
   \   0399  F0                MOVX    @DPTR,A
   \   039A            ?0044:
    383              }
    384          }
   \   039A  22                RET
    385          
    386          /////////////////////////////////////////////////////////////////////
    387          // Övrig FLASH-minnes hantering
    388           
    389          
    390          /*
    391          void    SeekWriteEnd( void )
    392          //Letar upp den första lediga adress i FLASH-minnet. Om datorn har fått en ofrivillig reset
    393          //kan man fortsätta att skriva där man slutade.
    394          {
    395              xdata long          mask;
    396              xdata long          seek_address;
    397              xdata unsigned char empty;
    398              
    399              seek_address = 0;
    400              mask = 0x200000;
    401          
    402              do {
    403                  readAddress = (seek_address | mask);
    404                  empty = 1;                                      //Förutsätt oskrivet paket
    405                  SetupReadSeq();  
    406                  if (ReadFLASH() != 0xFF) empty = 0;
    407                  if (ReadFLASH() != 0xFF) empty = 0;
    408                  if (ReadFLASH() != 0xFF) empty = 0;
    409                  if (ReadFLASH() != 0xFF) empty = 0;
    410                  if (ReadFLASH() != 0xFF) empty = 0;
    411                  if (ReadFLASH() != 0xFF) empty = 0;
    412                  if (ReadFLASH() != 0xFF) empty = 0;
    413                  if (ReadFLASH() != 0xFF) empty = 0;
    414                  if (!empty) {
    415                      seek_address = readAddress - 8;
    416                  }
    417                  mask = mask >> 1;
    418              } while (mask > 0x4);                               //seek_address pekar på sista skrivna paketet
    419              if ((seek_address == 0) && (empty)) {
    420                   writeAddress = 0;
    421              } else {
    422                  writeAddress = seek_address + 8;               //writeAddress pekar på första lediga plats
    423              }
    424          }
    425          */
    426           
    427          char    GetFileHead(FILE_HEAD* fh)
    428          //Tittar på "spare" arean tillhörande readAddress. Om det är ett filhuvud fylls fh i och 
    429          //'1' returneras. Om det inte är ett filhuvud retuneras '0' och  fh skall ses som odefinierad.
    430          {   
   \   039B            GetFileHead:
   \   039B  900000            MOV     DPTR,#$LOCBX GetFileHead+3
   \   039E  D0E0              POP     ACC
   \   03A0  F0                MOVX    @DPTR,A
   \   03A1  A3                INC     DPTR
   \   03A2  D0E0              POP     ACC
   \   03A4  F0                MOVX    @DPTR,A
    431              xdata char    c;
    432              xdata char    i, j;
    433                            
    434              fs_currFilePtr = NULL;
   \   03A5  9000DE            MOV     DPTR,#fs_currFilePtr
   \   03A8  E4                CLR     A
   \   03A9  F0                MOVX    @DPTR,A
   \   03AA  A3                INC     DPTR
   \   03AB  F0                MOVX    @DPTR,A
   \   03AC  A3                INC     DPTR
   \   03AD  F0                MOVX    @DPTR,A
    435          
    436              SetupSpareReadSeq();
   \   03AE  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   03B1  EF                MOV     A,R7
   \   03B2  F0                MOVX    @DPTR,A
   \   03B3  A3                INC     DPTR
   \   03B4  EE                MOV     A,R6
   \   03B5  F0                MOVX    @DPTR,A
   \   03B6  A3                INC     DPTR
   \   03B7  ED                MOV     A,R5
   \   03B8  F0                MOVX    @DPTR,A
   \   03B9  120000            LCALL   $REFFN SetupSpareReadSeq
    437              if (ReadFLASH() != 0xAA) {                  //Är denna "spare"-area ett filhuvud??
   \   03BC  120000            LCALL   $REFFN ReadFLASH
   \   03BF  EC                MOV     A,R4
   \   03C0  64AA              XRL     A,#170
   \   03C2  6008              JZ      ?0049
   \   03C4            ?0048:
    438                  TerminateReadSeq();
   \   03C4  120000            LCALL   $REFFN TerminateReadSeq
    439                  return 0;
   \   03C7  7C00              MOV     R4,#0
    440              }                      
   \   03C9  020545            LJMP    ?0062
   \   03CC            ?0049:
    441              fh->length =  (ReadFLASH() * 0x1000000) & 0xFF000000;                 //Hämta length MSB
   \   03CC  120000            LCALL   $REFFN ReadFLASH
   \   03CF  E4                CLR     A
   \   03D0  FD                MOV     R5,A
   \   03D1  FE                MOV     R6,A
   \   03D2  FF                MOV     R7,A
   \   03D3  7818              MOV     R0,#24
   \   03D5  120000            LCALL   ?L_SHL_L01
   \   03D8  E4                CLR     A
   \   03D9  F8                MOV     R0,A
   \   03DA  F9                MOV     R1,A
   \   03DB  FA                MOV     R2,A
   \   03DC  14                DEC     A
   \   03DD  FB                MOV     R3,A
   \   03DE  120000            LCALL   ?L_AND_L01
   \   03E1  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   03E4  E0                MOVX    A,@DPTR
   \   03E5  FB                MOV     R3,A
   \   03E6  A3                INC     DPTR
   \   03E7  E0                MOVX    A,@DPTR
   \   03E8  FA                MOV     R2,A
   \   03E9  A3                INC     DPTR
   \   03EA  E0                MOVX    A,@DPTR
   \   03EB  F9                MOV     R1,A
   \   03EC  120000            LCALL   ?ST_R4567_R123_L17
    442              fh->length += (ReadFLASH()  * 0x10000) & 0xFF0000;
   \   03EF  120000            LCALL   $REFFN ReadFLASH
   \   03F2  E4                CLR     A
   \   03F3  FD                MOV     R5,A
   \   03F4  FE                MOV     R6,A
   \   03F5  FF                MOV     R7,A
   \   03F6  7810              MOV     R0,#16
   \   03F8  120000            LCALL   ?L_SHL_L01
   \   03FB  E4                CLR     A
   \   03FC  F8                MOV     R0,A
   \   03FD  F9                MOV     R1,A
   \   03FE  FB                MOV     R3,A
   \   03FF  14                DEC     A
   \   0400  FA                MOV     R2,A
   \   0401  120000            LCALL   ?L_AND_L01
   \   0404  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   0407  E0                MOVX    A,@DPTR
   \   0408  FB                MOV     R3,A
   \   0409  A3                INC     DPTR
   \   040A  E0                MOVX    A,@DPTR
   \   040B  FA                MOV     R2,A
   \   040C  A3                INC     DPTR
   \   040D  E0                MOVX    A,@DPTR
   \   040E  F9                MOV     R1,A
   \   040F  120000            LCALL   ?L_ADD_ASG_R123_R4567_L01
    443              fh->length += (ReadFLASH() * 0x100) & 0xFF00;
   \   0412  120000            LCALL   $REFFN ReadFLASH
   \   0415  E4                CLR     A
   \   0416  CC                XCH     A,R4
   \   0417  FD                MOV     R5,A
   \   0418  E4                CLR     A
   \   0419  FC                MOV     R4,A
   \   041A  FE                MOV     R6,A
   \   041B  FF                MOV     R7,A
   \   041C  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   041F  E0                MOVX    A,@DPTR
   \   0420  FB                MOV     R3,A
   \   0421  A3                INC     DPTR
   \   0422  E0                MOVX    A,@DPTR
   \   0423  FA                MOV     R2,A
   \   0424  A3                INC     DPTR
   \   0425  E0                MOVX    A,@DPTR
   \   0426  F9                MOV     R1,A
   \   0427  120000            LCALL   ?L_ADD_ASG_R123_R4567_L01
    444              fh->length += (ReadFLASH() & 0xFF);                          //Hämta length LSB
    445          
   \   042A  120000            LCALL   $REFFN ReadFLASH
   \   042D  E4                CLR     A
   \   042E  FD                MOV     R5,A
   \   042F  FE                MOV     R6,A
   \   0430  FF                MOV     R7,A
   \   0431  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   0434  E0                MOVX    A,@DPTR
   \   0435  FB                MOV     R3,A
   \   0436  A3                INC     DPTR
   \   0437  E0                MOVX    A,@DPTR
   \   0438  FA                MOV     R2,A
   \   0439  A3                INC     DPTR
   \   043A  E0                MOVX    A,@DPTR
   \   043B  F9                MOV     R1,A
   \   043C  120000            LCALL   ?L_ADD_ASG_R123_R4567_L01
    446              j = 0;
    447              for (i=0 ; i<8 ; i++) {
   \   043F  E4                CLR     A
   \   0440  900000            MOV     DPTR,#$LOCBX GetFileHead+2
   \   0443  F0                MOVX    @DPTR,A
   \   0444  900000            MOV     DPTR,#$LOCBX GetFileHead+1
   \   0447  F0                MOVX    @DPTR,A
   \   0448            ?0051:
   \   0448  900000            MOV     DPTR,#$LOCBX GetFileHead+1
   \   044B  E0                MOVX    A,@DPTR
   \   044C  24F8              ADD     A,#248
   \   044E  4032              JC      ?0050
   \   0450            ?0052:
    448                  c = ReadFLASH();
   \   0450  120000            LCALL   $REFFN ReadFLASH
    449                  if (c != 0) fh->name[j++] = c;
   \   0453  EC                MOV     A,R4
   \   0454  900000            MOV     DPTR,#$LOCBX GetFileHead
   \   0457  F0                MOVX    @DPTR,A
   \   0458  6020              JZ      ?0055
   \   045A            ?0054:
   \   045A  A3                INC     DPTR
   \   045B  A3                INC     DPTR
   \   045C  E0                MOVX    A,@DPTR
   \   045D  FD                MOV     R5,A
   \   045E  04                INC     A
   \   045F  F0                MOVX    @DPTR,A
   \   0460  ED                MOV     A,R5
   \   0461  7F00              MOV     R7,#0
   \   0463  FE                MOV     R6,A
   \   0464  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   0467  E0                MOVX    A,@DPTR
   \   0468  FB                MOV     R3,A
   \   0469  A3                INC     DPTR
   \   046A  E0                MOVX    A,@DPTR
   \   046B  FA                MOV     R2,A
   \   046C  A3                INC     DPTR
   \   046D  E0                MOVX    A,@DPTR
   \   046E  2E                ADD     A,R6
   \   046F  F9                MOV     R1,A
   \   0470  EA                MOV     A,R2
   \   0471  3F                ADDC    A,R7
   \   0472  FA                MOV     R2,A
   \   0473  EC                MOV     A,R4
   \   0474  900004            MOV     DPTR,#4
   \   0477  120000            LCALL   ?ST_A_R123_DISP_L17
   \   047A            ?0055:
   \   047A  900000            MOV     DPTR,#$LOCBX GetFileHead+1
   \   047D  E0                MOVX    A,@DPTR
   \   047E  04                INC     A
   \   047F  F0                MOVX    @DPTR,A
   \   0480  80C6              SJMP    ?0051
   \   0482            ?0050:
    450              }
    451              c = ReadFLASH();
   \   0482  120000            LCALL   $REFFN ReadFLASH
    452              if (c != 0) {
   \   0485  EC                MOV     A,R4
   \   0486  900000            MOV     DPTR,#$LOCBX GetFileHead
   \   0489  F0                MOVX    @DPTR,A
   \   048A  6043              JZ      ?0057
   \   048C            ?0056:
    453                  fh->name[j++] = '.';
   \   048C  A3                INC     DPTR
   \   048D  A3                INC     DPTR
   \   048E  E0                MOVX    A,@DPTR
   \   048F  FC                MOV     R4,A
   \   0490  04                INC     A
   \   0491  F0                MOVX    @DPTR,A
   \   0492  7D00              MOV     R5,#0
   \   0494  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   0497  E0                MOVX    A,@DPTR
   \   0498  FB                MOV     R3,A
   \   0499  A3                INC     DPTR
   \   049A  E0                MOVX    A,@DPTR
   \   049B  FA                MOV     R2,A
   \   049C  A3                INC     DPTR
   \   049D  E0                MOVX    A,@DPTR
   \   049E  2C                ADD     A,R4
   \   049F  F9                MOV     R1,A
   \   04A0  EA                MOV     A,R2
   \   04A1  3D                ADDC    A,R5
   \   04A2  FA                MOV     R2,A
   \   04A3  742E              MOV     A,#46
   \   04A5  900004            MOV     DPTR,#4
   \   04A8  120000            LCALL   ?ST_A_R123_DISP_L17
    454                  fh->name[j++] = c;
   \   04AB  900000            MOV     DPTR,#$LOCBX GetFileHead
   \   04AE  E0                MOVX    A,@DPTR
   \   04AF  A3                INC     DPTR
   \   04B0  A3                INC     DPTR
   \   04B1  FC                MOV     R4,A
   \   04B2  E0                MOVX    A,@DPTR
   \   04B3  FD                MOV     R5,A
   \   04B4  04                INC     A
   \   04B5  F0                MOVX    @DPTR,A
   \   04B6  ED                MOV     A,R5
   \   04B7  7F00              MOV     R7,#0
   \   04B9  FE                MOV     R6,A
   \   04BA  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   04BD  E0                MOVX    A,@DPTR
   \   04BE  A3                INC     DPTR
   \   04BF  E0                MOVX    A,@DPTR
   \   04C0  FA                MOV     R2,A
   \   04C1  A3                INC     DPTR
   \   04C2  E0                MOVX    A,@DPTR
   \   04C3  2E                ADD     A,R6
   \   04C4  F9                MOV     R1,A
   \   04C5  EA                MOV     A,R2
   \   04C6  3F                ADDC    A,R7
   \   04C7  FA                MOV     R2,A
   \   04C8  EC                MOV     A,R4
   \   04C9  900004            MOV     DPTR,#4
   \   04CC  120000            LCALL   ?ST_A_R123_DISP_L17
   \   04CF            ?0057:
    455              }
    456              c = ReadFLASH();
   \   04CF  120000            LCALL   $REFFN ReadFLASH
    457              if (c != 0) fh->name[j++] = c;
   \   04D2  EC                MOV     A,R4
   \   04D3  900000            MOV     DPTR,#$LOCBX GetFileHead
   \   04D6  F0                MOVX    @DPTR,A
   \   04D7  6020              JZ      ?0059
   \   04D9            ?0058:
   \   04D9  A3                INC     DPTR
   \   04DA  A3                INC     DPTR
   \   04DB  E0                MOVX    A,@DPTR
   \   04DC  FD                MOV     R5,A
   \   04DD  04                INC     A
   \   04DE  F0                MOVX    @DPTR,A
   \   04DF  ED                MOV     A,R5
   \   04E0  7F00              MOV     R7,#0
   \   04E2  FE                MOV     R6,A
   \   04E3  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   04E6  E0                MOVX    A,@DPTR
   \   04E7  FB                MOV     R3,A
   \   04E8  A3                INC     DPTR
   \   04E9  E0                MOVX    A,@DPTR
   \   04EA  FA                MOV     R2,A
   \   04EB  A3                INC     DPTR
   \   04EC  E0                MOVX    A,@DPTR
   \   04ED  2E                ADD     A,R6
   \   04EE  F9                MOV     R1,A
   \   04EF  EA                MOV     A,R2
   \   04F0  3F                ADDC    A,R7
   \   04F1  FA                MOV     R2,A
   \   04F2  EC                MOV     A,R4
   \   04F3  900004            MOV     DPTR,#4
   \   04F6  120000            LCALL   ?ST_A_R123_DISP_L17
   \   04F9            ?0059:
    458              c = ReadFLASH();
   \   04F9  120000            LCALL   $REFFN ReadFLASH
    459              if (c != 0) fh->name[j++] = c;
   \   04FC  EC                MOV     A,R4
   \   04FD  900000            MOV     DPTR,#$LOCBX GetFileHead
   \   0500  F0                MOVX    @DPTR,A
   \   0501  6020              JZ      ?0061
   \   0503            ?0060:
   \   0503  A3                INC     DPTR
   \   0504  A3                INC     DPTR
   \   0505  E0                MOVX    A,@DPTR
   \   0506  FD                MOV     R5,A
   \   0507  04                INC     A
   \   0508  F0                MOVX    @DPTR,A
   \   0509  ED                MOV     A,R5
   \   050A  7F00              MOV     R7,#0
   \   050C  FE                MOV     R6,A
   \   050D  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   0510  E0                MOVX    A,@DPTR
   \   0511  FB                MOV     R3,A
   \   0512  A3                INC     DPTR
   \   0513  E0                MOVX    A,@DPTR
   \   0514  FA                MOV     R2,A
   \   0515  A3                INC     DPTR
   \   0516  E0                MOVX    A,@DPTR
   \   0517  2E                ADD     A,R6
   \   0518  F9                MOV     R1,A
   \   0519  EA                MOV     A,R2
   \   051A  3F                ADDC    A,R7
   \   051B  FA                MOV     R2,A
   \   051C  EC                MOV     A,R4
   \   051D  900004            MOV     DPTR,#4
   \   0520  120000            LCALL   ?ST_A_R123_DISP_L17
   \   0523            ?0061:
    460          
    461              fh->name[j] = 0;
   \   0523  900000            MOV     DPTR,#$LOCBX GetFileHead+2
   \   0526  E0                MOVX    A,@DPTR
   \   0527  7D00              MOV     R5,#0
   \   0529  FC                MOV     R4,A
   \   052A  900000            MOV     DPTR,#$LOCBX GetFileHead+5
   \   052D  E0                MOVX    A,@DPTR
   \   052E  FB                MOV     R3,A
   \   052F  A3                INC     DPTR
   \   0530  E0                MOVX    A,@DPTR
   \   0531  FA                MOV     R2,A
   \   0532  A3                INC     DPTR
   \   0533  E0                MOVX    A,@DPTR
   \   0534  2C                ADD     A,R4
   \   0535  F9                MOV     R1,A
   \   0536  EA                MOV     A,R2
   \   0537  3D                ADDC    A,R5
   \   0538  FA                MOV     R2,A
   \   0539  ED                MOV     A,R5
   \   053A  900004            MOV     DPTR,#4
   \   053D  120000            LCALL   ?ST_A_R123_DISP_L17
    462          
    463              TerminateReadSeq();
   \   0540  120000            LCALL   $REFFN TerminateReadSeq
    464              
    465              return 1;        
   \   0543  7C01              MOV     R4,#1
    466          }
   \   0545            ?0062:
   \   0545  900000            MOV     DPTR,#$LOCBX GetFileHead+3
   \   0548  E0                MOVX    A,@DPTR
   \   0549  F8                MOV     R0,A
   \   054A  A3                INC     DPTR
   \   054B  E0                MOVX    A,@DPTR
   \   054C  C0E0              PUSH    ACC
   \   054E  E8                MOV     A,R0
   \   054F  C0E0              PUSH    ACC
   \   0551  22                RET
    467          
    468          FILE*   FindEmptyFileStruct( void )
    469          {
   \   0552            FindEmptyFileStruct:
    470              xdata char    i;
    471              
    472              for (i=0 ; i<FS_MAXFILES ; i++) {
   \   0552  E4                CLR     A
   \   0553  900000            MOV     DPTR,#$LOCBX FindEmptyFileStruct
   \   0556  F0                MOVX    @DPTR,A
   \   0557            ?0064:
   \   0557  900000            MOV     DPTR,#$LOCBX FindEmptyFileStruct
   \   055A  E0                MOVX    A,@DPTR
   \   055B  24F8              ADD     A,#248
   \   055D  402B              JC      ?0063
   \   055F            ?0065:
    473                  if (fs_files[i].fileName[0] == 0) return &(fs_files[i]);
   \   055F  E0                MOVX    A,@DPTR
   \   0560  75F01B            MOV     B,#27
   \   0563  A4                MUL     AB
   \   0564  2406              ADD     A,#LOW(fs_files)
   \   0566  F582              MOV     DPL,A
   \   0568  E4                CLR     A
   \   0569  3400              ADDC    A,#HIGH(fs_files)
   \   056B  F583              MOV     DPH,A
   \   056D  E0                MOVX    A,@DPTR
   \   056E  7012              JNZ     ?0068
   \   0570            ?0067:
   \   0570  900000            MOV     DPTR,#$LOCBX FindEmptyFileStruct
   \   0573  E0                MOVX    A,@DPTR
   \   0574  75F01B            MOV     B,#27
   \   0577  A4                MUL     AB
   \   0578  2406              ADD     A,#LOW(fs_files)
   \   057A  FD                MOV     R5,A
   \   057B  E4                CLR     A
   \   057C  3400              ADDC    A,#HIGH(fs_files)
   \   057E  FE                MOV     R6,A
   \   057F  7F01              MOV     R7,#1
    474              }
   \   0581  22                RET
   \   0582            ?0068:
   \   0582  900000            MOV     DPTR,#$LOCBX FindEmptyFileStruct
   \   0585  E0                MOVX    A,@DPTR
   \   0586  04                INC     A
   \   0587  F0                MOVX    @DPTR,A
   \   0588  80CD              SJMP    ?0064
   \   058A            ?0063:
    475              error = EM_TOOMANYFILES;
   \   058A  900000            MOV     DPTR,#error
   \   058D  E4                CLR     A
   \   058E  F0                MOVX    @DPTR,A
   \   058F  A3                INC     DPTR
   \   0590  7413              MOV     A,#19
   \   0592  F0                MOVX    @DPTR,A
    476              return NULL;
   \   0593  E4                CLR     A
   \   0594  FD                MOV     R5,A
   \   0595  FE                MOV     R6,A
   \   0596  FF                MOV     R7,A
    477          }
   \   0597            ?0069:
   \   0597  22                RET
    478          
    479          char    FileOpen(const char* name)
    480          //Retunerar 1 om filen är öppen, annars 0
    481          {
   \   0598            FileOpen:
   \   0598  900000            MOV     DPTR,#$LOCBX FileOpen+1
   \   059B  D0E0              POP     ACC
   \   059D  F0                MOVX    @DPTR,A
   \   059E  A3                INC     DPTR
   \   059F  D0E0              POP     ACC
   \   05A1  F0                MOVX    @DPTR,A
    482              xdata char    i;
    483              
    484              for (i=0 ; i<FS_MAXFILES ; i++) {
   \   05A2  E4                CLR     A
   \   05A3  900000            MOV     DPTR,#$LOCBX FileOpen
   \   05A6  F0                MOVX    @DPTR,A
   \   05A7  900000            MOV     DPTR,#$LOCBX FileOpen+3
   \   05AA  EF                MOV     A,R7
   \   05AB  F0                MOVX    @DPTR,A
   \   05AC  A3                INC     DPTR
   \   05AD  EE                MOV     A,R6
   \   05AE  F0                MOVX    @DPTR,A
   \   05AF  A3                INC     DPTR
   \   05B0  ED                MOV     A,R5
   \   05B1  F0                MOVX    @DPTR,A
   \   05B2            ?0071:
   \   05B2  900000            MOV     DPTR,#$LOCBX FileOpen
   \   05B5  E0                MOVX    A,@DPTR
   \   05B6  24F8              ADD     A,#248
   \   05B8  4039              JC      ?0070
   \   05BA            ?0072:
    485                  if (!myStrCmpNoCase(fs_files[i].fileName, name)){
   \   05BA  900000            MOV     DPTR,#$LOCBX FileOpen+3
   \   05BD  E0                MOVX    A,@DPTR
   \   05BE  FF                MOV     R7,A
   \   05BF  A3                INC     DPTR
   \   05C0  E0                MOVX    A,@DPTR
   \   05C1  FE                MOV     R6,A
   \   05C2  A3                INC     DPTR
   \   05C3  E0                MOVX    A,@DPTR
   \   05C4  FD                MOV     R5,A
   \   05C5  900000            MOV     DPTR,#$PRMBX myStrCmpNoCase+3
   \   05C8  EF                MOV     A,R7
   \   05C9  F0                MOVX    @DPTR,A
   \   05CA  A3                INC     DPTR
   \   05CB  EE                MOV     A,R6
   \   05CC  F0                MOVX    @DPTR,A
   \   05CD  A3                INC     DPTR
   \   05CE  ED                MOV     A,R5
   \   05CF  F0                MOVX    @DPTR,A
   \   05D0  900000            MOV     DPTR,#$LOCBX FileOpen
   \   05D3  E0                MOVX    A,@DPTR
   \   05D4  75F01B            MOV     B,#27
   \   05D7  A4                MUL     AB
   \   05D8  2406              ADD     A,#LOW(fs_files)
   \   05DA  FD                MOV     R5,A
   \   05DB  E4                CLR     A
   \   05DC  3400              ADDC    A,#HIGH(fs_files)
   \   05DE  FE                MOV     R6,A
   \   05DF  7F01              MOV     R7,#1
   \   05E1  120000            LCALL   $REFFN myStrCmpNoCase
   \   05E4  BC0004            CJNE    R4,#0,?0075
   \   05E7            ?0074:
    486                      return 1;
   \   05E7  7C01              MOV     R4,#1
    487                  }
   \   05E9  800A              SJMP    ?0076
   \   05EB            ?0075:
   \   05EB  900000            MOV     DPTR,#$LOCBX FileOpen
   \   05EE  E0                MOVX    A,@DPTR
   \   05EF  04                INC     A
   \   05F0  F0                MOVX    @DPTR,A
   \   05F1  80BF              SJMP    ?0071
   \   05F3            ?0070:
    488              }
    489              return 0;
   \   05F3  7C00              MOV     R4,#0
    490          }
   \   05F5            ?0076:
   \   05F5  900000            MOV     DPTR,#$LOCBX FileOpen+1
   \   05F8  E0                MOVX    A,@DPTR
   \   05F9  F8                MOV     R0,A
   \   05FA  A3                INC     DPTR
   \   05FB  E0                MOVX    A,@DPTR
   \   05FC  C0E0              PUSH    ACC
   \   05FE  E8                MOV     A,R0
   \   05FF  C0E0              PUSH    ACC
   \   0601  22                RET
    491          
    492          FILE*   fopen(const char* name, const char* def)
    493          {
   \   0602            fopen:
   \   0602  900000            MOV     DPTR,#$LOCBX fopen+21
   \   0605  D0E0              POP     ACC
   \   0607  F0                MOVX    @DPTR,A
   \   0608  A3                INC     DPTR
   \   0609  D0E0              POP     ACC
   \   060B  F0                MOVX    @DPTR,A
    494              xdata FILE*       tmpFile;
    495              xdata FILE_HEAD   fh;
    496              xdata char        done;
    497           
    498              if (FileOpen(name)) {
   \   060C  A3                INC     DPTR
   \   060D  EF                MOV     A,R7
   \   060E  F0                MOVX    @DPTR,A
   \   060F  A3                INC     DPTR
   \   0610  EE                MOV     A,R6
   \   0611  F0                MOVX    @DPTR,A
   \   0612  A3                INC     DPTR
   \   0613  ED                MOV     A,R5
   \   0614  F0                MOVX    @DPTR,A
   \   0615  120000            LCALL   $REFFN FileOpen
   \   0618  EC                MOV     A,R4
   \   0619  6010              JZ      ?0078
   \   061B            ?0077:
    499                  error = EM_FILEOPEN;
   \   061B  900000            MOV     DPTR,#error
   \   061E  E4                CLR     A
   \   061F  F0                MOVX    @DPTR,A
   \   0620  A3                INC     DPTR
   \   0621  7414              MOV     A,#20
   \   0623  F0                MOVX    @DPTR,A
    500                  return NULL;
   \   0624  E4                CLR     A
   \   0625  FD                MOV     R5,A
   \   0626  FE                MOV     R6,A
   \   0627  FF                MOV     R7,A
    501              }
   \   0628  020954            LJMP    ?0104
   \   062B            ?0078:
    502          
    503              tmpFile = FindEmptyFileStruct();
   \   062B  120000            LCALL   $REFFN FindEmptyFileStruct
    504              if (tmpFile == NULL) {
   \   062E  900000            MOV     DPTR,#$LOCBX fopen
   \   0631  EF                MOV     A,R7
   \   0632  F0                MOVX    @DPTR,A
   \   0633  A3                INC     DPTR
   \   0634  EE                MOV     A,R6
   \   0635  F0                MOVX    @DPTR,A
   \   0636  A3                INC     DPTR
   \   0637  ED                MOV     A,R5
   \   0638  F0                MOVX    @DPTR,A
   \   0639  4E                ORL     A,R6
   \   063A  7010              JNZ     ?0080
   \   063C            ?0079:
    505                  error = EM_TOOMANYFILES;
   \   063C  900000            MOV     DPTR,#error
   \   063F  E4                CLR     A
   \   0640  F0                MOVX    @DPTR,A
   \   0641  A3                INC     DPTR
   \   0642  7413              MOV     A,#19
   \   0644  F0                MOVX    @DPTR,A
    506                  return NULL;
   \   0645  E4                CLR     A
   \   0646  FD                MOV     R5,A
   \   0647  FE                MOV     R6,A
   \   0648  FF                MOV     R7,A
    507              }
   \   0649  020954            LJMP    ?0104
   \   064C            ?0080:
    508                      
    509              if (def[0] == 'r') {
   \   064C  900000            MOV     DPTR,#$LOCBX fopen+26
   \   064F  E0                MOVX    A,@DPTR
   \   0650  FF                MOV     R7,A
   \   0651  A3                INC     DPTR
   \   0652  E0                MOVX    A,@DPTR
   \   0653  FE                MOV     R6,A
   \   0654  A3                INC     DPTR
   \   0655  E0                MOVX    A,@DPTR
   \   0656  FD                MOV     R5,A
   \   0657  120000            LCALL   ?LD_A_R567_L17
   \   065A  B47202            CJNE    A,#114,$+5
   \   065D  8003              SJMP    $+5
   \   065F  0207D1            LJMP    ?0082
   \   0662            ?0081:
    510          
    511                  readAddress = 0;
   \   0662  9000E4            MOV     DPTR,#readAddress
   \   0665  E4                CLR     A
   \   0666  F0                MOVX    @DPTR,A
   \   0667  A3                INC     DPTR
   \   0668  F0                MOVX    @DPTR,A
   \   0669  A3                INC     DPTR
   \   066A  F0                MOVX    @DPTR,A
   \   066B  A3                INC     DPTR
   \   066C  F0                MOVX    @DPTR,A
    512                               
    513                  fs_currFilePtr = NULL;                                  //Antag att det blir fel nedan. Detta måste
   \   066D  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0670  F0                MOVX    @DPTR,A
   \   0671  A3                INC     DPTR
   \   0672  F0                MOVX    @DPTR,A
   \   0673  A3                INC     DPTR
   \   0674  F0                MOVX    @DPTR,A
    514                                                                          //göras eftersom FLASH-pekaren flyttats
    515                  done = 0;
   \   0675  900000            MOV     DPTR,#$LOCBX fopen+20
   \   0678  F0                MOVX    @DPTR,A
   \   0679            ?0085:
    516                   
    517                  do {
    518                      if (!GetFileHead(&fh)) {
   \   0679  7D00              MOV     R5,#LOW ($LOCBX fopen+3)
   \   067B  7E00              MOV     R6,#HIGH ($LOCBX fopen+3)
   \   067D  7F01              MOV     R7,#1
   \   067F  120000            LCALL   $REFFN GetFileHead
   \   0682  BC0010            CJNE    R4,#0,?0087
   \   0685            ?0086:
    519                          error = EM_FILENOTEXISTS;
   \   0685  900000            MOV     DPTR,#error
   \   0688  E4                CLR     A
   \   0689  F0                MOVX    @DPTR,A
   \   068A  A3                INC     DPTR
   \   068B  7411              MOV     A,#17
   \   068D  F0                MOVX    @DPTR,A
    520                          return NULL;
   \   068E  E4                CLR     A
   \   068F  FD                MOV     R5,A
   \   0690  FE                MOV     R6,A
   \   0691  FF                MOV     R7,A
    521                      }
   \   0692  020954            LJMP    ?0104
   \   0695            ?0087:
    522                      if (readAddress >= FS_FLASHSIZE) {
   \   0695  9000E4            MOV     DPTR,#readAddress
   \   0698  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   069B  E4                CLR     A
   \   069C  F8                MOV     R0,A
   \   069D  F9                MOV     R1,A
   \   069E  FB                MOV     R3,A
   \   069F  7A80              MOV     R2,#128
   \   06A1  7402              MOV     A,#2
   \   06A3  120000            LCALL   ?L_CMP_L01
   \   06A6  7010              JNZ     ?0089
   \   06A8            ?0088:
    523                          error = EM_FILENOTEXISTS;
   \   06A8  900000            MOV     DPTR,#error
   \   06AB  E4                CLR     A
   \   06AC  F0                MOVX    @DPTR,A
   \   06AD  A3                INC     DPTR
   \   06AE  7411              MOV     A,#17
   \   06B0  F0                MOVX    @DPTR,A
    524                          return NULL;
   \   06B1  E4                CLR     A
   \   06B2  FD                MOV     R5,A
   \   06B3  FE                MOV     R6,A
   \   06B4  FF                MOV     R7,A
    525                      }
   \   06B5  020954            LJMP    ?0104
   \   06B8            ?0089:
    526                      if (myStrCmpNoCase(name, fh.name)) {
   \   06B8  7401              MOV     A,#1
   \   06BA  900000            MOV     DPTR,#$PRMBX myStrCmpNoCase+3
   \   06BD  F0                MOVX    @DPTR,A
   \   06BE  A3                INC     DPTR
   \   06BF  7400              MOV     A,#HIGH ($LOCBX fopen+7)
   \   06C1  F0                MOVX    @DPTR,A
   \   06C2  A3                INC     DPTR
   \   06C3  7400              MOV     A,#LOW ($LOCBX fopen+7)
   \   06C5  F0                MOVX    @DPTR,A
   \   06C6  900000            MOV     DPTR,#$LOCBX fopen+23
   \   06C9  E0                MOVX    A,@DPTR
   \   06CA  FF                MOV     R7,A
   \   06CB  A3                INC     DPTR
   \   06CC  E0                MOVX    A,@DPTR
   \   06CD  FE                MOV     R6,A
   \   06CE  A3                INC     DPTR
   \   06CF  E0                MOVX    A,@DPTR
   \   06D0  FD                MOV     R5,A
   \   06D1  120000            LCALL   $REFFN myStrCmpNoCase
   \   06D4  EC                MOV     A,R4
   \   06D5  604E              JZ      ?0091
   \   06D7            ?0090:
    527                          readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   06D7  900000            MOV     DPTR,#$LOCBX fopen+3
   \   06DA  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   06DD  E4                CLR     A
   \   06DE  F8                MOV     R0,A
   \   06DF  74FE              MOV     A,#254
   \   06E1  F9                MOV     R1,A
   \   06E2  04                INC     A
   \   06E3  FA                MOV     R2,A
   \   06E4  FB                MOV     R3,A
   \   06E5  120000            LCALL   ?L_AND_L01
   \   06E8  E4                CLR     A
   \   06E9  F8                MOV     R0,A
   \   06EA  FA                MOV     R2,A
   \   06EB  FB                MOV     R3,A
   \   06EC  7902              MOV     R1,#2
   \   06EE  120000            LCALL   ?L_ADD_L01
   \   06F1  EF                MOV     A,R7
   \   06F2  C0E0              PUSH    ACC
   \   06F4  EE                MOV     A,R6
   \   06F5  C0E0              PUSH    ACC
   \   06F7  ED                MOV     A,R5
   \   06F8  C0E0              PUSH    ACC
   \   06FA  EC                MOV     A,R4
   \   06FB  C0E0              PUSH    ACC
   \   06FD  9000E4            MOV     DPTR,#readAddress
   \   0700  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0703  E4                CLR     A
   \   0704  F8                MOV     R0,A
   \   0705  74FE              MOV     A,#254
   \   0707  F9                MOV     R1,A
   \   0708  04                INC     A
   \   0709  FA                MOV     R2,A
   \   070A  FB                MOV     R3,A
   \   070B  120000            LCALL   ?L_AND_L01
   \   070E  D0E0              POP     ACC
   \   0710  F8                MOV     R0,A
   \   0711  D0E0              POP     ACC
   \   0713  F9                MOV     R1,A
   \   0714  D0E0              POP     ACC
   \   0716  FA                MOV     R2,A
   \   0717  D0E0              POP     ACC
   \   0719  FB                MOV     R3,A
   \   071A  120000            LCALL   ?L_ADD_L01
   \   071D  9000E4            MOV     DPTR,#readAddress
   \   0720  120000            LCALL   ?STO_R4567_DPTR_L20
    528                      } else {
   \   0723  8006              SJMP    ?0092
   \   0725            ?0091:
    529                          done = 1;
   \   0725  7401              MOV     A,#1
   \   0727  900000            MOV     DPTR,#$LOCBX fopen+20
   \   072A  F0                MOVX    @DPTR,A
   \   072B            ?0092:
    530                      }
    531                  } while (!done);
   \   072B  900000            MOV     DPTR,#$LOCBX fopen+20
   \   072E  E0                MOVX    A,@DPTR
   \   072F  7003              JNZ     $+5
   \   0731  020679            LJMP    ?0085
   \   0734            ?0083:
    532          
    533                  myStrCpy(tmpFile->fileName, name);
   \   0734  900000            MOV     DPTR,#$LOCBX fopen+23
   \   0737  E0                MOVX    A,@DPTR
   \   0738  FF                MOV     R7,A
   \   0739  A3                INC     DPTR
   \   073A  E0                MOVX    A,@DPTR
   \   073B  FE                MOV     R6,A
   \   073C  A3                INC     DPTR
   \   073D  E0                MOVX    A,@DPTR
   \   073E  FD                MOV     R5,A
   \   073F  900000            MOV     DPTR,#$PRMBX myStrCpy+3
   \   0742  EF                MOV     A,R7
   \   0743  F0                MOVX    @DPTR,A
   \   0744  A3                INC     DPTR
   \   0745  EE                MOV     A,R6
   \   0746  F0                MOVX    @DPTR,A
   \   0747  A3                INC     DPTR
   \   0748  ED                MOV     A,R5
   \   0749  F0                MOVX    @DPTR,A
   \   074A  900000            MOV     DPTR,#$LOCBX fopen
   \   074D  E0                MOVX    A,@DPTR
   \   074E  FF                MOV     R7,A
   \   074F  A3                INC     DPTR
   \   0750  E0                MOVX    A,@DPTR
   \   0751  FE                MOV     R6,A
   \   0752  A3                INC     DPTR
   \   0753  E0                MOVX    A,@DPTR
   \   0754  FD                MOV     R5,A
   \   0755  120000            LCALL   $REFFN myStrCpy
    534                  tmpFile->startAddress = readAddress & 0xFFFFFE00;
   \   0758  9000E4            MOV     DPTR,#readAddress
   \   075B  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   075E  E4                CLR     A
   \   075F  F8                MOV     R0,A
   \   0760  74FE              MOV     A,#254
   \   0762  F9                MOV     R1,A
   \   0763  04                INC     A
   \   0764  FA                MOV     R2,A
   \   0765  FB                MOV     R3,A
   \   0766  120000            LCALL   ?L_AND_L01
   \   0769  900000            MOV     DPTR,#$LOCBX fopen
   \   076C  E0                MOVX    A,@DPTR
   \   076D  FB                MOV     R3,A
   \   076E  A3                INC     DPTR
   \   076F  E0                MOVX    A,@DPTR
   \   0770  FA                MOV     R2,A
   \   0771  A3                INC     DPTR
   \   0772  E0                MOVX    A,@DPTR
   \   0773  F9                MOV     R1,A
   \   0774  90000D            MOV     DPTR,#13
   \   0777  120000            LCALL   ?ST_R4567_R123_DISP_L17
    535                  tmpFile->offset = 0;
   \   077A  E4                CLR     A
   \   077B  FC                MOV     R4,A
   \   077C  FD                MOV     R5,A
   \   077D  FE                MOV     R6,A
   \   077E  FF                MOV     R7,A
   \   077F  900015            MOV     DPTR,#21
   \   0782  120000            LCALL   ?ST_R4567_R123_DISP_L17
    536                  tmpFile->length = fh.length;
   \   0785  900000            MOV     DPTR,#$LOCBX fopen+3
   \   0788  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   078B  900011            MOV     DPTR,#17
   \   078E  120000            LCALL   ?ST_R4567_R123_DISP_L17
    537                  tmpFile->write = 0;
   \   0791  E4                CLR     A
   \   0792  900019            MOV     DPTR,#25
   \   0795  120000            LCALL   ?ST_A_R123_DISP_L17
    538                  tmpFile->append = 0;
   \   0798  90001A            MOV     DPTR,#26
   \   079B  120000            LCALL   ?ST_A_R123_DISP_L17
    539                  
    540                  readAddress = tmpFile->startAddress;
   \   079E  90000D            MOV     DPTR,#13
   \   07A1  120000            LCALL   ?LD_R4567_R123_DISP_L17
   \   07A4  9000E4            MOV     DPTR,#readAddress
   \   07A7  120000            LCALL   ?STO_R4567_DPTR_L20
    541                  SetupReadSeq();
   \   07AA  120000            LCALL   $REFFN SetupReadSeq
    542                  fs_currFilePtr = tmpFile;            
   \   07AD  900000            MOV     DPTR,#$LOCBX fopen
   \   07B0  E0                MOVX    A,@DPTR
   \   07B1  FF                MOV     R7,A
   \   07B2  A3                INC     DPTR
   \   07B3  E0                MOVX    A,@DPTR
   \   07B4  FE                MOV     R6,A
   \   07B5  A3                INC     DPTR
   \   07B6  E0                MOVX    A,@DPTR
   \   07B7  FD                MOV     R5,A
   \   07B8  9000DE            MOV     DPTR,#fs_currFilePtr
   \   07BB  EF                MOV     A,R7
   \   07BC  F0                MOVX    @DPTR,A
   \   07BD  A3                INC     DPTR
   \   07BE  EE                MOV     A,R6
   \   07BF  F0                MOVX    @DPTR,A
   \   07C0  A3                INC     DPTR
   \   07C1  ED                MOV     A,R5
   \   07C2  F0                MOVX    @DPTR,A
    543                  
    544                  return tmpFile;
   \   07C3  900000            MOV     DPTR,#$LOCBX fopen
   \   07C6  E0                MOVX    A,@DPTR
   \   07C7  FF                MOV     R7,A
   \   07C8  A3                INC     DPTR
   \   07C9  E0                MOVX    A,@DPTR
   \   07CA  FE                MOV     R6,A
   \   07CB  A3                INC     DPTR
   \   07CC  E0                MOVX    A,@DPTR
   \   07CD  FD                MOV     R5,A
   \   07CE  020954            LJMP    ?0104
   \   07D1            ?0082:
    545                  
    546              } else if (def[0] == 'w') {
   \   07D1  120000            LCALL   ?LD_A_R567_L17
   \   07D4  B47702            CJNE    A,#119,$+5
   \   07D7  8003              SJMP    $+5
   \   07D9  020950            LJMP    ?0094
   \   07DC            ?0093:
    547                  if (writeInProgress) {
   \   07DC  9000EC            MOV     DPTR,#writeInProgress
   \   07DF  E0                MOVX    A,@DPTR
   \   07E0  6010              JZ      ?0096
   \   07E2            ?0095:
    548                      error = EM_WRITEFILEOPEN;
   \   07E2  900000            MOV     DPTR,#error
   \   07E5  E4                CLR     A
   \   07E6  F0                MOVX    @DPTR,A
   \   07E7  A3                INC     DPTR
   \   07E8  7418              MOV     A,#24
   \   07EA  F0                MOVX    @DPTR,A
    549                      return NULL;
   \   07EB  E4                CLR     A
   \   07EC  FD                MOV     R5,A
   \   07ED  FE                MOV     R6,A
   \   07EE  FF                MOV     R7,A
    550                  }
   \   07EF  020954            LJMP    ?0104
   \   07F2            ?0096:
    551          
    552                  readAddress = 0;
   \   07F2  9000E4            MOV     DPTR,#readAddress
   \   07F5  E4                CLR     A
   \   07F6  F0                MOVX    @DPTR,A
   \   07F7  A3                INC     DPTR
   \   07F8  F0                MOVX    @DPTR,A
   \   07F9  A3                INC     DPTR
   \   07FA  F0                MOVX    @DPTR,A
   \   07FB  A3                INC     DPTR
   \   07FC  F0                MOVX    @DPTR,A
    553                               
    554                  fs_currFilePtr = NULL;                                  //Antag att det blir fel nedan. Detta måste
   \   07FD  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0800  F0                MOVX    @DPTR,A
   \   0801  A3                INC     DPTR
   \   0802  F0                MOVX    @DPTR,A
   \   0803  A3                INC     DPTR
   \   0804  F0                MOVX    @DPTR,A
   \   0805            ?0098:
    555                                                                          //göras eftersom FLASH-pekaren flyttats
    556          
    557                  while (GetFileHead(&fh)) {
   \   0805  7D00              MOV     R5,#LOW ($LOCBX fopen+3)
   \   0807  7E00              MOV     R6,#HIGH ($LOCBX fopen+3)
   \   0809  7F01              MOV     R7,#1
   \   080B  120000            LCALL   $REFFN GetFileHead
   \   080E  EC                MOV     A,R4
   \   080F  7003              JNZ     $+5
   \   0811  0208B2            LJMP    ?0097
   \   0814            ?0099:
    558                      readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   0814  900000            MOV     DPTR,#$LOCBX fopen+3
   \   0817  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   081A  E4                CLR     A
   \   081B  F8                MOV     R0,A
   \   081C  74FE              MOV     A,#254
   \   081E  F9                MOV     R1,A
   \   081F  04                INC     A
   \   0820  FA                MOV     R2,A
   \   0821  FB                MOV     R3,A
   \   0822  120000            LCALL   ?L_AND_L01
   \   0825  E4                CLR     A
   \   0826  F8                MOV     R0,A
   \   0827  FA                MOV     R2,A
   \   0828  FB                MOV     R3,A
   \   0829  7902              MOV     R1,#2
   \   082B  120000            LCALL   ?L_ADD_L01
   \   082E  EF                MOV     A,R7
   \   082F  C0E0              PUSH    ACC
   \   0831  EE                MOV     A,R6
   \   0832  C0E0              PUSH    ACC
   \   0834  ED                MOV     A,R5
   \   0835  C0E0              PUSH    ACC
   \   0837  EC                MOV     A,R4
   \   0838  C0E0              PUSH    ACC
   \   083A  9000E4            MOV     DPTR,#readAddress
   \   083D  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0840  E4                CLR     A
   \   0841  F8                MOV     R0,A
   \   0842  74FE              MOV     A,#254
   \   0844  F9                MOV     R1,A
   \   0845  04                INC     A
   \   0846  FA                MOV     R2,A
   \   0847  FB                MOV     R3,A
   \   0848  120000            LCALL   ?L_AND_L01
   \   084B  D0E0              POP     ACC
   \   084D  F8                MOV     R0,A
   \   084E  D0E0              POP     ACC
   \   0850  F9                MOV     R1,A
   \   0851  D0E0              POP     ACC
   \   0853  FA                MOV     R2,A
   \   0854  D0E0              POP     ACC
   \   0856  FB                MOV     R3,A
   \   0857  120000            LCALL   ?L_ADD_L01
    559                      if (readAddress >= FS_FLASHSIZE) {
   \   085A  9000E4            MOV     DPTR,#readAddress
   \   085D  120000            LCALL   ?STO_R4567_DPTR_L20
   \   0860  E4                CLR     A
   \   0861  F8                MOV     R0,A
   \   0862  F9                MOV     R1,A
   \   0863  FB                MOV     R3,A
   \   0864  7A80              MOV     R2,#128
   \   0866  7402              MOV     A,#2
   \   0868  120000            LCALL   ?L_CMP_L01
   \   086B  7010              JNZ     ?0101
   \   086D            ?0100:
    560                          error = EM_OUTOFFILEMEMORY;
   \   086D  900000            MOV     DPTR,#error
   \   0870  E4                CLR     A
   \   0871  F0                MOVX    @DPTR,A
   \   0872  A3                INC     DPTR
   \   0873  7412              MOV     A,#18
   \   0875  F0                MOVX    @DPTR,A
    561                          return NULL;
   \   0876  E4                CLR     A
   \   0877  FD                MOV     R5,A
   \   0878  FE                MOV     R6,A
   \   0879  FF                MOV     R7,A
    562                      }
   \   087A  020954            LJMP    ?0104
   \   087D            ?0101:
    563                      if (!myStrCmpNoCase(fh.name, name)) {
   \   087D  900000            MOV     DPTR,#$LOCBX fopen+23
   \   0880  E0                MOVX    A,@DPTR
   \   0881  FF                MOV     R7,A
   \   0882  A3                INC     DPTR
   \   0883  E0                MOVX    A,@DPTR
   \   0884  FE                MOV     R6,A
   \   0885  A3                INC     DPTR
   \   0886  E0                MOVX    A,@DPTR
   \   0887  FD                MOV     R5,A
   \   0888  900000            MOV     DPTR,#$PRMBX myStrCmpNoCase+3
   \   088B  EF                MOV     A,R7
   \   088C  F0                MOVX    @DPTR,A
   \   088D  A3                INC     DPTR
   \   088E  EE                MOV     A,R6
   \   088F  F0                MOVX    @DPTR,A
   \   0890  A3                INC     DPTR
   \   0891  ED                MOV     A,R5
   \   0892  F0                MOVX    @DPTR,A
   \   0893  7D00              MOV     R5,#LOW ($LOCBX fopen+7)
   \   0895  7E00              MOV     R6,#HIGH ($LOCBX fopen+7)
   \   0897  7F01              MOV     R7,#1
   \   0899  120000            LCALL   $REFFN myStrCmpNoCase
   \   089C  BC0010            CJNE    R4,#0,?0103
   \   089F            ?0102:
    564                          error = EM_FILEEXISTS;
   \   089F  900000            MOV     DPTR,#error
   \   08A2  E4                CLR     A
   \   08A3  F0                MOVX    @DPTR,A
   \   08A4  A3                INC     DPTR
   \   08A5  7410              MOV     A,#16
   \   08A7  F0                MOVX    @DPTR,A
    565                          return NULL;
   \   08A8  E4                CLR     A
   \   08A9  FD                MOV     R5,A
   \   08AA  FE                MOV     R6,A
   \   08AB  FF                MOV     R7,A
    566                      }
   \   08AC  020954            LJMP    ?0104
   \   08AF            ?0103:
   \   08AF  020805            LJMP    ?0098
   \   08B2            ?0097:
    567                  }
    568                  
    569                  myStrCpy(tmpFile->fileName, name);
   \   08B2  900000            MOV     DPTR,#$LOCBX fopen+23
   \   08B5  E0                MOVX    A,@DPTR
   \   08B6  FF                MOV     R7,A
   \   08B7  A3                INC     DPTR
   \   08B8  E0                MOVX    A,@DPTR
   \   08B9  FE                MOV     R6,A
   \   08BA  A3                INC     DPTR
   \   08BB  E0                MOVX    A,@DPTR
   \   08BC  FD                MOV     R5,A
   \   08BD  900000            MOV     DPTR,#$PRMBX myStrCpy+3
   \   08C0  EF                MOV     A,R7
   \   08C1  F0                MOVX    @DPTR,A
   \   08C2  A3                INC     DPTR
   \   08C3  EE                MOV     A,R6
   \   08C4  F0                MOVX    @DPTR,A
   \   08C5  A3                INC     DPTR
   \   08C6  ED                MOV     A,R5
   \   08C7  F0                MOVX    @DPTR,A
   \   08C8  900000            MOV     DPTR,#$LOCBX fopen
   \   08CB  E0                MOVX    A,@DPTR
   \   08CC  FF                MOV     R7,A
   \   08CD  A3                INC     DPTR
   \   08CE  E0                MOVX    A,@DPTR
   \   08CF  FE                MOV     R6,A
   \   08D0  A3                INC     DPTR
   \   08D1  E0                MOVX    A,@DPTR
   \   08D2  FD                MOV     R5,A
   \   08D3  120000            LCALL   $REFFN myStrCpy
    570                  tmpFile->startAddress = readAddress & 0xFFFFFE00;
   \   08D6  9000E4            MOV     DPTR,#readAddress
   \   08D9  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   08DC  E4                CLR     A
   \   08DD  F8                MOV     R0,A
   \   08DE  74FE              MOV     A,#254
   \   08E0  F9                MOV     R1,A
   \   08E1  04                INC     A
   \   08E2  FA                MOV     R2,A
   \   08E3  FB                MOV     R3,A
   \   08E4  120000            LCALL   ?L_AND_L01
   \   08E7  900000            MOV     DPTR,#$LOCBX fopen
   \   08EA  E0                MOVX    A,@DPTR
   \   08EB  FB                MOV     R3,A
   \   08EC  A3                INC     DPTR
   \   08ED  E0                MOVX    A,@DPTR
   \   08EE  FA                MOV     R2,A
   \   08EF  A3                INC     DPTR
   \   08F0  E0                MOVX    A,@DPTR
   \   08F1  F9                MOV     R1,A
   \   08F2  90000D            MOV     DPTR,#13
   \   08F5  120000            LCALL   ?ST_R4567_R123_DISP_L17
    571                  tmpFile->length = 0;
   \   08F8  E4                CLR     A
   \   08F9  FC                MOV     R4,A
   \   08FA  FD                MOV     R5,A
   \   08FB  FE                MOV     R6,A
   \   08FC  FF                MOV     R7,A
   \   08FD  900011            MOV     DPTR,#17
   \   0900  120000            LCALL   ?ST_R4567_R123_DISP_L17
    572                  tmpFile->offset = 0;
   \   0903  900015            MOV     DPTR,#21
   \   0906  120000            LCALL   ?ST_R4567_R123_DISP_L17
    573                  tmpFile->write = 1;
   \   0909  7401              MOV     A,#1
   \   090B  900019            MOV     DPTR,#25
   \   090E  120000            LCALL   ?ST_A_R123_DISP_L17
    574                  tmpFile->append = 0;
   \   0911  14                DEC     A
   \   0912  90001A            MOV     DPTR,#26
   \   0915  120000            LCALL   ?ST_A_R123_DISP_L17
    575          
    576                  writeAddress = tmpFile->startAddress;
   \   0918  90000D            MOV     DPTR,#13
   \   091B  120000            LCALL   ?LD_R4567_R123_DISP_L17
   \   091E  900000            MOV     DPTR,#writeAddress
   \   0921  120000            LCALL   ?STO_R4567_DPTR_L20
    577                  SetupWriteSeq();
   \   0924  120000            LCALL   $REFFN SetupWriteSeq
    578                  fs_currFilePtr = tmpFile;            
   \   0927  900000            MOV     DPTR,#$LOCBX fopen
   \   092A  E0                MOVX    A,@DPTR
   \   092B  FF                MOV     R7,A
   \   092C  A3                INC     DPTR
   \   092D  E0                MOVX    A,@DPTR
   \   092E  FE                MOV     R6,A
   \   092F  A3                INC     DPTR
   \   0930  E0                MOVX    A,@DPTR
   \   0931  FD                MOV     R5,A
   \   0932  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0935  EF                MOV     A,R7
   \   0936  F0                MOVX    @DPTR,A
   \   0937  A3                INC     DPTR
   \   0938  EE                MOV     A,R6
   \   0939  F0                MOVX    @DPTR,A
   \   093A  A3                INC     DPTR
   \   093B  ED                MOV     A,R5
   \   093C  F0                MOVX    @DPTR,A
    579                  writeInProgress = 1; 
   \   093D  7401              MOV     A,#1
   \   093F  9000EC            MOV     DPTR,#writeInProgress
   \   0942  F0                MOVX    @DPTR,A
    580                  
    581                  return tmpFile;
   \   0943  900000            MOV     DPTR,#$LOCBX fopen
   \   0946  E0                MOVX    A,@DPTR
   \   0947  FF                MOV     R7,A
   \   0948  A3                INC     DPTR
   \   0949  E0                MOVX    A,@DPTR
   \   094A  FE                MOV     R6,A
   \   094B  A3                INC     DPTR
   \   094C  E0                MOVX    A,@DPTR
   \   094D  FD                MOV     R5,A
    582              } else {
   \   094E  8004              SJMP    ?0104
   \   0950            ?0094:
    583                  //Illegal fopen call
    584              }
    585              return NULL;
   \   0950  E4                CLR     A
   \   0951  FD                MOV     R5,A
   \   0952  FE                MOV     R6,A
   \   0953  FF                MOV     R7,A
    586          }
   \   0954            ?0104:
   \   0954  900000            MOV     DPTR,#$LOCBX fopen+21
   \   0957  E0                MOVX    A,@DPTR
   \   0958  F8                MOV     R0,A
   \   0959  A3                INC     DPTR
   \   095A  E0                MOVX    A,@DPTR
   \   095B  C0E0              PUSH    ACC
   \   095D  E8                MOV     A,R0
   \   095E  C0E0              PUSH    ACC
   \   0960  22                RET
    587          
    588          void    fputc(FILE* filePtr, char c)
    589          {
   \   0961            fputc:
   \   0961  900000            MOV     DPTR,#$LOCBX fputc
   \   0964  D0E0              POP     ACC
   \   0966  F0                MOVX    @DPTR,A
   \   0967  A3                INC     DPTR
   \   0968  D0E0              POP     ACC
   \   096A  F0                MOVX    @DPTR,A
    590              if (filePtr->fileName[0] == 0) {
   \   096B  EC                MOV     A,R4
   \   096C  900000            MOV     DPTR,#$LOCBX fputc+5
   \   096F  F0                MOVX    @DPTR,A
   \   0970  900000            MOV     DPTR,#$LOCBX fputc+2
   \   0973  EF                MOV     A,R7
   \   0974  F0                MOVX    @DPTR,A
   \   0975  A3                INC     DPTR
   \   0976  EE                MOV     A,R6
   \   0977  F0                MOVX    @DPTR,A
   \   0978  A3                INC     DPTR
   \   0979  ED                MOV     A,R5
   \   097A  F0                MOVX    @DPTR,A
   \   097B  120000            LCALL   ?LD_A_R567_L17
   \   097E  700C              JNZ     ?0106
   \   0980            ?0105:
    591                  error = EM_FILENOTOPEN;
   \   0980  900000            MOV     DPTR,#error
   \   0983  E4                CLR     A
   \   0984  F0                MOVX    @DPTR,A
   \   0985  A3                INC     DPTR
   \   0986  7415              MOV     A,#21
   \   0988  F0                MOVX    @DPTR,A
   \   0989  020AB3            LJMP    ?0107
   \   098C            ?0106:
    592              } else if ((!filePtr->write) && (!filePtr->append)) {
   \   098C  900019            MOV     DPTR,#25
   \   098F  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0992  7014              JNZ     ?0109
   \   0994  90001A            MOV     DPTR,#26
   \   0997  120000            LCALL   ?LD_A_R567_DISP_L17
   \   099A  700C              JNZ     ?0109
   \   099C            ?0111:
   \   099C            ?0110:
   \   099C            ?0108:
    593                  error = EM_FILEREADONLY;
   \   099C  900000            MOV     DPTR,#error
   \   099F  E4                CLR     A
   \   09A0  F0                MOVX    @DPTR,A
   \   09A1  A3                INC     DPTR
   \   09A2  7416              MOV     A,#22
   \   09A4  F0                MOVX    @DPTR,A
    594              } else {
   \   09A5  020AB3            LJMP    ?0112
   \   09A8            ?0109:
    595                  if (fs_currFilePtr != filePtr) {
   \   09A8  9000E0            MOV     DPTR,#fs_currFilePtr+2
   \   09AB  E0                MOVX    A,@DPTR
   \   09AC  6D                XRL     A,R5
   \   09AD  7011              JNZ     ?0391
   \   09AF  9000DF            MOV     DPTR,#fs_currFilePtr+1
   \   09B2  E0                MOVX    A,@DPTR
   \   09B3  6E                XRL     A,R6
   \   09B4  700A              JNZ     ?0391
   \   09B6  9000DE            MOV     DPTR,#fs_currFilePtr
   \   09B9  E0                MOVX    A,@DPTR
   \   09BA  6F                XRL     A,R7
   \   09BB  7003              JNZ     $+5
   \   09BD  020A4B            LJMP    ?0114
   \   09C0            ?0391:
   \   09C0            ?0113:
    596          
    597                      ReleaseCurrFile();
   \   09C0  120000            LCALL   $REFFN ReleaseCurrFile
    598          
    599                      if (filePtr->write) {
   \   09C3  900000            MOV     DPTR,#$LOCBX fputc+2
   \   09C6  E0                MOVX    A,@DPTR
   \   09C7  FF                MOV     R7,A
   \   09C8  A3                INC     DPTR
   \   09C9  E0                MOVX    A,@DPTR
   \   09CA  FE                MOV     R6,A
   \   09CB  A3                INC     DPTR
   \   09CC  E0                MOVX    A,@DPTR
   \   09CD  FD                MOV     R5,A
   \   09CE  900019            MOV     DPTR,#25
   \   09D1  120000            LCALL   ?LD_A_R567_DISP_L17
   \   09D4  602F              JZ      ?0116
   \   09D6            ?0115:
    600                          writeAddress = filePtr->startAddress + filePtr->length;
   \   09D6  900011            MOV     DPTR,#17
   \   09D9  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   09DC  EB                MOV     A,R3
   \   09DD  C0E0              PUSH    ACC
   \   09DF  EA                MOV     A,R2
   \   09E0  C0E0              PUSH    ACC
   \   09E2  E9                MOV     A,R1
   \   09E3  C0E0              PUSH    ACC
   \   09E5  E8                MOV     A,R0
   \   09E6  C0E0              PUSH    ACC
   \   09E8  90000D            MOV     DPTR,#13
   \   09EB  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   09EE  D0E0              POP     ACC
   \   09F0  FC                MOV     R4,A
   \   09F1  D0E0              POP     ACC
   \   09F3  FD                MOV     R5,A
   \   09F4  D0E0              POP     ACC
   \   09F6  FE                MOV     R6,A
   \   09F7  D0E0              POP     ACC
   \   09F9  FF                MOV     R7,A
   \   09FA  120000            LCALL   ?L_ADD_L01
   \   09FD  900000            MOV     DPTR,#writeAddress
   \   0A00  120000            LCALL   ?STO_R4567_DPTR_L20
    601                      } else {
   \   0A03  802D              SJMP    ?0117
   \   0A05            ?0116:
    602                          writeAddress = filePtr->startAddress + filePtr->offset;
   \   0A05  900015            MOV     DPTR,#21
   \   0A08  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0A0B  EB                MOV     A,R3
   \   0A0C  C0E0              PUSH    ACC
   \   0A0E  EA                MOV     A,R2
   \   0A0F  C0E0              PUSH    ACC
   \   0A11  E9                MOV     A,R1
   \   0A12  C0E0              PUSH    ACC
   \   0A14  E8                MOV     A,R0
   \   0A15  C0E0              PUSH    ACC
   \   0A17  90000D            MOV     DPTR,#13
   \   0A1A  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0A1D  D0E0              POP     ACC
   \   0A1F  FC                MOV     R4,A
   \   0A20  D0E0              POP     ACC
   \   0A22  FD                MOV     R5,A
   \   0A23  D0E0              POP     ACC
   \   0A25  FE                MOV     R6,A
   \   0A26  D0E0              POP     ACC
   \   0A28  FF                MOV     R7,A
   \   0A29  120000            LCALL   ?L_ADD_L01
   \   0A2C  900000            MOV     DPTR,#writeAddress
   \   0A2F  120000            LCALL   ?STO_R4567_DPTR_L20
   \   0A32            ?0117:
    603                      }
    604                      SetupWriteSeq();
   \   0A32  120000            LCALL   $REFFN SetupWriteSeq
    605                      fs_currFilePtr = filePtr;
   \   0A35  900000            MOV     DPTR,#$LOCBX fputc+2
   \   0A38  E0                MOVX    A,@DPTR
   \   0A39  FF                MOV     R7,A
   \   0A3A  A3                INC     DPTR
   \   0A3B  E0                MOVX    A,@DPTR
   \   0A3C  FE                MOV     R6,A
   \   0A3D  A3                INC     DPTR
   \   0A3E  E0                MOVX    A,@DPTR
   \   0A3F  FD                MOV     R5,A
   \   0A40  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0A43  EF                MOV     A,R7
   \   0A44  F0                MOVX    @DPTR,A
   \   0A45  A3                INC     DPTR
   \   0A46  EE                MOV     A,R6
   \   0A47  F0                MOVX    @DPTR,A
   \   0A48  A3                INC     DPTR
   \   0A49  ED                MOV     A,R5
   \   0A4A  F0                MOVX    @DPTR,A
   \   0A4B            ?0114:
    606                      
    607                  }
    608                  if (filePtr->write) {
   \   0A4B  900000            MOV     DPTR,#$LOCBX fputc+2
   \   0A4E  E0                MOVX    A,@DPTR
   \   0A4F  FF                MOV     R7,A
   \   0A50  A3                INC     DPTR
   \   0A51  E0                MOVX    A,@DPTR
   \   0A52  FE                MOV     R6,A
   \   0A53  A3                INC     DPTR
   \   0A54  E0                MOVX    A,@DPTR
   \   0A55  FD                MOV     R5,A
   \   0A56  900019            MOV     DPTR,#25
   \   0A59  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0A5C  6016              JZ      ?0119
   \   0A5E            ?0118:
    609                      filePtr->length++;
   \   0A5E  E4                CLR     A
   \   0A5F  F9                MOV     R1,A
   \   0A60  FA                MOV     R2,A
   \   0A61  FB                MOV     R3,A
   \   0A62  04                INC     A
   \   0A63  F8                MOV     R0,A
   \   0A64  900011            MOV     DPTR,#17
   \   0A67  120000            LCALL   ?L_ADD_ASG_R567_R0123_DISP_L01
    610                      WriteFLASH(c);
    611                  } else {
   \   0A6A  900000            MOV     DPTR,#$LOCBX fputc+5
   \   0A6D  E0                MOVX    A,@DPTR
   \   0A6E  FC                MOV     R4,A
   \   0A6F  120000            LCALL   $REFFN WriteFLASH
   \   0A72  803F              SJMP    ?0120
   \   0A74            ?0119:
    612                      filePtr->offset++;
   \   0A74  E4                CLR     A
   \   0A75  F9                MOV     R1,A
   \   0A76  FA                MOV     R2,A
   \   0A77  FB                MOV     R3,A
   \   0A78  04                INC     A
   \   0A79  F8                MOV     R0,A
   \   0A7A  900015            MOV     DPTR,#21
   \   0A7D  120000            LCALL   ?L_ADD_ASG_R567_R0123_DISP_L01
    613                      if (filePtr->offset < filePtr->length) {
   \   0A80  900015            MOV     DPTR,#21
   \   0A83  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0A86  EB                MOV     A,R3
   \   0A87  C0E0              PUSH    ACC
   \   0A89  EA                MOV     A,R2
   \   0A8A  C0E0              PUSH    ACC
   \   0A8C  E9                MOV     A,R1
   \   0A8D  C0E0              PUSH    ACC
   \   0A8F  E8                MOV     A,R0
   \   0A90  C0E0              PUSH    ACC
   \   0A92  900011            MOV     DPTR,#17
   \   0A95  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0A98  D0E0              POP     ACC
   \   0A9A  FC                MOV     R4,A
   \   0A9B  D0E0              POP     ACC
   \   0A9D  FD                MOV     R5,A
   \   0A9E  D0E0              POP     ACC
   \   0AA0  FE                MOV     R6,A
   \   0AA1  D0E0              POP     ACC
   \   0AA3  FF                MOV     R7,A
   \   0AA4  740B              MOV     A,#11
   \   0AA6  120000            LCALL   ?L_CMP_L01
   \   0AA9  7008              JNZ     ?0122
   \   0AAB            ?0121:
    614                          WriteFLASH(c);
   \   0AAB  900000            MOV     DPTR,#$LOCBX fputc+5
   \   0AAE  E0                MOVX    A,@DPTR
   \   0AAF  FC                MOV     R4,A
   \   0AB0  120000            LCALL   $REFFN WriteFLASH
   \   0AB3            ?0122:
   \   0AB3            ?0120:
   \   0AB3            ?0112:
   \   0AB3            ?0107:
    615                      }
    616                  }
    617              }
    618          }
   \   0AB3  900000            MOV     DPTR,#$LOCBX fputc
   \   0AB6  E0                MOVX    A,@DPTR
   \   0AB7  F8                MOV     R0,A
   \   0AB8  A3                INC     DPTR
   \   0AB9  E0                MOVX    A,@DPTR
   \   0ABA  C0E0              PUSH    ACC
   \   0ABC  E8                MOV     A,R0
   \   0ABD  C0E0              PUSH    ACC
   \   0ABF  22                RET
    619          
    620          /*
    621          
    622          void    fputLine(FILE* filePtr, const char* str)
    623          {
    624              int     i, l;
    625                          
    626              l = myStrLen(str);
    627              for (i=0 ; i<l ; i++) {
    628                  fputc(filePtr, str[i]);
    629              }
    630              fputc(filePtr, '\r');
    631              fputc(filePtr, '\n');
    632          }
    633          
    634          */
    635          
    636          int     fgetc(FILE* filePtr)
    637          {
   \   0AC0            fgetc:
   \   0AC0  900000            MOV     DPTR,#$LOCBX fgetc
   \   0AC3  D0E0              POP     ACC
   \   0AC5  F0                MOVX    @DPTR,A
   \   0AC6  A3                INC     DPTR
   \   0AC7  D0E0              POP     ACC
   \   0AC9  F0                MOVX    @DPTR,A
    638          //    SendRS232('1');
    639           
    640              if (filePtr->fileName[0] == 0) {
   \   0ACA  A3                INC     DPTR
   \   0ACB  EF                MOV     A,R7
   \   0ACC  F0                MOVX    @DPTR,A
   \   0ACD  A3                INC     DPTR
   \   0ACE  EE                MOV     A,R6
   \   0ACF  F0                MOVX    @DPTR,A
   \   0AD0  A3                INC     DPTR
   \   0AD1  ED                MOV     A,R5
   \   0AD2  F0                MOVX    @DPTR,A
   \   0AD3  120000            LCALL   ?LD_A_R567_L17
   \   0AD6  700C              JNZ     ?0124
   \   0AD8            ?0123:
    641                  error = EM_FILENOTOPEN;
   \   0AD8  900000            MOV     DPTR,#error
   \   0ADB  E4                CLR     A
   \   0ADC  F0                MOVX    @DPTR,A
   \   0ADD  A3                INC     DPTR
   \   0ADE  7415              MOV     A,#21
   \   0AE0  F0                MOVX    @DPTR,A
   \   0AE1  020BBB            LJMP    ?0125
   \   0AE4            ?0124:
    642              } else if (filePtr->write) {
   \   0AE4  900019            MOV     DPTR,#25
   \   0AE7  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0AEA  600C              JZ      ?0127
   \   0AEC            ?0126:
    643                  error = EM_FILEWRITEONLY;
   \   0AEC  900000            MOV     DPTR,#error
   \   0AEF  E4                CLR     A
   \   0AF0  F0                MOVX    @DPTR,A
   \   0AF1  A3                INC     DPTR
   \   0AF2  7417              MOV     A,#23
   \   0AF4  F0                MOVX    @DPTR,A
    644              } else {
   \   0AF5  020BBB            LJMP    ?0128
   \   0AF8            ?0127:
    645                  if (fs_currFilePtr != filePtr) {
   \   0AF8  9000E0            MOV     DPTR,#fs_currFilePtr+2
   \   0AFB  E0                MOVX    A,@DPTR
   \   0AFC  6D                XRL     A,R5
   \   0AFD  700E              JNZ     ?0392
   \   0AFF  9000DF            MOV     DPTR,#fs_currFilePtr+1
   \   0B02  E0                MOVX    A,@DPTR
   \   0B03  6E                XRL     A,R6
   \   0B04  7007              JNZ     ?0392
   \   0B06  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0B09  E0                MOVX    A,@DPTR
   \   0B0A  6F                XRL     A,R7
   \   0B0B  6054              JZ      ?0130
   \   0B0D            ?0392:
   \   0B0D            ?0129:
    646          
    647                      ReleaseCurrFile();
   \   0B0D  120000            LCALL   $REFFN ReleaseCurrFile
    648          
    649                      readAddress = filePtr->startAddress + filePtr->offset;
   \   0B10  900000            MOV     DPTR,#$LOCBX fgetc+2
   \   0B13  E0                MOVX    A,@DPTR
   \   0B14  FF                MOV     R7,A
   \   0B15  A3                INC     DPTR
   \   0B16  E0                MOVX    A,@DPTR
   \   0B17  FE                MOV     R6,A
   \   0B18  A3                INC     DPTR
   \   0B19  E0                MOVX    A,@DPTR
   \   0B1A  FD                MOV     R5,A
   \   0B1B  900015            MOV     DPTR,#21
   \   0B1E  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0B21  EB                MOV     A,R3
   \   0B22  C0E0              PUSH    ACC
   \   0B24  EA                MOV     A,R2
   \   0B25  C0E0              PUSH    ACC
   \   0B27  E9                MOV     A,R1
   \   0B28  C0E0              PUSH    ACC
   \   0B2A  E8                MOV     A,R0
   \   0B2B  C0E0              PUSH    ACC
   \   0B2D  90000D            MOV     DPTR,#13
   \   0B30  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0B33  D0E0              POP     ACC
   \   0B35  FC                MOV     R4,A
   \   0B36  D0E0              POP     ACC
   \   0B38  FD                MOV     R5,A
   \   0B39  D0E0              POP     ACC
   \   0B3B  FE                MOV     R6,A
   \   0B3C  D0E0              POP     ACC
   \   0B3E  FF                MOV     R7,A
   \   0B3F  120000            LCALL   ?L_ADD_L01
   \   0B42  9000E4            MOV     DPTR,#readAddress
   \   0B45  120000            LCALL   ?STO_R4567_DPTR_L20
    650                      SetupReadSeq();
   \   0B48  120000            LCALL   $REFFN SetupReadSeq
    651                      fs_currFilePtr = filePtr;
   \   0B4B  900000            MOV     DPTR,#$LOCBX fgetc+2
   \   0B4E  E0                MOVX    A,@DPTR
   \   0B4F  FF                MOV     R7,A
   \   0B50  A3                INC     DPTR
   \   0B51  E0                MOVX    A,@DPTR
   \   0B52  FE                MOV     R6,A
   \   0B53  A3                INC     DPTR
   \   0B54  E0                MOVX    A,@DPTR
   \   0B55  FD                MOV     R5,A
   \   0B56  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0B59  EF                MOV     A,R7
   \   0B5A  F0                MOVX    @DPTR,A
   \   0B5B  A3                INC     DPTR
   \   0B5C  EE                MOV     A,R6
   \   0B5D  F0                MOVX    @DPTR,A
   \   0B5E  A3                INC     DPTR
   \   0B5F  ED                MOV     A,R5
   \   0B60  F0                MOVX    @DPTR,A
   \   0B61            ?0130:
    652                  }
    653          //        SendRS232('2');
    654                  if (filePtr->offset >= filePtr->length) {
   \   0B61  900000            MOV     DPTR,#$LOCBX fgetc+2
   \   0B64  E0                MOVX    A,@DPTR
   \   0B65  FF                MOV     R7,A
   \   0B66  A3                INC     DPTR
   \   0B67  E0                MOVX    A,@DPTR
   \   0B68  FE                MOV     R6,A
   \   0B69  A3                INC     DPTR
   \   0B6A  E0                MOVX    A,@DPTR
   \   0B6B  FD                MOV     R5,A
   \   0B6C  900015            MOV     DPTR,#21
   \   0B6F  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0B72  EB                MOV     A,R3
   \   0B73  C0E0              PUSH    ACC
   \   0B75  EA                MOV     A,R2
   \   0B76  C0E0              PUSH    ACC
   \   0B78  E9                MOV     A,R1
   \   0B79  C0E0              PUSH    ACC
   \   0B7B  E8                MOV     A,R0
   \   0B7C  C0E0              PUSH    ACC
   \   0B7E  900011            MOV     DPTR,#17
   \   0B81  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0B84  D0E0              POP     ACC
   \   0B86  FC                MOV     R4,A
   \   0B87  D0E0              POP     ACC
   \   0B89  FD                MOV     R5,A
   \   0B8A  D0E0              POP     ACC
   \   0B8C  FE                MOV     R6,A
   \   0B8D  D0E0              POP     ACC
   \   0B8F  FF                MOV     R7,A
   \   0B90  7403              MOV     A,#3
   \   0B92  120000            LCALL   ?L_CMP_L01
   \   0B95  7006              JNZ     ?0132
   \   0B97            ?0131:
    655                      return EOF;
   \   0B97  74FF              MOV     A,#255
   \   0B99  FC                MOV     R4,A
   \   0B9A  FD                MOV     R5,A
    656                  } else {
   \   0B9B  8022              SJMP    ?0133
   \   0B9D            ?0132:
    657          //            SendRS232('3');
    658                      filePtr->offset++;
   \   0B9D  900000            MOV     DPTR,#$LOCBX fgetc+2
   \   0BA0  E0                MOVX    A,@DPTR
   \   0BA1  FF                MOV     R7,A
   \   0BA2  A3                INC     DPTR
   \   0BA3  E0                MOVX    A,@DPTR
   \   0BA4  FE                MOV     R6,A
   \   0BA5  A3                INC     DPTR
   \   0BA6  E0                MOVX    A,@DPTR
   \   0BA7  FD                MOV     R5,A
   \   0BA8  E4                CLR     A
   \   0BA9  F9                MOV     R1,A
   \   0BAA  FA                MOV     R2,A
   \   0BAB  FB                MOV     R3,A
   \   0BAC  04                INC     A
   \   0BAD  F8                MOV     R0,A
   \   0BAE  900015            MOV     DPTR,#21
   \   0BB1  120000            LCALL   ?L_ADD_ASG_R567_R0123_DISP_L01
    659          //            SendRS232('4');
    660                      return ReadFLASH();
    661                  }
   \   0BB4  120000            LCALL   $REFFN ReadFLASH
   \   0BB7  7D00              MOV     R5,#0
   \   0BB9  8004              SJMP    ?0133
   \   0BBB            ?0128:
   \   0BBB            ?0125:
    662              }
    663              return EOF;
   \   0BBB  74FF              MOV     A,#255
   \   0BBD  FC                MOV     R4,A
   \   0BBE  FD                MOV     R5,A
    664          }
   \   0BBF            ?0133:
   \   0BBF  900000            MOV     DPTR,#$LOCBX fgetc
   \   0BC2  E0                MOVX    A,@DPTR
   \   0BC3  F8                MOV     R0,A
   \   0BC4  A3                INC     DPTR
   \   0BC5  E0                MOVX    A,@DPTR
   \   0BC6  C0E0              PUSH    ACC
   \   0BC8  E8                MOV     A,R0
   \   0BC9  C0E0              PUSH    ACC
   \   0BCB  22                RET
    665          
    666          void    fgetLine(FILE* filePtr, char* str, int maxLen)
    667          //Lägger alla tecken från filen i "str" tills antingen maxLen tecken hämtats eller
    668          //'\r'-tecknet har hämtats. "str" nolltermineras (utan '\r'-teckent) och tecknet efter
    669          //'\r'-tecknet glufsas (antas vara '\n'-tecknet. Icke synliga tecken (mindre än 32 i 
    670          //ASCII-tabellen) äts upp men lagras inte i strängen. Denna funktion är till för att läsa text.
    671          {
   \   0BCC            fgetLine:
   \   0BCC  900000            MOV     DPTR,#$LOCBX fgetLine+3
   \   0BCF  D0E0              POP     ACC
   \   0BD1  F0                MOVX    @DPTR,A
   \   0BD2  A3                INC     DPTR
   \   0BD3  D0E0              POP     ACC
   \   0BD5  F0                MOVX    @DPTR,A
    672              xdata int     i = 0;
   \   0BD6  900000            MOV     DPTR,#$LOCBX fgetLine
   \   0BD9  E4                CLR     A
   \   0BDA  F0                MOVX    @DPTR,A
   \   0BDB  A3                INC     DPTR
   \   0BDC  F0                MOVX    @DPTR,A
   \   0BDD  900000            MOV     DPTR,#$LOCBX fgetLine+5
   \   0BE0  EF                MOV     A,R7
   \   0BE1  F0                MOVX    @DPTR,A
   \   0BE2  A3                INC     DPTR
   \   0BE3  EE                MOV     A,R6
   \   0BE4  F0                MOVX    @DPTR,A
   \   0BE5  A3                INC     DPTR
   \   0BE6  ED                MOV     A,R5
   \   0BE7  F0                MOVX    @DPTR,A
   \   0BE8            ?0136:
    673              xdata char    c;
    674          
    675              do {
    676                  c = fgetc(filePtr);
   \   0BE8  900000            MOV     DPTR,#$LOCBX fgetLine+5
   \   0BEB  E0                MOVX    A,@DPTR
   \   0BEC  FF                MOV     R7,A
   \   0BED  A3                INC     DPTR
   \   0BEE  E0                MOVX    A,@DPTR
   \   0BEF  FE                MOV     R6,A
   \   0BF0  A3                INC     DPTR
   \   0BF1  E0                MOVX    A,@DPTR
   \   0BF2  FD                MOV     R5,A
   \   0BF3  120000            LCALL   $REFFN fgetc
    677                  if (c >= ' ') str[i++] = c;
   \   0BF6  EC                MOV     A,R4
   \   0BF7  900000            MOV     DPTR,#$LOCBX fgetLine+2
   \   0BFA  F0                MOVX    @DPTR,A
   \   0BFB  24E0              ADD     A,#224
   \   0BFD  5026              JNC     ?0138
   \   0BFF            ?0137:
   \   0BFF  900000            MOV     DPTR,#$LOCBX fgetLine+8
   \   0C02  E0                MOVX    A,@DPTR
   \   0C03  FF                MOV     R7,A
   \   0C04  A3                INC     DPTR
   \   0C05  E0                MOVX    A,@DPTR
   \   0C06  FE                MOV     R6,A
   \   0C07  A3                INC     DPTR
   \   0C08  E0                MOVX    A,@DPTR
   \   0C09  FD                MOV     R5,A
   \   0C0A  900000            MOV     DPTR,#$LOCBX fgetLine
   \   0C0D  E0                MOVX    A,@DPTR
   \   0C0E  FB                MOV     R3,A
   \   0C0F  A3                INC     DPTR
   \   0C10  E0                MOVX    A,@DPTR
   \   0C11  FA                MOV     R2,A
   \   0C12  E0                MOVX    A,@DPTR
   \   0C13  04                INC     A
   \   0C14  F0                MOVX    @DPTR,A
   \   0C15  900000            MOV     DPTR,#$LOCBX fgetLine
   \   0C18  7003              JNZ     ?0393
   \   0C1A  E0                MOVX    A,@DPTR
   \   0C1B  04                INC     A
   \   0C1C  F0                MOVX    @DPTR,A
   \   0C1D            ?0393:
   \   0C1D  8A82              MOV     DPL,R2
   \   0C1F  8B83              MOV     DPH,R3
   \   0C21  EC                MOV     A,R4
   \   0C22  120000            LCALL   ?ST_A_R567_DISP_L17
   \   0C25            ?0138:
    678                  
    679              } while ((i < maxLen) && (c != '\r'));
   \   0C25  900000            MOV     DPTR,#$LOCBX fgetLine
   \   0C28  E0                MOVX    A,@DPTR
   \   0C29  FD                MOV     R5,A
   \   0C2A  A3                INC     DPTR
   \   0C2B  E0                MOVX    A,@DPTR
   \   0C2C  FC                MOV     R4,A
   \   0C2D  900000            MOV     DPTR,#$LOCBX fgetLine+12
   \   0C30  E0                MOVX    A,@DPTR
   \   0C31  D3                SETB    C
   \   0C32  9C                SUBB    A,R4
   \   0C33  900000            MOV     DPTR,#$LOCBX fgetLine+11
   \   0C36  E0                MOVX    A,@DPTR
   \   0C37  6480              XRL     A,#128
   \   0C39  CD                XCH     A,R5
   \   0C3A  6480              XRL     A,#128
   \   0C3C  CD                XCH     A,R5
   \   0C3D  9D                SUBB    A,R5
   \   0C3E  4007              JC      ?0134
   \   0C40  900000            MOV     DPTR,#$LOCBX fgetLine+2
   \   0C43  E0                MOVX    A,@DPTR
   \   0C44  B40DA1            CJNE    A,#13,?0136
   \   0C47            ?0134:
    680              if (c == '\r') c = fgetc(filePtr);              //Glufsa det förmodade '\n'-tecknet
   \   0C47  900000            MOV     DPTR,#$LOCBX fgetLine+2
   \   0C4A  E0                MOVX    A,@DPTR
   \   0C4B  B40D13            CJNE    A,#13,?0142
   \   0C4E            ?0141:
   \   0C4E  900000            MOV     DPTR,#$LOCBX fgetLine+5
   \   0C51  E0                MOVX    A,@DPTR
   \   0C52  FF                MOV     R7,A
   \   0C53  A3                INC     DPTR
   \   0C54  E0                MOVX    A,@DPTR
   \   0C55  FE                MOV     R6,A
   \   0C56  A3                INC     DPTR
   \   0C57  E0                MOVX    A,@DPTR
   \   0C58  FD                MOV     R5,A
   \   0C59  120000            LCALL   $REFFN fgetc
   \   0C5C  EC                MOV     A,R4
   \   0C5D  900000            MOV     DPTR,#$LOCBX fgetLine+2
   \   0C60  F0                MOVX    @DPTR,A
   \   0C61            ?0142:
    681              str[i] = 0;
   \   0C61  900000            MOV     DPTR,#$LOCBX fgetLine+8
   \   0C64  E0                MOVX    A,@DPTR
   \   0C65  FF                MOV     R7,A
   \   0C66  A3                INC     DPTR
   \   0C67  E0                MOVX    A,@DPTR
   \   0C68  FE                MOV     R6,A
   \   0C69  A3                INC     DPTR
   \   0C6A  E0                MOVX    A,@DPTR
   \   0C6B  FD                MOV     R5,A
   \   0C6C  900000            MOV     DPTR,#$LOCBX fgetLine
   \   0C6F  E0                MOVX    A,@DPTR
   \   0C70  FC                MOV     R4,A
   \   0C71  A3                INC     DPTR
   \   0C72  E0                MOVX    A,@DPTR
   \   0C73  F582              MOV     DPL,A
   \   0C75  8C83              MOV     DPH,R4
   \   0C77  E4                CLR     A
   \   0C78  120000            LCALL   ?ST_A_R567_DISP_L17
    682          }
   \   0C7B  900000            MOV     DPTR,#$LOCBX fgetLine+3
   \   0C7E  E0                MOVX    A,@DPTR
   \   0C7F  F8                MOV     R0,A
   \   0C80  A3                INC     DPTR
   \   0C81  E0                MOVX    A,@DPTR
   \   0C82  C0E0              PUSH    ACC
   \   0C84  E8                MOV     A,R0
   \   0C85  C0E0              PUSH    ACC
   \   0C87  22                RET
    683          
    684          void    ReleaseCurrFile( void )
    685          {
   \   0C88            ReleaseCurrFile:
   \   0C88  900000            MOV     DPTR,#$LOCBX ReleaseCurrFile
   \   0C8B  D0E0              POP     ACC
   \   0C8D  F0                MOVX    @DPTR,A
   \   0C8E  A3                INC     DPTR
   \   0C8F  D0E0              POP     ACC
   \   0C91  F0                MOVX    @DPTR,A
    686              if (fs_currFilePtr->write) {
   \   0C92  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0C95  E0                MOVX    A,@DPTR
   \   0C96  FF                MOV     R7,A
   \   0C97  A3                INC     DPTR
   \   0C98  E0                MOVX    A,@DPTR
   \   0C99  FE                MOV     R6,A
   \   0C9A  A3                INC     DPTR
   \   0C9B  E0                MOVX    A,@DPTR
   \   0C9C  FD                MOV     R5,A
   \   0C9D  900019            MOV     DPTR,#25
   \   0CA0  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0CA3  6012              JZ      ?0144
   \   0CA5            ?0143:
    687                  if (FLASHWriteState != OFF) {
   \   0CA5  900004            MOV     DPTR,#FLASHWriteState
   \   0CA8  E0                MOVX    A,@DPTR
   \   0CA9  FD                MOV     R5,A
   \   0CAA  A3                INC     DPTR
   \   0CAB  E0                MOVX    A,@DPTR
   \   0CAC  4D                ORL     A,R5
   \   0CAD  6006              JZ      ?0146
   \   0CAF            ?0145:
    688                      PerformWriteSeq();
   \   0CAF  120000            LCALL   $REFFN PerformWriteSeq
    689                      TerminateWriteSeq();
   \   0CB2  120000            LCALL   $REFFN TerminateWriteSeq
   \   0CB5            ?0146:
    690                  }
    691              } else {
   \   0CB5  8003              SJMP    ?0147
   \   0CB7            ?0144:
    692                  TerminateReadSeq();
   \   0CB7  120000            LCALL   $REFFN TerminateReadSeq
   \   0CBA            ?0147:
    693              }
    694              fs_currFilePtr = NULL;
   \   0CBA  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0CBD  E4                CLR     A
   \   0CBE  F0                MOVX    @DPTR,A
   \   0CBF  A3                INC     DPTR
   \   0CC0  F0                MOVX    @DPTR,A
   \   0CC1  A3                INC     DPTR
   \   0CC2  F0                MOVX    @DPTR,A
    695          }
   \   0CC3  900000            MOV     DPTR,#$LOCBX ReleaseCurrFile
   \   0CC6  E0                MOVX    A,@DPTR
   \   0CC7  F8                MOV     R0,A
   \   0CC8  A3                INC     DPTR
   \   0CC9  E0                MOVX    A,@DPTR
   \   0CCA  C0E0              PUSH    ACC
   \   0CCC  E8                MOV     A,R0
   \   0CCD  C0E0              PUSH    ACC
   \   0CCF  22                RET
    696          
    697          void    fclose(FILE* filePtr)
    698          {               
   \   0CD0            fclose:
   \   0CD0  900000            MOV     DPTR,#$LOCBX fclose
   \   0CD3  D0E0              POP     ACC
   \   0CD5  F0                MOVX    @DPTR,A
   \   0CD6  A3                INC     DPTR
   \   0CD7  D0E0              POP     ACC
   \   0CD9  F0                MOVX    @DPTR,A
    699              if (filePtr->fileName[0] == 0) {
   \   0CDA  A3                INC     DPTR
   \   0CDB  EF                MOV     A,R7
   \   0CDC  F0                MOVX    @DPTR,A
   \   0CDD  A3                INC     DPTR
   \   0CDE  EE                MOV     A,R6
   \   0CDF  F0                MOVX    @DPTR,A
   \   0CE0  A3                INC     DPTR
   \   0CE1  ED                MOV     A,R5
   \   0CE2  F0                MOVX    @DPTR,A
   \   0CE3  120000            LCALL   ?LD_A_R567_L17
   \   0CE6  700C              JNZ     ?0149
   \   0CE8            ?0148:
    700                  error = EM_FILENOTOPEN;
   \   0CE8  900000            MOV     DPTR,#error
   \   0CEB  E4                CLR     A
   \   0CEC  F0                MOVX    @DPTR,A
   \   0CED  A3                INC     DPTR
   \   0CEE  7415              MOV     A,#21
   \   0CF0  F0                MOVX    @DPTR,A
    701              } else {
   \   0CF1  020D79            LJMP    ?0150
   \   0CF4            ?0149:
    702                  if (fs_currFilePtr == filePtr) {
   \   0CF4  9000E0            MOV     DPTR,#fs_currFilePtr+2
   \   0CF7  E0                MOVX    A,@DPTR
   \   0CF8  6D                XRL     A,R5
   \   0CF9  700C              JNZ     ?0394
   \   0CFB  9000DF            MOV     DPTR,#fs_currFilePtr+1
   \   0CFE  E0                MOVX    A,@DPTR
   \   0CFF  6E                XRL     A,R6
   \   0D00  7005              JNZ     ?0394
   \   0D02  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0D05  E0                MOVX    A,@DPTR
   \   0D06  6F                XRL     A,R7
   \   0D07            ?0394:
   \   0D07  7061              JNZ     ?0152
   \   0D09            ?0151:
    703                      if ((filePtr->write) || (filePtr->append)) {
   \   0D09  900019            MOV     DPTR,#25
   \   0D0C  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0D0F  7008              JNZ     ?0153
   \   0D11  90001A            MOV     DPTR,#26
   \   0D14  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0D17  6045              JZ      ?0154
   \   0D19            ?0155:
   \   0D19            ?0156:
   \   0D19            ?0153:
    704                          if (FLASHWriteState != OFF) {
   \   0D19  900004            MOV     DPTR,#FLASHWriteState
   \   0D1C  E0                MOVX    A,@DPTR
   \   0D1D  FD                MOV     R5,A
   \   0D1E  A3                INC     DPTR
   \   0D1F  E0                MOVX    A,@DPTR
   \   0D20  4D                ORL     A,R5
   \   0D21  6006              JZ      ?0158
   \   0D23            ?0157:
    705                              PerformWriteSeq();
   \   0D23  120000            LCALL   $REFFN PerformWriteSeq
    706                              TerminateWriteSeq();
   \   0D26  120000            LCALL   $REFFN TerminateWriteSeq
   \   0D29            ?0158:
    707                          }
    708                          if (filePtr->write) {
   \   0D29  900000            MOV     DPTR,#$LOCBX fclose+2
   \   0D2C  E0                MOVX    A,@DPTR
   \   0D2D  FF                MOV     R7,A
   \   0D2E  A3                INC     DPTR
   \   0D2F  E0                MOVX    A,@DPTR
   \   0D30  FE                MOV     R6,A
   \   0D31  A3                INC     DPTR
   \   0D32  E0                MOVX    A,@DPTR
   \   0D33  FD                MOV     R5,A
   \   0D34  900019            MOV     DPTR,#25
   \   0D37  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0D3A  601B              JZ      ?0160
   \   0D3C            ?0159:
    709                              writeAddress = filePtr->startAddress;
   \   0D3C  90000D            MOV     DPTR,#13
   \   0D3F  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0D42  900000            MOV     DPTR,#writeAddress
   \   0D45  120000            LCALL   ?STO_R0123_DPTR_L20
    710                              WriteFileHead(filePtr->fileName, filePtr->length);
   \   0D48  900011            MOV     DPTR,#17
   \   0D4B  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0D4E  900000            MOV     DPTR,#$PRMBX WriteFileHead+3
   \   0D51  120000            LCALL   ?STO_R0123_DPTR_L20
   \   0D54  120000            LCALL   $REFFN WriteFileHead
   \   0D57            ?0160:
    711                          }
    712          
    713                          writeInProgress = 0;
   \   0D57  E4                CLR     A
   \   0D58  9000EC            MOV     DPTR,#writeInProgress
   \   0D5B  F0                MOVX    @DPTR,A
    714                      } else {
   \   0D5C  8003              SJMP    ?0161
   \   0D5E            ?0154:
    715                          TerminateReadSeq();
   \   0D5E  120000            LCALL   $REFFN TerminateReadSeq
   \   0D61            ?0161:
    716                      }
    717                      fs_currFilePtr = NULL;
   \   0D61  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0D64  E4                CLR     A
   \   0D65  F0                MOVX    @DPTR,A
   \   0D66  A3                INC     DPTR
   \   0D67  F0                MOVX    @DPTR,A
   \   0D68  A3                INC     DPTR
   \   0D69  F0                MOVX    @DPTR,A
   \   0D6A            ?0152:
    718                  }
    719                  filePtr->fileName[0] = 0;
   \   0D6A  900000            MOV     DPTR,#$LOCBX fclose+2
   \   0D6D  E0                MOVX    A,@DPTR
   \   0D6E  FF                MOV     R7,A
   \   0D6F  A3                INC     DPTR
   \   0D70  E0                MOVX    A,@DPTR
   \   0D71  FE                MOV     R6,A
   \   0D72  A3                INC     DPTR
   \   0D73  E0                MOVX    A,@DPTR
   \   0D74  FD                MOV     R5,A
   \   0D75  E4                CLR     A
   \   0D76  120000            LCALL   ?ST_A_R567_L17
   \   0D79            ?0150:
    720              }
    721          }
   \   0D79  900000            MOV     DPTR,#$LOCBX fclose
   \   0D7C  E0                MOVX    A,@DPTR
   \   0D7D  F8                MOV     R0,A
   \   0D7E  A3                INC     DPTR
   \   0D7F  E0                MOVX    A,@DPTR
   \   0D80  C0E0              PUSH    ACC
   \   0D82  E8                MOV     A,R0
   \   0D83  C0E0              PUSH    ACC
   \   0D85  22                RET
    722          
    723          long    ftell(FILE* filePtr)
    724          {
   \   0D86            ftell:
    725              if (filePtr->write) {
   \   0D86  900000            MOV     DPTR,#$LOCBX ftell
   \   0D89  EF                MOV     A,R7
   \   0D8A  F0                MOVX    @DPTR,A
   \   0D8B  A3                INC     DPTR
   \   0D8C  EE                MOV     A,R6
   \   0D8D  F0                MOVX    @DPTR,A
   \   0D8E  A3                INC     DPTR
   \   0D8F  ED                MOV     A,R5
   \   0D90  F0                MOVX    @DPTR,A
   \   0D91  900019            MOV     DPTR,#25
   \   0D94  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0D97  600F              JZ      ?0163
   \   0D99            ?0162:
    726                  return filePtr->length;
   \   0D99  900011            MOV     DPTR,#17
   \   0D9C  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0D9F  EA                MOV     A,R2
   \   0DA0  FE                MOV     R6,A
   \   0DA1  EB                MOV     A,R3
   \   0DA2  FF                MOV     R7,A
   \   0DA3  E8                MOV     A,R0
   \   0DA4  FC                MOV     R4,A
   \   0DA5  E9                MOV     A,R1
   \   0DA6  FD                MOV     R5,A
    727              } else {
   \   0DA7  22                RET
   \   0DA8            ?0163:
    728                  return filePtr->offset;
   \   0DA8  900015            MOV     DPTR,#21
   \   0DAB  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0DAE  EA                MOV     A,R2
   \   0DAF  FE                MOV     R6,A
   \   0DB0  EB                MOV     A,R3
   \   0DB1  FF                MOV     R7,A
   \   0DB2  E8                MOV     A,R0
   \   0DB3  FC                MOV     R4,A
   \   0DB4  E9                MOV     A,R1
   \   0DB5  FD                MOV     R5,A
    729              }
   \   0DB6            ?0164:
   \   0DB6  22                RET
    730          }
    731          
    732          
    733          /*
    734          void    Rewind(FILE* filePtr)
    735          {
    736              if ((filePtr->write) || (filePtr->append)) {
    737                  error = EM_FILEWRITEONLY;
    738              } else {
    739                  filePtr->offset = 0;
    740                  if (fs_currFilePtr == filePtr) {
    741                      TerminateReadSeq();
    742                      readAddress = filePtr->startAddress;
    743                      SetupReadSeq();
    744                  }
    745              }
    746          }
    747          */
    748          
    749          
    750          
    751          void     fSetPos(FILE* filePtr, long offset)
    752          {
   \   0DB7            fSetPos:
   \   0DB7  900000            MOV     DPTR,#$LOCBX fSetPos
   \   0DBA  D0E0              POP     ACC
   \   0DBC  F0                MOVX    @DPTR,A
   \   0DBD  A3                INC     DPTR
   \   0DBE  D0E0              POP     ACC
   \   0DC0  F0                MOVX    @DPTR,A
    753              if ((filePtr->write) || (filePtr->append)) {
   \   0DC1  A3                INC     DPTR
   \   0DC2  EF                MOV     A,R7
   \   0DC3  F0                MOVX    @DPTR,A
   \   0DC4  A3                INC     DPTR
   \   0DC5  EE                MOV     A,R6
   \   0DC6  F0                MOVX    @DPTR,A
   \   0DC7  A3                INC     DPTR
   \   0DC8  ED                MOV     A,R5
   \   0DC9  F0                MOVX    @DPTR,A
   \   0DCA  900019            MOV     DPTR,#25
   \   0DCD  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0DD0  7008              JNZ     ?0165
   \   0DD2  90001A            MOV     DPTR,#26
   \   0DD5  120000            LCALL   ?LD_A_R567_DISP_L17
   \   0DD8  600B              JZ      ?0166
   \   0DDA            ?0167:
   \   0DDA            ?0168:
   \   0DDA            ?0165:
    754                  error = EM_FILEWRITEONLY;
   \   0DDA  900000            MOV     DPTR,#error
   \   0DDD  E4                CLR     A
   \   0DDE  F0                MOVX    @DPTR,A
   \   0DDF  A3                INC     DPTR
   \   0DE0  7417              MOV     A,#23
   \   0DE2  F0                MOVX    @DPTR,A
    755              } else {
   \   0DE3  8077              SJMP    ?0169
   \   0DE5            ?0166:
    756                  if (offset < filePtr->length){
   \   0DE5  900011            MOV     DPTR,#17
   \   0DE8  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0DEB  900000            MOV     DPTR,#$LOCBX fSetPos+5
   \   0DEE  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   0DF1  740B              MOV     A,#11
   \   0DF3  120000            LCALL   ?L_CMP_L01
   \   0DF6  7064              JNZ     ?0171
   \   0DF8            ?0170:
    757                      filePtr->offset = offset;
   \   0DF8  900000            MOV     DPTR,#$LOCBX fSetPos+2
   \   0DFB  E0                MOVX    A,@DPTR
   \   0DFC  FB                MOV     R3,A
   \   0DFD  A3                INC     DPTR
   \   0DFE  E0                MOVX    A,@DPTR
   \   0DFF  FA                MOV     R2,A
   \   0E00  A3                INC     DPTR
   \   0E01  E0                MOVX    A,@DPTR
   \   0E02  F9                MOV     R1,A
   \   0E03  900015            MOV     DPTR,#21
   \   0E06  120000            LCALL   ?ST_R4567_R123_DISP_L17
    758                      if (fs_currFilePtr == filePtr) {
   \   0E09  9000E0            MOV     DPTR,#fs_currFilePtr+2
   \   0E0C  E0                MOVX    A,@DPTR
   \   0E0D  69                XRL     A,R1
   \   0E0E  700C              JNZ     ?0395
   \   0E10  9000DF            MOV     DPTR,#fs_currFilePtr+1
   \   0E13  E0                MOVX    A,@DPTR
   \   0E14  6A                XRL     A,R2
   \   0E15  7005              JNZ     ?0395
   \   0E17  9000DE            MOV     DPTR,#fs_currFilePtr
   \   0E1A  E0                MOVX    A,@DPTR
   \   0E1B  6B                XRL     A,R3
   \   0E1C            ?0395:
   \   0E1C  703E              JNZ     ?0173
   \   0E1E            ?0172:
    759                          TerminateReadSeq();
   \   0E1E  120000            LCALL   $REFFN TerminateReadSeq
    760                          readAddress = filePtr->startAddress + filePtr->offset;
   \   0E21  900000            MOV     DPTR,#$LOCBX fSetPos+2
   \   0E24  E0                MOVX    A,@DPTR
   \   0E25  FF                MOV     R7,A
   \   0E26  A3                INC     DPTR
   \   0E27  E0                MOVX    A,@DPTR
   \   0E28  FE                MOV     R6,A
   \   0E29  A3                INC     DPTR
   \   0E2A  E0                MOVX    A,@DPTR
   \   0E2B  FD                MOV     R5,A
   \   0E2C  900015            MOV     DPTR,#21
   \   0E2F  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0E32  EB                MOV     A,R3
   \   0E33  C0E0              PUSH    ACC
   \   0E35  EA                MOV     A,R2
   \   0E36  C0E0              PUSH    ACC
   \   0E38  E9                MOV     A,R1
   \   0E39  C0E0              PUSH    ACC
   \   0E3B  E8                MOV     A,R0
   \   0E3C  C0E0              PUSH    ACC
   \   0E3E  90000D            MOV     DPTR,#13
   \   0E41  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   0E44  D0E0              POP     ACC
   \   0E46  FC                MOV     R4,A
   \   0E47  D0E0              POP     ACC
   \   0E49  FD                MOV     R5,A
   \   0E4A  D0E0              POP     ACC
   \   0E4C  FE                MOV     R6,A
   \   0E4D  D0E0              POP     ACC
   \   0E4F  FF                MOV     R7,A
   \   0E50  120000            LCALL   ?L_ADD_L01
   \   0E53  9000E4            MOV     DPTR,#readAddress
   \   0E56  120000            LCALL   ?STO_R4567_DPTR_L20
    761                          SetupReadSeq();
   \   0E59  120000            LCALL   $REFFN SetupReadSeq
   \   0E5C            ?0173:
   \   0E5C            ?0171:
   \   0E5C            ?0169:
    762                      }
    763                  }
    764              }
    765          }
   \   0E5C  900000            MOV     DPTR,#$LOCBX fSetPos
   \   0E5F  E0                MOVX    A,@DPTR
   \   0E60  F8                MOV     R0,A
   \   0E61  A3                INC     DPTR
   \   0E62  E0                MOVX    A,@DPTR
   \   0E63  C0E0              PUSH    ACC
   \   0E65  E8                MOV     A,R0
   \   0E66  C0E0              PUSH    ACC
   \   0E68  22                RET
    766          
    767          
    768          void    fupLoad( void )
    769          {
   \   0E69            fupLoad:
   \   0E69  900000            MOV     DPTR,#$LOCBX fupLoad+266
   \   0E6C  D0E0              POP     ACC
   \   0E6E  F0                MOVX    @DPTR,A
   \   0E6F  A3                INC     DPTR
   \   0E70  D0E0              POP     ACC
   \   0E72  F0                MOVX    @DPTR,A
    770              xdata FILE*       fp;
    771              xdata char        c;
    772              xdata char        l;
    773              xdata int         i;
    774              xdata char        buffer[256];
    775              xdata char        lerror = 0;
    776              xdata char        command;
    777              xdata char        cs;
    778              
    779          
    780              SendRS232('O');
   \   0E73  7C4F              MOV     R4,#79
   \   0E75  120000            LCALL   $REFFN SendRS232
    781          
    782              c = WaitAndReceiveRS232();
   \   0E78  120000            LCALL   $REFFN WaitAndReceiveRS232
    783          
    784              if (c != 'F') {
   \   0E7B  E4                CLR     A
   \   0E7C  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0E7F  F0                MOVX    @DPTR,A
   \   0E80  EC                MOV     A,R4
   \   0E81  900000            MOV     DPTR,#$LOCBX fupLoad+3
   \   0E84  F0                MOVX    @DPTR,A
   \   0E85  6446              XRL     A,#70
   \   0E87  600E              JZ      ?0175
   \   0E89            ?0174:
    785                  lerror = 1;
    786                  SendRS232('1');         //Debug
   \   0E89  7C31              MOV     R4,#49
   \   0E8B  120000            LCALL   $REFFN SendRS232
   \   0E8E  7401              MOV     A,#1
   \   0E90  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0E93  F0                MOVX    @DPTR,A
    787              } else {
   \   0E94  02109C            LJMP    ?0176
   \   0E97            ?0175:
    788                  i = 0;
   \   0E97  A3                INC     DPTR
   \   0E98  A3                INC     DPTR
   \   0E99  E4                CLR     A
   \   0E9A  F0                MOVX    @DPTR,A
   \   0E9B  A3                INC     DPTR
   \   0E9C  F0                MOVX    @DPTR,A
   \   0E9D            ?0179:
    789                  do {                                          
    790                      c = WaitAndReceiveRS232();
   \   0E9D  120000            LCALL   $REFFN WaitAndReceiveRS232
   \   0EA0  EC                MOV     A,R4
   \   0EA1  900000            MOV     DPTR,#$LOCBX fupLoad+3
   \   0EA4  F0                MOVX    @DPTR,A
    791                      if (timeout) {
   \   0EA5  900000            MOV     DPTR,#timeout
   \   0EA8  E0                MOVX    A,@DPTR
   \   0EA9  600B              JZ      ?0181
   \   0EAB            ?0180:
    792                          lerror = 1;
    793                          SendRS232('2');         //Debug
   \   0EAB  7C32              MOV     R4,#50
   \   0EAD  120000            LCALL   $REFFN SendRS232
   \   0EB0  7401              MOV     A,#1
   \   0EB2  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0EB5  F0                MOVX    @DPTR,A
   \   0EB6            ?0181:
    794                      }
    795                      buffer[i++] = c;
   \   0EB6  900000            MOV     DPTR,#$LOCBX fupLoad+3
   \   0EB9  E0                MOVX    A,@DPTR
   \   0EBA  A3                INC     DPTR
   \   0EBB  A3                INC     DPTR
   \   0EBC  FE                MOV     R6,A
   \   0EBD  E0                MOVX    A,@DPTR
   \   0EBE  FD                MOV     R5,A
   \   0EBF  A3                INC     DPTR
   \   0EC0  E0                MOVX    A,@DPTR
   \   0EC1  FC                MOV     R4,A
   \   0EC2  E0                MOVX    A,@DPTR
   \   0EC3  04                INC     A
   \   0EC4  F0                MOVX    @DPTR,A
   \   0EC5  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   0EC8  7003              JNZ     ?0396
   \   0ECA  E0                MOVX    A,@DPTR
   \   0ECB  04                INC     A
   \   0ECC  F0                MOVX    @DPTR,A
   \   0ECD            ?0396:
   \   0ECD  EC                MOV     A,R4
   \   0ECE  2400              ADD     A,#LOW ($LOCBX fupLoad+7)
   \   0ED0  F582              MOV     DPL,A
   \   0ED2  E4                CLR     A
   \   0ED3  3400              ADDC    A,#HIGH ($LOCBX fupLoad+7)
   \   0ED5  F583              MOV     DPH,A
   \   0ED7  EE                MOV     A,R6
   \   0ED8  F0                MOVX    @DPTR,A
    796                  } while ((c != 0x00) && (i < 13) && (!lerror));
   \   0ED9  6017              JZ      ?0177
   \   0EDB  C3                CLR     C
   \   0EDC  900000            MOV     DPTR,#$LOCBX fupLoad+6
   \   0EDF  E0                MOVX    A,@DPTR
   \   0EE0  940D              SUBB    A,#13
   \   0EE2  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   0EE5  E0                MOVX    A,@DPTR
   \   0EE6  6480              XRL     A,#128
   \   0EE8  9480              SUBB    A,#128
   \   0EEA  5006              JNC     ?0177
   \   0EEC  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0EEF  E0                MOVX    A,@DPTR
   \   0EF0  60AB              JZ      ?0179
   \   0EF2            ?0177:
    797                  if (!lerror) {
   \   0EF2  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0EF5  E0                MOVX    A,@DPTR
   \   0EF6  6003              JZ      $+5
   \   0EF8  02109C            LJMP    ?0185
   \   0EFB            ?0184:
    798                      buffer[i] = 0;
   \   0EFB  900000            MOV     DPTR,#$LOCBX fupLoad+6
   \   0EFE  E0                MOVX    A,@DPTR
   \   0EFF  2400              ADD     A,#LOW ($LOCBX fupLoad+7)
   \   0F01  F582              MOV     DPL,A
   \   0F03  E4                CLR     A
   \   0F04  3400              ADDC    A,#HIGH ($LOCBX fupLoad+7)
   \   0F06  F583              MOV     DPH,A
   \   0F08  E4                CLR     A
   \   0F09  F0                MOVX    @DPTR,A
    799                      fp = fopen(buffer, "w");
   \   0F0A  7F02              MOV     R7,#2
   \   0F0C  900000            MOV     DPTR,#$PRMBX fopen+3
   \   0F0F  EF                MOV     A,R7
   \   0F10  F0                MOVX    @DPTR,A
   \   0F11  A3                INC     DPTR
   \   0F12  7400              MOV     A,#HIGH(?0186)
   \   0F14  F0                MOVX    @DPTR,A
   \   0F15  A3                INC     DPTR
   \   0F16  7400              MOV     A,#LOW(?0186)
   \   0F18  F0                MOVX    @DPTR,A
   \   0F19  7D00              MOV     R5,#LOW ($LOCBX fupLoad+7)
   \   0F1B  7E00              MOV     R6,#HIGH ($LOCBX fupLoad+7)
   \   0F1D  1F                DEC     R7
   \   0F1E  120000            LCALL   $REFFN fopen
    800                      if (!fp) {
   \   0F21  900000            MOV     DPTR,#$LOCBX fupLoad
   \   0F24  EF                MOV     A,R7
   \   0F25  F0                MOVX    @DPTR,A
   \   0F26  A3                INC     DPTR
   \   0F27  EE                MOV     A,R6
   \   0F28  F0                MOVX    @DPTR,A
   \   0F29  A3                INC     DPTR
   \   0F2A  ED                MOV     A,R5
   \   0F2B  F0                MOVX    @DPTR,A
   \   0F2C  4E                ORL     A,R6
   \   0F2D  7008              JNZ     ?0188
   \   0F2F            ?0187:
    801                          SendRS232('I');
   \   0F2F  7C49              MOV     R4,#73
   \   0F31  120000            LCALL   $REFFN SendRS232
    802                      } else {
   \   0F34  02109C            LJMP    ?0189
   \   0F37            ?0188:
    803                          SendRS232('O');
   \   0F37  7C4F              MOV     R4,#79
   \   0F39  120000            LCALL   $REFFN SendRS232
   \   0F3C            ?0192:
    804                          do {
    805                              command = WaitAndReceiveRS232();
   \   0F3C  120000            LCALL   $REFFN WaitAndReceiveRS232
    806                              if (command == 'L') {
   \   0F3F  EC                MOV     A,R4
   \   0F40  900000            MOV     DPTR,#$LOCBX fupLoad+264
   \   0F43  F0                MOVX    @DPTR,A
   \   0F44  B44C02            CJNE    A,#76,$+5
   \   0F47  8003              SJMP    $+5
   \   0F49  021066            LJMP    ?0194
   \   0F4C            ?0193:
    807                                  l = WaitAndReceiveRS232();
   \   0F4C  120000            LCALL   $REFFN WaitAndReceiveRS232
   \   0F4F  EC                MOV     A,R4
   \   0F50  900000            MOV     DPTR,#$LOCBX fupLoad+4
   \   0F53  F0                MOVX    @DPTR,A
    808                                  if (timeout) {
   \   0F54  900000            MOV     DPTR,#timeout
   \   0F57  E0                MOVX    A,@DPTR
   \   0F58  6009              JZ      ?0196
   \   0F5A            ?0195:
    809                                      lerror = 1;
   \   0F5A  7401              MOV     A,#1
   \   0F5C  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0F5F  F0                MOVX    @DPTR,A
    810          //                            SendRS232('3');         //Debug
    811                                  } else {
   \   0F60  021064            LJMP    ?0197
   \   0F63            ?0196:
    812                                      SendRS232('O');
   \   0F63  7C4F              MOV     R4,#79
   \   0F65  120000            LCALL   $REFFN SendRS232
    813                                      cs = 0xFF;
    814                                      for (i=0 ; i<l+1 ; i++) {
   \   0F68  74FF              MOV     A,#255
   \   0F6A  900000            MOV     DPTR,#$LOCBX fupLoad+265
   \   0F6D  F0                MOVX    @DPTR,A
   \   0F6E  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   0F71  E4                CLR     A
   \   0F72  F0                MOVX    @DPTR,A
   \   0F73  A3                INC     DPTR
   \   0F74  F0                MOVX    @DPTR,A
   \   0F75            ?0199:
   \   0F75  900000            MOV     DPTR,#$LOCBX fupLoad+4
   \   0F78  E0                MOVX    A,@DPTR
   \   0F79  2401              ADD     A,#1
   \   0F7B  FC                MOV     R4,A
   \   0F7C  E4                CLR     A
   \   0F7D  3400              ADDC    A,#0
   \   0F7F  FD                MOV     R5,A
   \   0F80  A3                INC     DPTR
   \   0F81  A3                INC     DPTR
   \   0F82  E0                MOVX    A,@DPTR
   \   0F83  C3                CLR     C
   \   0F84  9C                SUBB    A,R4
   \   0F85  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   0F88  E0                MOVX    A,@DPTR
   \   0F89  6480              XRL     A,#128
   \   0F8B  CD                XCH     A,R5
   \   0F8C  6480              XRL     A,#128
   \   0F8E  CD                XCH     A,R5
   \   0F8F  9D                SUBB    A,R5
   \   0F90  503A              JNC     ?0198
   \   0F92            ?0200:
    815                                          c = WaitAndReceiveRS232();
   \   0F92  120000            LCALL   $REFFN WaitAndReceiveRS232
   \   0F95  EC                MOV     A,R4
   \   0F96  900000            MOV     DPTR,#$LOCBX fupLoad+3
   \   0F99  F0                MOVX    @DPTR,A
    816                                          if (timeout) {
   \   0F9A  900000            MOV     DPTR,#timeout
   \   0F9D  E0                MOVX    A,@DPTR
   \   0F9E  6006              JZ      ?0203
   \   0FA0            ?0202:
    817                                              lerror = 1;
   \   0FA0  7401              MOV     A,#1
   \   0FA2  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0FA5  F0                MOVX    @DPTR,A
   \   0FA6            ?0203:
    818          //                                    SendRS232('4');         //Debug
    819                                          }
    820                                          buffer[i] = c;
   \   0FA6  900000            MOV     DPTR,#$LOCBX fupLoad+6
   \   0FA9  E0                MOVX    A,@DPTR
   \   0FAA  2400              ADD     A,#LOW ($LOCBX fupLoad+7)
   \   0FAC  F582              MOV     DPL,A
   \   0FAE  E4                CLR     A
   \   0FAF  3400              ADDC    A,#HIGH ($LOCBX fupLoad+7)
   \   0FB1  F583              MOV     DPH,A
   \   0FB3  EC                MOV     A,R4
   \   0FB4  F0                MOVX    @DPTR,A
    821                                          cs ^= c;
   \   0FB5  900000            MOV     DPTR,#$LOCBX fupLoad+265
   \   0FB8  FD                MOV     R5,A
   \   0FB9  E0                MOVX    A,@DPTR
   \   0FBA  6D                XRL     A,R5
   \   0FBB  F0                MOVX    @DPTR,A
   \   0FBC  900000            MOV     DPTR,#$LOCBX fupLoad+6
   \   0FBF  E0                MOVX    A,@DPTR
   \   0FC0  04                INC     A
   \   0FC1  F0                MOVX    @DPTR,A
   \   0FC2  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   0FC5  7003              JNZ     ?0397
   \   0FC7  E0                MOVX    A,@DPTR
   \   0FC8  04                INC     A
   \   0FC9  F0                MOVX    @DPTR,A
   \   0FCA            ?0397:
   \   0FCA  80A9              SJMP    ?0199
   \   0FCC            ?0198:
    822                                      }
    823                                      if (!lerror) {
   \   0FCC  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0FCF  E0                MOVX    A,@DPTR
   \   0FD0  6003              JZ      $+5
   \   0FD2  021064            LJMP    ?0205
   \   0FD5            ?0204:
    824                                          c = WaitAndReceiveRS232();
   \   0FD5  120000            LCALL   $REFFN WaitAndReceiveRS232
   \   0FD8  EC                MOV     A,R4
   \   0FD9  900000            MOV     DPTR,#$LOCBX fupLoad+3
   \   0FDC  F0                MOVX    @DPTR,A
    825                                          if (timeout) {
   \   0FDD  900000            MOV     DPTR,#timeout
   \   0FE0  E0                MOVX    A,@DPTR
   \   0FE1  6008              JZ      ?0207
   \   0FE3            ?0206:
    826                                              lerror = 1;
   \   0FE3  7401              MOV     A,#1
   \   0FE5  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   0FE8  F0                MOVX    @DPTR,A
    827          //                                    SendRS232('5');         //Debug
    828                                          } else {
   \   0FE9  8079              SJMP    ?0208
   \   0FEB            ?0207:
    829                                              cs ^= c;
   \   0FEB  EC                MOV     A,R4
   \   0FEC  900000            MOV     DPTR,#$LOCBX fupLoad+265
   \   0FEF  FD                MOV     R5,A
   \   0FF0  E0                MOVX    A,@DPTR
   \   0FF1  6D                XRL     A,R5
    830                                              if (cs == 0x00) {
   \   0FF2  F0                MOVX    @DPTR,A
   \   0FF3  7056              JNZ     ?0210
   \   0FF5            ?0209:
    831                                                  for (i=0 ; i<l+1 ; i++) {
   \   0FF5  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   0FF8  E4                CLR     A
   \   0FF9  F0                MOVX    @DPTR,A
   \   0FFA  A3                INC     DPTR
   \   0FFB  F0                MOVX    @DPTR,A
   \   0FFC            ?0212:
   \   0FFC  900000            MOV     DPTR,#$LOCBX fupLoad+4
   \   0FFF  E0                MOVX    A,@DPTR
   \   1000  2401              ADD     A,#1
   \   1002  FC                MOV     R4,A
   \   1003  E4                CLR     A
   \   1004  3400              ADDC    A,#0
   \   1006  FD                MOV     R5,A
   \   1007  A3                INC     DPTR
   \   1008  A3                INC     DPTR
   \   1009  E0                MOVX    A,@DPTR
   \   100A  C3                CLR     C
   \   100B  9C                SUBB    A,R4
   \   100C  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   100F  E0                MOVX    A,@DPTR
   \   1010  6480              XRL     A,#128
   \   1012  CD                XCH     A,R5
   \   1013  6480              XRL     A,#128
   \   1015  CD                XCH     A,R5
   \   1016  9D                SUBB    A,R5
   \   1017  502B              JNC     ?0211
   \   1019            ?0213:
    832                                                      fputc(fp, buffer[i]);
   \   1019  A3                INC     DPTR
   \   101A  E0                MOVX    A,@DPTR
   \   101B  2400              ADD     A,#LOW ($LOCBX fupLoad+7)
   \   101D  F582              MOV     DPL,A
   \   101F  E4                CLR     A
   \   1020  3400              ADDC    A,#HIGH ($LOCBX fupLoad+7)
   \   1022  F583              MOV     DPH,A
   \   1024  E0                MOVX    A,@DPTR
   \   1025  FC                MOV     R4,A
   \   1026  900000            MOV     DPTR,#$LOCBX fupLoad
   \   1029  E0                MOVX    A,@DPTR
   \   102A  FF                MOV     R7,A
   \   102B  A3                INC     DPTR
   \   102C  E0                MOVX    A,@DPTR
   \   102D  FE                MOV     R6,A
   \   102E  A3                INC     DPTR
   \   102F  E0                MOVX    A,@DPTR
   \   1030  FD                MOV     R5,A
   \   1031  120000            LCALL   $REFFN fputc
   \   1034  900000            MOV     DPTR,#$LOCBX fupLoad+6
   \   1037  E0                MOVX    A,@DPTR
   \   1038  04                INC     A
   \   1039  F0                MOVX    @DPTR,A
   \   103A  900000            MOV     DPTR,#$LOCBX fupLoad+5
   \   103D  7003              JNZ     ?0398
   \   103F  E0                MOVX    A,@DPTR
   \   1040  04                INC     A
   \   1041  F0                MOVX    @DPTR,A
   \   1042            ?0398:
   \   1042  80B8              SJMP    ?0212
   \   1044            ?0211:
    833                                                  }                            
    834                                                  SendRS232('O');
   \   1044  7C4F              MOV     R4,#79
   \   1046  120000            LCALL   $REFFN SendRS232
    835                                              } else {
   \   1049  8005              SJMP    ?0215
   \   104B            ?0210:
    836                                                  SendRS232('R');
   \   104B  7C52              MOV     R4,#82
   \   104D  120000            LCALL   $REFFN SendRS232
   \   1050            ?0215:
    837                                              }
    838                                              if (FLASHWriteState == OCCUPIED) {
   \   1050  900005            MOV     DPTR,#FLASHWriteState+1
   \   1053  E0                MOVX    A,@DPTR
   \   1054  6404              XRL     A,#4
   \   1056  7004              JNZ     ?0399
   \   1058  900004            MOV     DPTR,#FLASHWriteState
   \   105B  E0                MOVX    A,@DPTR
   \   105C            ?0399:
   \   105C  7006              JNZ     ?0217
   \   105E            ?0216:
    839                                                  lerror = 1;
   \   105E  7401              MOV     A,#1
   \   1060  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   1063  F0                MOVX    @DPTR,A
   \   1064            ?0217:
   \   1064            ?0208:
   \   1064            ?0205:
   \   1064            ?0197:
   \   1064  800A              SJMP    ?0218
   \   1066            ?0194:
    840          //                                        SendRS232('6');         //Debug
    841                                              }
    842                                          }
    843                                      }
    844                                  }
    845                              } else if (command != 'D') {
   \   1066  6444              XRL     A,#68
   \   1068  6006              JZ      ?0220
   \   106A            ?0219:
    846                                  lerror = 1;
   \   106A  7401              MOV     A,#1
   \   106C  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   106F  F0                MOVX    @DPTR,A
   \   1070            ?0220:
   \   1070            ?0218:
    847          //                        SendRS232('7');         //Debug
    848                              }
    849                          } while ((command == 'L') && (!lerror));
   \   1070  900000            MOV     DPTR,#$LOCBX fupLoad+264
   \   1073  E0                MOVX    A,@DPTR
   \   1074  B44C09            CJNE    A,#76,?0190
   \   1077  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   107A  E0                MOVX    A,@DPTR
   \   107B  7003              JNZ     $+5
   \   107D  020F3C            LJMP    ?0192
   \   1080            ?0190:
    850                          if (command != 'D') {
   \   1080  900000            MOV     DPTR,#$LOCBX fupLoad+264
   \   1083  E0                MOVX    A,@DPTR
   \   1084  6444              XRL     A,#68
   \   1086  6006              JZ      ?0224
   \   1088            ?0223:
    851                              lerror = 1;
   \   1088  7401              MOV     A,#1
   \   108A  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   108D  F0                MOVX    @DPTR,A
   \   108E            ?0224:
    852          //                    SendRS232('8');         //Debug
    853                          }
    854                          fclose(fp);
   \   108E  900000            MOV     DPTR,#$LOCBX fupLoad
   \   1091  E0                MOVX    A,@DPTR
   \   1092  FF                MOV     R7,A
   \   1093  A3                INC     DPTR
   \   1094  E0                MOVX    A,@DPTR
   \   1095  FE                MOV     R6,A
   \   1096  A3                INC     DPTR
   \   1097  E0                MOVX    A,@DPTR
   \   1098  FD                MOV     R5,A
   \   1099  120000            LCALL   $REFFN fclose
   \   109C            ?0189:
   \   109C            ?0185:
   \   109C            ?0176:
    855                      }    
    856                  }
    857              }    
    858              if (lerror) {
   \   109C  900000            MOV     DPTR,#$LOCBX fupLoad+263
   \   109F  E0                MOVX    A,@DPTR
   \   10A0  6005              JZ      ?0226
   \   10A2            ?0225:
    859                  SendRS232('E');
   \   10A2  7C45              MOV     R4,#69
   \   10A4  120000            LCALL   $REFFN SendRS232
   \   10A7            ?0226:
    860              }
    861          }
   \   10A7  900000            MOV     DPTR,#$LOCBX fupLoad+266
   \   10AA  E0                MOVX    A,@DPTR
   \   10AB  F8                MOV     R0,A
   \   10AC  A3                INC     DPTR
   \   10AD  E0                MOVX    A,@DPTR
   \   10AE  C0E0              PUSH    ACC
   \   10B0  E8                MOV     A,R0
   \   10B1  C0E0              PUSH    ACC
   \   10B3  22                RET
    862          
    863          void    fdownLoad( void )
    864          {   
   \   10B4            fdownLoad:
   \   10B4  900000            MOV     DPTR,#$LOCBX fdownLoad+32
   \   10B7  D0E0              POP     ACC
   \   10B9  F0                MOVX    @DPTR,A
   \   10BA  A3                INC     DPTR
   \   10BB  D0E0              POP     ACC
   \   10BD  F0                MOVX    @DPTR,A
    865              xdata char        c;
    866              xdata char        lerror = 0;
    867              xdata FILE_HEAD   fh;
    868              xdata int         index;
    869              xdata int         i;
    870              xdata char        okHead;
    871              xdata long        count;
    872              xdata FILE*       fp;
    873              xdata char        cs;
    874              
    875              SendRS232('O');
   \   10BE  7C4F              MOV     R4,#79
   \   10C0  120000            LCALL   $REFFN SendRS232
    876              
    877              readAddress = 0;
   \   10C3  9000E4            MOV     DPTR,#readAddress
   \   10C6  E4                CLR     A
   \   10C7  F0                MOVX    @DPTR,A
   \   10C8  A3                INC     DPTR
   \   10C9  F0                MOVX    @DPTR,A
   \   10CA  A3                INC     DPTR
   \   10CB  F0                MOVX    @DPTR,A
   \   10CC  A3                INC     DPTR
   \   10CD  F0                MOVX    @DPTR,A
   \   10CE  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   10D1  F0                MOVX    @DPTR,A
   \   10D2            ?0228:
    878           
    879              while ((GetFileHead(&fh)) && (!lerror)) {
   \   10D2  7D00              MOV     R5,#LOW ($LOCBX fdownLoad+2)
   \   10D4  7E00              MOV     R6,#HIGH ($LOCBX fdownLoad+2)
   \   10D6  7F01              MOV     R7,#1
   \   10D8  120000            LCALL   $REFFN GetFileHead
   \   10DB  EC                MOV     A,R4
   \   10DC  607A              JZ      ?0227
   \   10DE  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   10E1  E0                MOVX    A,@DPTR
   \   10E2  7074              JNZ     ?0227
   \   10E4            ?0231:
   \   10E4            ?0230:
   \   10E4            ?0229:
    880                  c = WaitAndReceiveRS232();
   \   10E4  120000            LCALL   $REFFN WaitAndReceiveRS232
    881                  if (c != 'F') {
   \   10E7  EC                MOV     A,R4
   \   10E8  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   10EB  F0                MOVX    @DPTR,A
   \   10EC  6446              XRL     A,#70
   \   10EE  6006              JZ      ?0233
   \   10F0            ?0232:
    882                      lerror = 1;
   \   10F0  7401              MOV     A,#1
   \   10F2  A3                INC     DPTR
   \   10F3  F0                MOVX    @DPTR,A
    883                  } else {
   \   10F4  805F              SJMP    ?0234
   \   10F6            ?0233:
    884                      SendRS232('F');
   \   10F6  7C46              MOV     R4,#70
   \   10F8  120000            LCALL   $REFFN SendRS232
    885                      SendStringRS232(fh.name);
   \   10FB  7D00              MOV     R5,#LOW ($LOCBX fdownLoad+6)
   \   10FD  7E00              MOV     R6,#HIGH ($LOCBX fdownLoad+6)
   \   10FF  7F01              MOV     R7,#1
   \   1101  120000            LCALL   $REFFN SendStringRS232
    886                      SendRS232(0x00);
   \   1104  7C00              MOV     R4,#0
   \   1106  120000            LCALL   $REFFN SendRS232
    887                      readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   1109  900000            MOV     DPTR,#$LOCBX fdownLoad+2
   \   110C  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   110F  E4                CLR     A
   \   1110  F8                MOV     R0,A
   \   1111  74FE              MOV     A,#254
   \   1113  F9                MOV     R1,A
   \   1114  04                INC     A
   \   1115  FA                MOV     R2,A
   \   1116  FB                MOV     R3,A
   \   1117  120000            LCALL   ?L_AND_L01
   \   111A  E4                CLR     A
   \   111B  F8                MOV     R0,A
   \   111C  FA                MOV     R2,A
   \   111D  FB                MOV     R3,A
   \   111E  7902              MOV     R1,#2
   \   1120  120000            LCALL   ?L_ADD_L01
   \   1123  EF                MOV     A,R7
   \   1124  C0E0              PUSH    ACC
   \   1126  EE                MOV     A,R6
   \   1127  C0E0              PUSH    ACC
   \   1129  ED                MOV     A,R5
   \   112A  C0E0              PUSH    ACC
   \   112C  EC                MOV     A,R4
   \   112D  C0E0              PUSH    ACC
   \   112F  9000E4            MOV     DPTR,#readAddress
   \   1132  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1135  E4                CLR     A
   \   1136  F8                MOV     R0,A
   \   1137  74FE              MOV     A,#254
   \   1139  F9                MOV     R1,A
   \   113A  04                INC     A
   \   113B  FA                MOV     R2,A
   \   113C  FB                MOV     R3,A
   \   113D  120000            LCALL   ?L_AND_L01
   \   1140  D0E0              POP     ACC
   \   1142  F8                MOV     R0,A
   \   1143  D0E0              POP     ACC
   \   1145  F9                MOV     R1,A
   \   1146  D0E0              POP     ACC
   \   1148  FA                MOV     R2,A
   \   1149  D0E0              POP     ACC
   \   114B  FB                MOV     R3,A
   \   114C  120000            LCALL   ?L_ADD_L01
   \   114F  9000E4            MOV     DPTR,#readAddress
   \   1152  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1155            ?0234:
   \   1155  0210D2            LJMP    ?0228
   \   1158            ?0227:
    888                  }
    889              }
    890              if (!lerror) {
   \   1158  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   115B  E0                MOVX    A,@DPTR
   \   115C  7010              JNZ     ?0236
   \   115E            ?0235:
    891                  c = WaitAndReceiveRS232();
   \   115E  120000            LCALL   $REFFN WaitAndReceiveRS232
    892                  if (c != 'F') {
   \   1161  EC                MOV     A,R4
   \   1162  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   1165  F0                MOVX    @DPTR,A
   \   1166  6446              XRL     A,#70
   \   1168  6004              JZ      ?0238
   \   116A            ?0237:
    893                      lerror = 1;
   \   116A  7401              MOV     A,#1
   \   116C  A3                INC     DPTR
   \   116D  F0                MOVX    @DPTR,A
   \   116E            ?0238:
   \   116E            ?0236:
    894                  }
    895              }    
    896              if (!lerror) {
   \   116E  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   1171  E0                MOVX    A,@DPTR
   \   1172  6003              JZ      $+5
   \   1174  0213A1            LJMP    ?0240
   \   1177            ?0239:
    897                  SendRS232('D');
   \   1177  7C44              MOV     R4,#68
   \   1179  120000            LCALL   $REFFN SendRS232
    898                  c = WaitAndReceiveRS232();                          //OBS Skall inte vara timeout!!!!!!!!!
   \   117C  120000            LCALL   $REFFN WaitAndReceiveRS232
    899                  if (c != 'S') {
   \   117F  EC                MOV     A,R4
   \   1180  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   1183  F0                MOVX    @DPTR,A
   \   1184  6453              XRL     A,#83
   \   1186  6012              JZ      ?0242
   \   1188            ?0241:
    900                      if (c == 'C') {
   \   1188  EC                MOV     A,R4
   \   1189  B44307            CJNE    A,#67,?0244
   \   118C            ?0243:
    901                          SendRS232('C');
   \   118C  7C43              MOV     R4,#67
   \   118E  120000            LCALL   $REFFN SendRS232
    902                      } else {
   \   1191  8004              SJMP    ?0245
   \   1193            ?0244:
    903                          lerror = 1;
   \   1193  7401              MOV     A,#1
   \   1195  A3                INC     DPTR
   \   1196  F0                MOVX    @DPTR,A
   \   1197            ?0245:
    904                      }
    905                  } else {
   \   1197  0213A1            LJMP    ?0246
   \   119A            ?0242:
    906                      c =  WaitAndReceiveRS232();
   \   119A  120000            LCALL   $REFFN WaitAndReceiveRS232
   \   119D  EC                MOV     A,R4
   \   119E  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   11A1  F0                MOVX    @DPTR,A
    907                      if (!timeout) {
   \   11A2  900000            MOV     DPTR,#timeout
   \   11A5  E0                MOVX    A,@DPTR
   \   11A6  6003              JZ      $+5
   \   11A8  02139B            LJMP    ?0248
   \   11AB            ?0247:
    908                          index = c * 256;
   \   11AB  EC                MOV     A,R4
   \   11AC  900000            MOV     DPTR,#$LOCBX fdownLoad+19
   \   11AF  F0                MOVX    @DPTR,A
   \   11B0  A3                INC     DPTR
   \   11B1  E4                CLR     A
   \   11B2  F0                MOVX    @DPTR,A
    909                          c =  WaitAndReceiveRS232();
   \   11B3  120000            LCALL   $REFFN WaitAndReceiveRS232
   \   11B6  EC                MOV     A,R4
   \   11B7  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   11BA  F0                MOVX    @DPTR,A
    910                          if (!timeout) {
   \   11BB  900000            MOV     DPTR,#timeout
   \   11BE  E0                MOVX    A,@DPTR
   \   11BF  6003              JZ      $+5
   \   11C1  021393            LJMP    ?0250
   \   11C4            ?0249:
    911                              index += c;
   \   11C4  7D00              MOV     R5,#0
   \   11C6  900000            MOV     DPTR,#$LOCBX fdownLoad+20
   \   11C9  E0                MOVX    A,@DPTR
   \   11CA  2C                ADD     A,R4
   \   11CB  F0                MOVX    @DPTR,A
   \   11CC  900000            MOV     DPTR,#$LOCBX fdownLoad+19
   \   11CF  E0                MOVX    A,@DPTR
   \   11D0  3D                ADDC    A,R5
   \   11D1  F0                MOVX    @DPTR,A
    912          //                    SendRS232('W');
    913          //                    SendRS232((index >> 8) & 0xFF);
    914          //                    SendRS232(index & 0xFF);
    915                              i = 0;
    916                              readAddress = 0;
   \   11D2  9000E4            MOV     DPTR,#readAddress
   \   11D5  E4                CLR     A
   \   11D6  F0                MOVX    @DPTR,A
   \   11D7  A3                INC     DPTR
   \   11D8  F0                MOVX    @DPTR,A
   \   11D9  A3                INC     DPTR
   \   11DA  F0                MOVX    @DPTR,A
   \   11DB  A3                INC     DPTR
   \   11DC  F0                MOVX    @DPTR,A
   \   11DD  900000            MOV     DPTR,#$LOCBX fdownLoad+21
   \   11E0  F0                MOVX    @DPTR,A
   \   11E1  A3                INC     DPTR
   \   11E2  F0                MOVX    @DPTR,A
   \   11E3            ?0253:
    917                              do {
    918                                  okHead = GetFileHead(&fh);
   \   11E3  7D00              MOV     R5,#LOW ($LOCBX fdownLoad+2)
   \   11E5  7E00              MOV     R6,#HIGH ($LOCBX fdownLoad+2)
   \   11E7  7F01              MOV     R7,#1
   \   11E9  120000            LCALL   $REFFN GetFileHead
   \   11EC  EC                MOV     A,R4
   \   11ED  900000            MOV     DPTR,#$LOCBX fdownLoad+23
   \   11F0  F0                MOVX    @DPTR,A
    919                                  i++;
   \   11F1  900000            MOV     DPTR,#$LOCBX fdownLoad+22
   \   11F4  E0                MOVX    A,@DPTR
   \   11F5  04                INC     A
   \   11F6  F0                MOVX    @DPTR,A
   \   11F7  900000            MOV     DPTR,#$LOCBX fdownLoad+21
   \   11FA  7003              JNZ     ?0400
   \   11FC  E0                MOVX    A,@DPTR
   \   11FD  04                INC     A
   \   11FE  F0                MOVX    @DPTR,A
   \   11FF            ?0400:
    920                                  readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   11FF  900000            MOV     DPTR,#$LOCBX fdownLoad+2
   \   1202  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1205  E4                CLR     A
   \   1206  F8                MOV     R0,A
   \   1207  74FE              MOV     A,#254
   \   1209  F9                MOV     R1,A
   \   120A  04                INC     A
   \   120B  FA                MOV     R2,A
   \   120C  FB                MOV     R3,A
   \   120D  120000            LCALL   ?L_AND_L01
   \   1210  E4                CLR     A
   \   1211  F8                MOV     R0,A
   \   1212  FA                MOV     R2,A
   \   1213  FB                MOV     R3,A
   \   1214  7902              MOV     R1,#2
   \   1216  120000            LCALL   ?L_ADD_L01
   \   1219  EF                MOV     A,R7
   \   121A  C0E0              PUSH    ACC
   \   121C  EE                MOV     A,R6
   \   121D  C0E0              PUSH    ACC
   \   121F  ED                MOV     A,R5
   \   1220  C0E0              PUSH    ACC
   \   1222  EC                MOV     A,R4
   \   1223  C0E0              PUSH    ACC
   \   1225  9000E4            MOV     DPTR,#readAddress
   \   1228  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   122B  E4                CLR     A
   \   122C  F8                MOV     R0,A
   \   122D  74FE              MOV     A,#254
   \   122F  F9                MOV     R1,A
   \   1230  04                INC     A
   \   1231  FA                MOV     R2,A
   \   1232  FB                MOV     R3,A
   \   1233  120000            LCALL   ?L_AND_L01
   \   1236  D0E0              POP     ACC
   \   1238  F8                MOV     R0,A
   \   1239  D0E0              POP     ACC
   \   123B  F9                MOV     R1,A
   \   123C  D0E0              POP     ACC
   \   123E  FA                MOV     R2,A
   \   123F  D0E0              POP     ACC
   \   1241  FB                MOV     R3,A
   \   1242  120000            LCALL   ?L_ADD_L01
   \   1245  9000E4            MOV     DPTR,#readAddress
   \   1248  120000            LCALL   ?STO_R4567_DPTR_L20
    921                              } while ((i <= index) && (okHead));
   \   124B  900000            MOV     DPTR,#$LOCBX fdownLoad+21
   \   124E  E0                MOVX    A,@DPTR
   \   124F  FD                MOV     R5,A
   \   1250  A3                INC     DPTR
   \   1251  E0                MOVX    A,@DPTR
   \   1252  FC                MOV     R4,A
   \   1253  900000            MOV     DPTR,#$LOCBX fdownLoad+20
   \   1256  E0                MOVX    A,@DPTR
   \   1257  C3                CLR     C
   \   1258  9C                SUBB    A,R4
   \   1259  900000            MOV     DPTR,#$LOCBX fdownLoad+19
   \   125C  E0                MOVX    A,@DPTR
   \   125D  6480              XRL     A,#128
   \   125F  CD                XCH     A,R5
   \   1260  6480              XRL     A,#128
   \   1262  CD                XCH     A,R5
   \   1263  9D                SUBB    A,R5
   \   1264  4009              JC      ?0251
   \   1266  900000            MOV     DPTR,#$LOCBX fdownLoad+23
   \   1269  E0                MOVX    A,@DPTR
   \   126A  6003              JZ      $+5
   \   126C  0211E3            LJMP    ?0253
   \   126F            ?0251:
    922                              if (okHead) {
   \   126F  900000            MOV     DPTR,#$LOCBX fdownLoad+23
   \   1272  E0                MOVX    A,@DPTR
   \   1273  6022              JZ      ?0257
   \   1275            ?0256:
    923                                  fp = fopen(fh.name, "r");
   \   1275  7F02              MOV     R7,#2
   \   1277  900000            MOV     DPTR,#$PRMBX fopen+3
   \   127A  EF                MOV     A,R7
   \   127B  F0                MOVX    @DPTR,A
   \   127C  A3                INC     DPTR
   \   127D  7400              MOV     A,#HIGH(?0258)
   \   127F  F0                MOVX    @DPTR,A
   \   1280  A3                INC     DPTR
   \   1281  7402              MOV     A,#LOW(?0258)
   \   1283  F0                MOVX    @DPTR,A
   \   1284  7D00              MOV     R5,#LOW ($LOCBX fdownLoad+6)
   \   1286  7E00              MOV     R6,#HIGH ($LOCBX fdownLoad+6)
   \   1288  1F                DEC     R7
   \   1289  120000            LCALL   $REFFN fopen
   \   128C  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   128F  EF                MOV     A,R7
   \   1290  F0                MOVX    @DPTR,A
   \   1291  A3                INC     DPTR
   \   1292  EE                MOV     A,R6
   \   1293  F0                MOVX    @DPTR,A
   \   1294  A3                INC     DPTR
   \   1295  ED                MOV     A,R5
   \   1296  F0                MOVX    @DPTR,A
   \   1297            ?0257:
    924                              }
    925                              if ((!fp) || (!okHead)) {
   \   1297  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   129A  E0                MOVX    A,@DPTR
   \   129B  FF                MOV     R7,A
   \   129C  A3                INC     DPTR
   \   129D  E0                MOVX    A,@DPTR
   \   129E  FE                MOV     R6,A
   \   129F  A3                INC     DPTR
   \   12A0  E0                MOVX    A,@DPTR
   \   12A1  FD                MOV     R5,A
   \   12A2  4E                ORL     A,R6
   \   12A3  6006              JZ      ?0259
   \   12A5  900000            MOV     DPTR,#$LOCBX fdownLoad+23
   \   12A8  E0                MOVX    A,@DPTR
   \   12A9  7008              JNZ     ?0260
   \   12AB            ?0261:
   \   12AB            ?0262:
   \   12AB            ?0259:
    926                                  SendRS232('O');
   \   12AB  7C4F              MOV     R4,#79
   \   12AD  120000            LCALL   $REFFN SendRS232
    927                              } else {
   \   12B0  021391            LJMP    ?0263
   \   12B3            ?0260:
    928                                  SendRS232('L');
   \   12B3  7C4C              MOV     R4,#76
   \   12B5  120000            LCALL   $REFFN SendRS232
    929                                  SendRS232((fp->length >> 24) & 0xFF);
   \   12B8  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   12BB  E0                MOVX    A,@DPTR
   \   12BC  FF                MOV     R7,A
   \   12BD  A3                INC     DPTR
   \   12BE  E0                MOVX    A,@DPTR
   \   12BF  FE                MOV     R6,A
   \   12C0  A3                INC     DPTR
   \   12C1  E0                MOVX    A,@DPTR
   \   12C2  FD                MOV     R5,A
   \   12C3  900011            MOV     DPTR,#17
   \   12C6  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   12C9  EB                MOV     A,R3
   \   12CA  FC                MOV     R4,A
   \   12CB  120000            LCALL   $REFFN SendRS232
    930                                  SendRS232((fp->length >> 16) & 0xFF);
   \   12CE  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   12D1  E0                MOVX    A,@DPTR
   \   12D2  FF                MOV     R7,A
   \   12D3  A3                INC     DPTR
   \   12D4  E0                MOVX    A,@DPTR
   \   12D5  FE                MOV     R6,A
   \   12D6  A3                INC     DPTR
   \   12D7  E0                MOVX    A,@DPTR
   \   12D8  FD                MOV     R5,A
   \   12D9  900011            MOV     DPTR,#17
   \   12DC  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   12DF  EA                MOV     A,R2
   \   12E0  FC                MOV     R4,A
   \   12E1  120000            LCALL   $REFFN SendRS232
    931                                  SendRS232((fp->length >> 8) & 0xFF);
   \   12E4  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   12E7  E0                MOVX    A,@DPTR
   \   12E8  FF                MOV     R7,A
   \   12E9  A3                INC     DPTR
   \   12EA  E0                MOVX    A,@DPTR
   \   12EB  FE                MOV     R6,A
   \   12EC  A3                INC     DPTR
   \   12ED  E0                MOVX    A,@DPTR
   \   12EE  FD                MOV     R5,A
   \   12EF  900011            MOV     DPTR,#17
   \   12F2  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   12F5  E9                MOV     A,R1
   \   12F6  FC                MOV     R4,A
   \   12F7  120000            LCALL   $REFFN SendRS232
    932                                  SendRS232(fp->length & 0xFF);
   \   12FA  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   12FD  E0                MOVX    A,@DPTR
   \   12FE  FF                MOV     R7,A
   \   12FF  A3                INC     DPTR
   \   1300  E0                MOVX    A,@DPTR
   \   1301  FE                MOV     R6,A
   \   1302  A3                INC     DPTR
   \   1303  E0                MOVX    A,@DPTR
   \   1304  FD                MOV     R5,A
   \   1305  900011            MOV     DPTR,#17
   \   1308  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   130B  E8                MOV     A,R0
   \   130C  FC                MOV     R4,A
   \   130D  120000            LCALL   $REFFN SendRS232
    933                                  c =  WaitAndReceiveRS232();
   \   1310  120000            LCALL   $REFFN WaitAndReceiveRS232
    934                                  if (c != 'O') {
   \   1313  EC                MOV     A,R4
   \   1314  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   1317  F0                MOVX    @DPTR,A
   \   1318  644F              XRL     A,#79
   \   131A  6006              JZ      ?0265
   \   131C            ?0264:
    935                                      lerror = 1;
   \   131C  7401              MOV     A,#1
   \   131E  A3                INC     DPTR
   \   131F  F0                MOVX    @DPTR,A
    936                                  } else {
   \   1320  8061              SJMP    ?0266
   \   1322            ?0265:
    937                                      cs = 0xFF;
    938                                      for (count=0 ; count < fh.length ; count++) {
   \   1322  74FF              MOV     A,#255
   \   1324  900000            MOV     DPTR,#$LOCBX fdownLoad+31
   \   1327  F0                MOVX    @DPTR,A
   \   1328  900000            MOV     DPTR,#$LOCBX fdownLoad+24
   \   132B  E4                CLR     A
   \   132C  F0                MOVX    @DPTR,A
   \   132D  A3                INC     DPTR
   \   132E  F0                MOVX    @DPTR,A
   \   132F  A3                INC     DPTR
   \   1330  F0                MOVX    @DPTR,A
   \   1331  A3                INC     DPTR
   \   1332  F0                MOVX    @DPTR,A
   \   1333            ?0268:
   \   1333  900000            MOV     DPTR,#$LOCBX fdownLoad+24
   \   1336  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1339  900000            MOV     DPTR,#$LOCBX fdownLoad+2
   \   133C  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   133F  740B              MOV     A,#11
   \   1341  120000            LCALL   ?L_CMP_L01
   \   1344  7030              JNZ     ?0267
   \   1346            ?0269:
    939                                          c = fgetc(fp);
   \   1346  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   1349  E0                MOVX    A,@DPTR
   \   134A  FF                MOV     R7,A
   \   134B  A3                INC     DPTR
   \   134C  E0                MOVX    A,@DPTR
   \   134D  FE                MOV     R6,A
   \   134E  A3                INC     DPTR
   \   134F  E0                MOVX    A,@DPTR
   \   1350  FD                MOV     R5,A
   \   1351  120000            LCALL   $REFFN fgetc
    940                                          cs ^= c;
   \   1354  EC                MOV     A,R4
   \   1355  900000            MOV     DPTR,#$LOCBX fdownLoad+31
   \   1358  FD                MOV     R5,A
   \   1359  E0                MOVX    A,@DPTR
   \   135A  6D                XRL     A,R5
   \   135B  F0                MOVX    @DPTR,A
    941                                          SendRS232(c);
   \   135C  EC                MOV     A,R4
   \   135D  900000            MOV     DPTR,#$LOCBX fdownLoad
   \   1360  F0                MOVX    @DPTR,A
   \   1361  120000            LCALL   $REFFN SendRS232
    942                                          WDT = 1;
   \   1364  D2AE              SETB    IE.6
    943                                          SWDT = 1;
   \   1366  D2BE              SETB    IP.6
   \   1368  900000            MOV     DPTR,#$LOCBX fdownLoad+24
   \   136B  E4                CLR     A
   \   136C  FD                MOV     R5,A
   \   136D  FE                MOV     R6,A
   \   136E  FF                MOV     R7,A
   \   136F  04                INC     A
   \   1370  FC                MOV     R4,A
   \   1371  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
   \   1374  80BD              SJMP    ?0268
   \   1376            ?0267:
    944                                      }
    945                                      SendRS232(cs);
   \   1376  900000            MOV     DPTR,#$LOCBX fdownLoad+31
   \   1379  E0                MOVX    A,@DPTR
   \   137A  FC                MOV     R4,A
   \   137B  120000            LCALL   $REFFN SendRS232
    946                                      SendRS232('D');
   \   137E  7C44              MOV     R4,#68
   \   1380  120000            LCALL   $REFFN SendRS232
   \   1383            ?0266:
    947                                  }
    948                                  fclose(fp);
   \   1383  900000            MOV     DPTR,#$LOCBX fdownLoad+28
   \   1386  E0                MOVX    A,@DPTR
   \   1387  FF                MOV     R7,A
   \   1388  A3                INC     DPTR
   \   1389  E0                MOVX    A,@DPTR
   \   138A  FE                MOV     R6,A
   \   138B  A3                INC     DPTR
   \   138C  E0                MOVX    A,@DPTR
   \   138D  FD                MOV     R5,A
   \   138E  120000            LCALL   $REFFN fclose
   \   1391            ?0263:
    949                              }
    950                          } else {
   \   1391  8006              SJMP    ?0271
   \   1393            ?0250:
    951                              lerror = 1;
   \   1393  7401              MOV     A,#1
   \   1395  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   1398  F0                MOVX    @DPTR,A
   \   1399            ?0271:
    952                          }
    953                      } else {
   \   1399  8006              SJMP    ?0272
   \   139B            ?0248:
    954                          lerror = 1;
   \   139B  7401              MOV     A,#1
   \   139D  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   13A0  F0                MOVX    @DPTR,A
   \   13A1            ?0272:
   \   13A1            ?0246:
   \   13A1            ?0240:
    955                      }
    956                  }
    957              }
    958              if (lerror) {
   \   13A1  900000            MOV     DPTR,#$LOCBX fdownLoad+1
   \   13A4  E0                MOVX    A,@DPTR
   \   13A5  6005              JZ      ?0274
   \   13A7            ?0273:
    959                  SendRS232('E');
   \   13A7  7C45              MOV     R4,#69
   \   13A9  120000            LCALL   $REFFN SendRS232
   \   13AC            ?0274:
    960              }
    961          }   
   \   13AC  900000            MOV     DPTR,#$LOCBX fdownLoad+32
   \   13AF  E0                MOVX    A,@DPTR
   \   13B0  F8                MOV     R0,A
   \   13B1  A3                INC     DPTR
   \   13B2  E0                MOVX    A,@DPTR
   \   13B3  C0E0              PUSH    ACC
   \   13B5  E8                MOV     A,R0
   \   13B6  C0E0              PUSH    ACC
   \   13B8  22                RET
    962          
    963          
    964          void Dir( void )
    965          {
   \   13B9            Dir:
   \   13B9  900000            MOV     DPTR,#$LOCBX Dir+17
   \   13BC  D0E0              POP     ACC
   \   13BE  F0                MOVX    @DPTR,A
   \   13BF  A3                INC     DPTR
   \   13C0  D0E0              POP     ACC
   \   13C2  F0                MOVX    @DPTR,A
    966              xdata FILE_HEAD   fh;
    967          //    int         l;
    968              
    969          //    SendStringEOLRS232("Searching for files...");
    970           
    971              readAddress = 0;
   \   13C3  9000E4            MOV     DPTR,#readAddress
   \   13C6  E4                CLR     A
   \   13C7  F0                MOVX    @DPTR,A
   \   13C8  A3                INC     DPTR
   \   13C9  F0                MOVX    @DPTR,A
   \   13CA  A3                INC     DPTR
   \   13CB  F0                MOVX    @DPTR,A
   \   13CC  A3                INC     DPTR
   \   13CD  F0                MOVX    @DPTR,A
   \   13CE            ?0276:
    972                  
    973              while (GetFileHead(&fh)) {
   \   13CE  7D00              MOV     R5,#LOW $LOCBX Dir
   \   13D0  7E00              MOV     R6,#HIGH $LOCBX Dir
   \   13D2  7F01              MOV     R7,#1
   \   13D4  120000            LCALL   $REFFN GetFileHead
   \   13D7  EC                MOV     A,R4
   \   13D8  7003              JNZ     $+5
   \   13DA  02145E            LJMP    ?0275
   \   13DD            ?0277:
    974                  SendStringRS232(fh.name);      
   \   13DD  7D00              MOV     R5,#LOW ($LOCBX Dir+4)
   \   13DF  7E00              MOV     R6,#HIGH ($LOCBX Dir+4)
   \   13E1  7F01              MOV     R7,#1
   \   13E3  120000            LCALL   $REFFN SendStringRS232
    975                  SendStringRS232("\t\t"); 
   \   13E6  7D04              MOV     R5,#LOW(?0278)
   \   13E8  7E00              MOV     R6,#HIGH(?0278)
   \   13EA  7F02              MOV     R7,#2
   \   13EC  120000            LCALL   $REFFN SendStringRS232
    976          
    977                  myLong2HexStr(fh.length, msg);
   \   13EF  7401              MOV     A,#1
   \   13F1  900000            MOV     DPTR,#$PRMBX myLong2HexStr+4
   \   13F4  F0                MOVX    @DPTR,A
   \   13F5  A3                INC     DPTR
   \   13F6  7400              MOV     A,#HIGH(msg)
   \   13F8  F0                MOVX    @DPTR,A
   \   13F9  A3                INC     DPTR
   \   13FA  7400              MOV     A,#LOW(msg)
   \   13FC  F0                MOVX    @DPTR,A
   \   13FD  900000            MOV     DPTR,#$LOCBX Dir
   \   1400  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1403  120000            LCALL   $REFFN myLong2HexStr
    978                  SendStringEOLRS232(msg);
   \   1406  7D00              MOV     R5,#LOW(msg)
   \   1408  7E00              MOV     R6,#HIGH(msg)
   \   140A  7F01              MOV     R7,#1
   \   140C  120000            LCALL   $REFFN SendStringEOLRS232
    979          /*
    980                  l = (fh.length >> 16) & 0xFFFF;
    981                  sprintf(msg, "0x%04X", l);
    982                  SendStringRS232(msg);
    983                  l = fh.length & 0xFFFF;
    984                  sprintf(msg, "%04X", l);
    985                  SendStringEOLRS232(msg);
    986          */
    987                  readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   140F  900000            MOV     DPTR,#$LOCBX Dir
   \   1412  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1415  E4                CLR     A
   \   1416  F8                MOV     R0,A
   \   1417  74FE              MOV     A,#254
   \   1419  F9                MOV     R1,A
   \   141A  04                INC     A
   \   141B  FA                MOV     R2,A
   \   141C  FB                MOV     R3,A
   \   141D  120000            LCALL   ?L_AND_L01
   \   1420  E4                CLR     A
   \   1421  F8                MOV     R0,A
   \   1422  FA                MOV     R2,A
   \   1423  FB                MOV     R3,A
   \   1424  7902              MOV     R1,#2
   \   1426  120000            LCALL   ?L_ADD_L01
   \   1429  EF                MOV     A,R7
   \   142A  C0E0              PUSH    ACC
   \   142C  EE                MOV     A,R6
   \   142D  C0E0              PUSH    ACC
   \   142F  ED                MOV     A,R5
   \   1430  C0E0              PUSH    ACC
   \   1432  EC                MOV     A,R4
   \   1433  C0E0              PUSH    ACC
   \   1435  9000E4            MOV     DPTR,#readAddress
   \   1438  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   143B  E4                CLR     A
   \   143C  F8                MOV     R0,A
   \   143D  74FE              MOV     A,#254
   \   143F  F9                MOV     R1,A
   \   1440  04                INC     A
   \   1441  FA                MOV     R2,A
   \   1442  FB                MOV     R3,A
   \   1443  120000            LCALL   ?L_AND_L01
   \   1446  D0E0              POP     ACC
   \   1448  F8                MOV     R0,A
   \   1449  D0E0              POP     ACC
   \   144B  F9                MOV     R1,A
   \   144C  D0E0              POP     ACC
   \   144E  FA                MOV     R2,A
   \   144F  D0E0              POP     ACC
   \   1451  FB                MOV     R3,A
   \   1452  120000            LCALL   ?L_ADD_L01
   \   1455  9000E4            MOV     DPTR,#readAddress
   \   1458  120000            LCALL   ?STO_R4567_DPTR_L20
    988              }
    989          }
   \   145B  0213CE            LJMP    ?0276
   \   145E            ?0275:
   \   145E  900000            MOV     DPTR,#$LOCBX Dir+17
   \   1461  E0                MOVX    A,@DPTR
   \   1462  F8                MOV     R0,A
   \   1463  A3                INC     DPTR
   \   1464  E0                MOVX    A,@DPTR
   \   1465  C0E0              PUSH    ACC
   \   1467  E8                MOV     A,R0
   \   1468  C0E0              PUSH    ACC
   \   146A  22                RET
    990           
    991           
    992          // Startaddress skall bli 1F0000 enl ovan
    993          
    994          
    995          
    996          void Type( void )
    997          {
   \   146B            Type:
   \   146B  900000            MOV     DPTR,#$LOCBX Type+7
   \   146E  D0E0              POP     ACC
   \   1470  F0                MOVX    @DPTR,A
   \   1471  A3                INC     DPTR
   \   1472  D0E0              POP     ACC
   \   1474  F0                MOVX    @DPTR,A
    998              xdata FILE*   fp;
    999              xdata long    i;
   1000              
   1001              fp = fopen(commandLine[1], "r");
   \   1475  7F02              MOV     R7,#2
   \   1477  900000            MOV     DPTR,#$PRMBX fopen+3
   \   147A  EF                MOV     A,R7
   \   147B  F0                MOVX    @DPTR,A
   \   147C  A3                INC     DPTR
   \   147D  7400              MOV     A,#HIGH(?0258)
   \   147F  F0                MOVX    @DPTR,A
   \   1480  A3                INC     DPTR
   \   1481  7402              MOV     A,#LOW(?0258)
   \   1483  F0                MOVX    @DPTR,A
   \   1484  7D10              MOV     R5,#LOW(commandLine+16)
   \   1486  7E00              MOV     R6,#HIGH(commandLine+16)
   \   1488  1F                DEC     R7
   \   1489  120000            LCALL   $REFFN fopen
   1002              if (fp) {
   \   148C  900000            MOV     DPTR,#$LOCBX Type
   \   148F  EF                MOV     A,R7
   \   1490  F0                MOVX    @DPTR,A
   \   1491  A3                INC     DPTR
   \   1492  EE                MOV     A,R6
   \   1493  F0                MOVX    @DPTR,A
   \   1494  A3                INC     DPTR
   \   1495  ED                MOV     A,R5
   \   1496  F0                MOVX    @DPTR,A
   \   1497  4E                ORL     A,R6
   \   1498  6058              JZ      ?0280
   \   149A            ?0279:
   1003                  for (i=0 ; i<fp->length ; i++) {
   \   149A  A3                INC     DPTR
   \   149B  E4                CLR     A
   \   149C  F0                MOVX    @DPTR,A
   \   149D  A3                INC     DPTR
   \   149E  F0                MOVX    @DPTR,A
   \   149F  A3                INC     DPTR
   \   14A0  F0                MOVX    @DPTR,A
   \   14A1  A3                INC     DPTR
   \   14A2  F0                MOVX    @DPTR,A
   \   14A3            ?0282:
   \   14A3  900000            MOV     DPTR,#$LOCBX Type
   \   14A6  E0                MOVX    A,@DPTR
   \   14A7  FF                MOV     R7,A
   \   14A8  A3                INC     DPTR
   \   14A9  E0                MOVX    A,@DPTR
   \   14AA  FE                MOV     R6,A
   \   14AB  A3                INC     DPTR
   \   14AC  E0                MOVX    A,@DPTR
   \   14AD  FD                MOV     R5,A
   \   14AE  900011            MOV     DPTR,#17
   \   14B1  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   14B4  900000            MOV     DPTR,#$LOCBX Type+3
   \   14B7  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   14BA  740B              MOV     A,#11
   \   14BC  120000            LCALL   ?L_CMP_L01
   \   14BF  7023              JNZ     ?0281
   \   14C1            ?0283:
   1004                      SendRS232(fgetc(fp));
   \   14C1  900000            MOV     DPTR,#$LOCBX Type
   \   14C4  E0                MOVX    A,@DPTR
   \   14C5  FF                MOV     R7,A
   \   14C6  A3                INC     DPTR
   \   14C7  E0                MOVX    A,@DPTR
   \   14C8  FE                MOV     R6,A
   \   14C9  A3                INC     DPTR
   \   14CA  E0                MOVX    A,@DPTR
   \   14CB  FD                MOV     R5,A
   \   14CC  120000            LCALL   $REFFN fgetc
   \   14CF  120000            LCALL   $REFFN SendRS232
   1005                      WDT = 1;
   \   14D2  D2AE              SETB    IE.6
   1006                      SWDT = 1;
   \   14D4  D2BE              SETB    IP.6
   \   14D6  900000            MOV     DPTR,#$LOCBX Type+3
   \   14D9  E4                CLR     A
   \   14DA  FD                MOV     R5,A
   \   14DB  FE                MOV     R6,A
   \   14DC  FF                MOV     R7,A
   \   14DD  04                INC     A
   \   14DE  FC                MOV     R4,A
   \   14DF  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
   \   14E2  80BF              SJMP    ?0282
   \   14E4            ?0281:
   1007                  }
   1008                  fclose(fp);
   \   14E4  900000            MOV     DPTR,#$LOCBX Type
   \   14E7  E0                MOVX    A,@DPTR
   \   14E8  FF                MOV     R7,A
   \   14E9  A3                INC     DPTR
   \   14EA  E0                MOVX    A,@DPTR
   \   14EB  FE                MOV     R6,A
   \   14EC  A3                INC     DPTR
   \   14ED  E0                MOVX    A,@DPTR
   \   14EE  FD                MOV     R5,A
   \   14EF  120000            LCALL   $REFFN fclose
   \   14F2            ?0280:
   1009          //    } else {
   1010          //        SendStringEOLRS232("Unable to open file");
   1011              }
   1012          }
   \   14F2  900000            MOV     DPTR,#$LOCBX Type+7
   \   14F5  E0                MOVX    A,@DPTR
   \   14F6  F8                MOV     R0,A
   \   14F7  A3                INC     DPTR
   \   14F8  E0                MOVX    A,@DPTR
   \   14F9  C0E0              PUSH    ACC
   \   14FB  E8                MOV     A,R0
   \   14FC  C0E0              PUSH    ACC
   \   14FE  22                RET
   1013          
   1014          
   1015           
   1016          
   1017          /******************************************************************************
   1018          En fil av typen A (append) öppnas för skrivning med kommandot fopenA. Vill man
   1019          läsa i filen skall den öppnas med kommandot fopen(...., "r"); Det går att öppna
   1020          filen för skrivning efter att den har varit öppen för läsning.
   1021          När fopenA har körts kan fputc, fputLine och fclose användas som vanligt. Om filen
   1022          har öppnats med fopen(...., "w"); används fgetc, fgetLine och fclose som vanligt.
   1023          Om första lediga filpos är känd kan den skickas med parametern offset. Annars, om
   1024          -1 skickas i offset, hittas skrivstart-positionen automatiskt, men det kan ta tid 
   1025          för stora filer
   1026          */
   1027          
   1028              
   1029          FILE*   fopenA(const char* name, long maxSize, long offset)
   1030          {   
   \   14FF            fopenA:
   \   14FF  900000            MOV     DPTR,#$LOCBX fopenA+28
   \   1502  D0E0              POP     ACC
   \   1504  F0                MOVX    @DPTR,A
   \   1505  A3                INC     DPTR
   \   1506  D0E0              POP     ACC
   \   1508  F0                MOVX    @DPTR,A
   1031              xdata FILE*       tmpFile;
   1032              xdata FILE_HEAD   fh;
   1033              xdata char        done;
   1034              xdata char        exists;
   1035              xdata char        endFound;
   1036              xdata long        fileEnd;
   1037              xdata char        i;
   1038           
   1039              if (FileOpen(name)) {
   \   1509  A3                INC     DPTR
   \   150A  EF                MOV     A,R7
   \   150B  F0                MOVX    @DPTR,A
   \   150C  A3                INC     DPTR
   \   150D  EE                MOV     A,R6
   \   150E  F0                MOVX    @DPTR,A
   \   150F  A3                INC     DPTR
   \   1510  ED                MOV     A,R5
   \   1511  F0                MOVX    @DPTR,A
   \   1512  120000            LCALL   $REFFN FileOpen
   \   1515  EC                MOV     A,R4
   \   1516  6010              JZ      ?0286
   \   1518            ?0285:
   1040                  error = EM_FILEOPEN;
   \   1518  900000            MOV     DPTR,#error
   \   151B  E4                CLR     A
   \   151C  F0                MOVX    @DPTR,A
   \   151D  A3                INC     DPTR
   \   151E  7414              MOV     A,#20
   \   1520  F0                MOVX    @DPTR,A
   1041                  return NULL;
   \   1521  E4                CLR     A
   \   1522  FD                MOV     R5,A
   \   1523  FE                MOV     R6,A
   \   1524  FF                MOV     R7,A
   1042              }
   \   1525  02185B            LJMP    ?0329
   \   1528            ?0286:
   1043          
   1044              tmpFile = FindEmptyFileStruct();
   \   1528  120000            LCALL   $REFFN FindEmptyFileStruct
   1045              if (tmpFile == NULL) {
   \   152B  900000            MOV     DPTR,#$LOCBX fopenA
   \   152E  EF                MOV     A,R7
   \   152F  F0                MOVX    @DPTR,A
   \   1530  A3                INC     DPTR
   \   1531  EE                MOV     A,R6
   \   1532  F0                MOVX    @DPTR,A
   \   1533  A3                INC     DPTR
   \   1534  ED                MOV     A,R5
   \   1535  F0                MOVX    @DPTR,A
   \   1536  4E                ORL     A,R6
   \   1537  7010              JNZ     ?0288
   \   1539            ?0287:
   1046                  error = EM_TOOMANYFILES;
   \   1539  900000            MOV     DPTR,#error
   \   153C  E4                CLR     A
   \   153D  F0                MOVX    @DPTR,A
   \   153E  A3                INC     DPTR
   \   153F  7413              MOV     A,#19
   \   1541  F0                MOVX    @DPTR,A
   1047                  return NULL;
   \   1542  E4                CLR     A
   \   1543  FD                MOV     R5,A
   \   1544  FE                MOV     R6,A
   \   1545  FF                MOV     R7,A
   1048              }
   \   1546  02185B            LJMP    ?0329
   \   1549            ?0288:
   1049          
   1050              readAddress = 0;
   \   1549  9000E4            MOV     DPTR,#readAddress
   \   154C  E4                CLR     A
   \   154D  F0                MOVX    @DPTR,A
   \   154E  A3                INC     DPTR
   \   154F  F0                MOVX    @DPTR,A
   \   1550  A3                INC     DPTR
   \   1551  F0                MOVX    @DPTR,A
   \   1552  A3                INC     DPTR
   \   1553  F0                MOVX    @DPTR,A
   1051                               
   1052              fs_currFilePtr = NULL;                                  //Antag att det blir fel nedan. Detta måste
   \   1554  9000DE            MOV     DPTR,#fs_currFilePtr
   \   1557  F0                MOVX    @DPTR,A
   \   1558  A3                INC     DPTR
   \   1559  F0                MOVX    @DPTR,A
   \   155A  A3                INC     DPTR
   \   155B  F0                MOVX    @DPTR,A
   1053                                                                          //göras eftersom FLASH-pekaren flyttats
   1054              done = 0;
   1055              exists = 1;
   \   155C  900000            MOV     DPTR,#$LOCBX fopenA+20
   \   155F  F0                MOVX    @DPTR,A
   \   1560  04                INC     A
   \   1561  A3                INC     DPTR
   \   1562  F0                MOVX    @DPTR,A
   \   1563            ?0291:
   1056                   
   1057              do {
   1058                  if (!GetFileHead(&fh)) {
   \   1563  7D00              MOV     R5,#LOW ($LOCBX fopenA+3)
   \   1565  7E00              MOV     R6,#HIGH ($LOCBX fopenA+3)
   \   1567  7F01              MOV     R7,#1
   \   1569  120000            LCALL   $REFFN GetFileHead
   \   156C  BC0005            CJNE    R4,#0,?0293
   \   156F            ?0292:
   1059                      exists = 0;
   \   156F  E4                CLR     A
   \   1570  900000            MOV     DPTR,#$LOCBX fopenA+21
   \   1573  F0                MOVX    @DPTR,A
   \   1574            ?0293:
   1060                  }
   1061                  if (readAddress >= FS_FLASHSIZE) {
   \   1574  9000E4            MOV     DPTR,#readAddress
   \   1577  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   157A  E4                CLR     A
   \   157B  F8                MOV     R0,A
   \   157C  F9                MOV     R1,A
   \   157D  FB                MOV     R3,A
   \   157E  7A80              MOV     R2,#128
   \   1580  7402              MOV     A,#2
   \   1582  120000            LCALL   ?L_CMP_L01
   \   1585  7005              JNZ     ?0295
   \   1587            ?0294:
   1062                      exists = 0;
   \   1587  E8                MOV     A,R0
   \   1588  900000            MOV     DPTR,#$LOCBX fopenA+21
   \   158B  F0                MOVX    @DPTR,A
   \   158C            ?0295:
   1063                  }
   1064                  if (exists) {
   \   158C  900000            MOV     DPTR,#$LOCBX fopenA+21
   \   158F  E0                MOVX    A,@DPTR
   \   1590  6073              JZ      ?0297
   \   1592            ?0296:
   1065                      if (myStrCmpNoCase(name, fh.name)) {
   \   1592  7401              MOV     A,#1
   \   1594  900000            MOV     DPTR,#$PRMBX myStrCmpNoCase+3
   \   1597  F0                MOVX    @DPTR,A
   \   1598  A3                INC     DPTR
   \   1599  7400              MOV     A,#HIGH ($LOCBX fopenA+7)
   \   159B  F0                MOVX    @DPTR,A
   \   159C  A3                INC     DPTR
   \   159D  7400              MOV     A,#LOW ($LOCBX fopenA+7)
   \   159F  F0                MOVX    @DPTR,A
   \   15A0  900000            MOV     DPTR,#$LOCBX fopenA+30
   \   15A3  E0                MOVX    A,@DPTR
   \   15A4  FF                MOV     R7,A
   \   15A5  A3                INC     DPTR
   \   15A6  E0                MOVX    A,@DPTR
   \   15A7  FE                MOV     R6,A
   \   15A8  A3                INC     DPTR
   \   15A9  E0                MOVX    A,@DPTR
   \   15AA  FD                MOV     R5,A
   \   15AB  120000            LCALL   $REFFN myStrCmpNoCase
   \   15AE  EC                MOV     A,R4
   \   15AF  604E              JZ      ?0299
   \   15B1            ?0298:
   1066                          readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   15B1  900000            MOV     DPTR,#$LOCBX fopenA+3
   \   15B4  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   15B7  E4                CLR     A
   \   15B8  F8                MOV     R0,A
   \   15B9  74FE              MOV     A,#254
   \   15BB  F9                MOV     R1,A
   \   15BC  04                INC     A
   \   15BD  FA                MOV     R2,A
   \   15BE  FB                MOV     R3,A
   \   15BF  120000            LCALL   ?L_AND_L01
   \   15C2  E4                CLR     A
   \   15C3  F8                MOV     R0,A
   \   15C4  FA                MOV     R2,A
   \   15C5  FB                MOV     R3,A
   \   15C6  7902              MOV     R1,#2
   \   15C8  120000            LCALL   ?L_ADD_L01
   \   15CB  EF                MOV     A,R7
   \   15CC  C0E0              PUSH    ACC
   \   15CE  EE                MOV     A,R6
   \   15CF  C0E0              PUSH    ACC
   \   15D1  ED                MOV     A,R5
   \   15D2  C0E0              PUSH    ACC
   \   15D4  EC                MOV     A,R4
   \   15D5  C0E0              PUSH    ACC
   \   15D7  9000E4            MOV     DPTR,#readAddress
   \   15DA  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   15DD  E4                CLR     A
   \   15DE  F8                MOV     R0,A
   \   15DF  74FE              MOV     A,#254
   \   15E1  F9                MOV     R1,A
   \   15E2  04                INC     A
   \   15E3  FA                MOV     R2,A
   \   15E4  FB                MOV     R3,A
   \   15E5  120000            LCALL   ?L_AND_L01
   \   15E8  D0E0              POP     ACC
   \   15EA  F8                MOV     R0,A
   \   15EB  D0E0              POP     ACC
   \   15ED  F9                MOV     R1,A
   \   15EE  D0E0              POP     ACC
   \   15F0  FA                MOV     R2,A
   \   15F1  D0E0              POP     ACC
   \   15F3  FB                MOV     R3,A
   \   15F4  120000            LCALL   ?L_ADD_L01
   \   15F7  9000E4            MOV     DPTR,#readAddress
   \   15FA  120000            LCALL   ?STO_R4567_DPTR_L20
   1067          //                SendStringEOLRS232("Found one file");
   1068          //                SendStringEOLRS232(fh.name);
   1069                          
   1070                      } else {
   \   15FD  8006              SJMP    ?0300
   \   15FF            ?0299:
   1071                          done = 1;
   \   15FF  7401              MOV     A,#1
   \   1601  900000            MOV     DPTR,#$LOCBX fopenA+20
   \   1604  F0                MOVX    @DPTR,A
   \   1605            ?0300:
   \   1605            ?0297:
   1072                      }
   1073                  }
   1074              } while ((!done) && (exists));
   \   1605  900000            MOV     DPTR,#$LOCBX fopenA+20
   \   1608  E0                MOVX    A,@DPTR
   \   1609  7007              JNZ     ?0289
   \   160B  A3                INC     DPTR
   \   160C  E0                MOVX    A,@DPTR
   \   160D  6003              JZ      $+5
   \   160F  021563            LJMP    ?0291
   \   1612            ?0289:
   1075          
   1076              myStrCpy(tmpFile->fileName, name);
   \   1612  900000            MOV     DPTR,#$LOCBX fopenA+30
   \   1615  E0                MOVX    A,@DPTR
   \   1616  FF                MOV     R7,A
   \   1617  A3                INC     DPTR
   \   1618  E0                MOVX    A,@DPTR
   \   1619  FE                MOV     R6,A
   \   161A  A3                INC     DPTR
   \   161B  E0                MOVX    A,@DPTR
   \   161C  FD                MOV     R5,A
   \   161D  900000            MOV     DPTR,#$PRMBX myStrCpy+3
   \   1620  EF                MOV     A,R7
   \   1621  F0                MOVX    @DPTR,A
   \   1622  A3                INC     DPTR
   \   1623  EE                MOV     A,R6
   \   1624  F0                MOVX    @DPTR,A
   \   1625  A3                INC     DPTR
   \   1626  ED                MOV     A,R5
   \   1627  F0                MOVX    @DPTR,A
   \   1628  900000            MOV     DPTR,#$LOCBX fopenA
   \   162B  E0                MOVX    A,@DPTR
   \   162C  FF                MOV     R7,A
   \   162D  A3                INC     DPTR
   \   162E  E0                MOVX    A,@DPTR
   \   162F  FE                MOV     R6,A
   \   1630  A3                INC     DPTR
   \   1631  E0                MOVX    A,@DPTR
   \   1632  FD                MOV     R5,A
   \   1633  120000            LCALL   $REFFN myStrCpy
   1077              tmpFile->startAddress = readAddress & 0xFFFFFE00;
   \   1636  9000E4            MOV     DPTR,#readAddress
   \   1639  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   163C  E4                CLR     A
   \   163D  F8                MOV     R0,A
   \   163E  74FE              MOV     A,#254
   \   1640  F9                MOV     R1,A
   \   1641  04                INC     A
   \   1642  FA                MOV     R2,A
   \   1643  FB                MOV     R3,A
   \   1644  120000            LCALL   ?L_AND_L01
   \   1647  900000            MOV     DPTR,#$LOCBX fopenA
   \   164A  E0                MOVX    A,@DPTR
   \   164B  FB                MOV     R3,A
   \   164C  A3                INC     DPTR
   \   164D  E0                MOVX    A,@DPTR
   \   164E  FA                MOV     R2,A
   \   164F  A3                INC     DPTR
   \   1650  E0                MOVX    A,@DPTR
   \   1651  F9                MOV     R1,A
   \   1652  90000D            MOV     DPTR,#13
   \   1655  120000            LCALL   ?ST_R4567_R123_DISP_L17
   1078          
   1079          //    SendStringRS232("Startaddress: ");
   1080          //    myLong2HexStr(tmpFile->startAddress, msg);
   1081          //    SendStringEOLRS232(msg);
   1082          
   1083              if (exists) {
   \   1658  900000            MOV     DPTR,#$LOCBX fopenA+21
   \   165B  E0                MOVX    A,@DPTR
   \   165C  7003              JNZ     $+5
   \   165E  0217CF            LJMP    ?0304
   \   1661            ?0303:
   1084                  tmpFile->length = fh.length;
   \   1661  900000            MOV     DPTR,#$LOCBX fopenA+3
   \   1664  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1667  900011            MOV     DPTR,#17
   \   166A  120000            LCALL   ?ST_R4567_R123_DISP_L17
   1085                  tmpFile->write = 0;
   \   166D  E4                CLR     A
   \   166E  900019            MOV     DPTR,#25
   \   1671  120000            LCALL   ?ST_A_R123_DISP_L17
   1086                  tmpFile->append = 1;
   \   1674  04                INC     A
   \   1675  90001A            MOV     DPTR,#26
   \   1678  120000            LCALL   ?ST_A_R123_DISP_L17
   1087                  if (offset == -1) {
   \   167B  900000            MOV     DPTR,#$LOCBX fopenA+37
   \   167E  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1681  74FF              MOV     A,#255
   \   1683  F8                MOV     R0,A
   \   1684  F9                MOV     R1,A
   \   1685  FA                MOV     R2,A
   \   1686  FB                MOV     R3,A
   \   1687  740D              MOV     A,#13
   \   1689  120000            LCALL   ?L_CMP_L01
   \   168C  6003              JZ      $+5
   \   168E  021784            LJMP    ?0306
   \   1691            ?0305:
   1088                 
   1089                      readAddress = tmpFile->startAddress;
   \   1691  900000            MOV     DPTR,#$LOCBX fopenA
   \   1694  E0                MOVX    A,@DPTR
   \   1695  FF                MOV     R7,A
   \   1696  A3                INC     DPTR
   \   1697  E0                MOVX    A,@DPTR
   \   1698  FE                MOV     R6,A
   \   1699  A3                INC     DPTR
   \   169A  E0                MOVX    A,@DPTR
   \   169B  FD                MOV     R5,A
   \   169C  90000D            MOV     DPTR,#13
   \   169F  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   16A2  9000E4            MOV     DPTR,#readAddress
   \   16A5  120000            LCALL   ?STO_R0123_DPTR_L20
   1090                  
   1091                      fileEnd = readAddress + fh.length;
   \   16A8  900000            MOV     DPTR,#$LOCBX fopenA+3
   \   16AB  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   16AE  120000            LCALL   ?L_ADD_L01
   \   16B1  900000            MOV     DPTR,#$LOCBX fopenA+23
   \   16B4  120000            LCALL   ?STO_R4567_DPTR_L20
   1092                  
   1093                      SetupReadSeq();  
   \   16B7  120000            LCALL   $REFFN SetupReadSeq
   1094                  
   1095                      endFound = 0;
   \   16BA  E4                CLR     A
   \   16BB  900000            MOV     DPTR,#$LOCBX fopenA+22
   \   16BE  F0                MOVX    @DPTR,A
   \   16BF            ?0308:
   1096                  
   1097                      while ((!endFound) && (readAddress < fileEnd)) {
   \   16BF  900000            MOV     DPTR,#$LOCBX fopenA+22
   \   16C2  E0                MOVX    A,@DPTR
   \   16C3  706F              JNZ     ?0307
   \   16C5  9000E4            MOV     DPTR,#readAddress
   \   16C8  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   16CB  900000            MOV     DPTR,#$LOCBX fopenA+23
   \   16CE  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   16D1  740A              MOV     A,#10
   \   16D3  120000            LCALL   ?L_CMP_L01
   \   16D6  705C              JNZ     ?0307
   \   16D8            ?0311:
   \   16D8            ?0310:
   \   16D8            ?0309:
   \   16D8            ?0313:
   1098                          while ((ReadFLASH() != 0xFF) && (readAddress < fileEnd)) {
   \   16D8  120000            LCALL   $REFFN ReadFLASH
   \   16DB  EC                MOV     A,R4
   \   16DC  04                INC     A
   \   16DD  6019              JZ      ?0312
   \   16DF  9000E4            MOV     DPTR,#readAddress
   \   16E2  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   16E5  900000            MOV     DPTR,#$LOCBX fopenA+23
   \   16E8  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   16EB  740A              MOV     A,#10
   \   16ED  120000            LCALL   ?L_CMP_L01
   \   16F0  7006              JNZ     ?0312
   \   16F2            ?0316:
   \   16F2            ?0315:
   \   16F2            ?0314:
   1099                              WDT = 1;
   \   16F2  D2AE              SETB    IE.6
   1100                              SWDT = 1;
   \   16F4  D2BE              SETB    IP.6
   \   16F6  80E0              SJMP    ?0313
   \   16F8            ?0312:
   1101                          }
   1102                          if (readAddress < fileEnd) {
   \   16F8  9000E4            MOV     DPTR,#readAddress
   \   16FB  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   16FE  900000            MOV     DPTR,#$LOCBX fopenA+23
   \   1701  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   1704  740A              MOV     A,#10
   \   1706  120000            LCALL   ?L_CMP_L01
   \   1709  7027              JNZ     ?0318
   \   170B            ?0317:
   1103                              for (i=0 ; (i<7) && (ReadFLASH() == 0xFF) ; i++);
   \   170B  E4                CLR     A
   \   170C  A3                INC     DPTR
   \   170D  F0                MOVX    @DPTR,A
   \   170E            ?0320:
   \   170E  900000            MOV     DPTR,#$LOCBX fopenA+27
   \   1711  E0                MOVX    A,@DPTR
   \   1712  24F9              ADD     A,#249
   \   1714  400F              JC      ?0319
   \   1716  120000            LCALL   $REFFN ReadFLASH
   \   1719  EC                MOV     A,R4
   \   171A  04                INC     A
   \   171B  7008              JNZ     ?0319
   \   171D            ?0323:
   \   171D            ?0322:
   \   171D            ?0321:
   \   171D  900000            MOV     DPTR,#$LOCBX fopenA+27
   \   1720  E0                MOVX    A,@DPTR
   \   1721  04                INC     A
   \   1722  F0                MOVX    @DPTR,A
   \   1723  80E9              SJMP    ?0320
   \   1725            ?0319:
   1104                              if (i == 7) endFound = 1;
   \   1725  900000            MOV     DPTR,#$LOCBX fopenA+27
   \   1728  E0                MOVX    A,@DPTR
   \   1729  B40706            CJNE    A,#7,?0326
   \   172C            ?0325:
   \   172C  7401              MOV     A,#1
   \   172E  900000            MOV     DPTR,#$LOCBX fopenA+22
   \   1731  F0                MOVX    @DPTR,A
   \   1732            ?0326:
   \   1732            ?0318:
   \   1732  808B              SJMP    ?0308
   \   1734            ?0307:
   1105                          }
   1106                      }
   1107          
   1108                      writeAddress = readAddress - 8;
   \   1734  9000E4            MOV     DPTR,#readAddress
   \   1737  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   173A  78F8              MOV     R0,#248
   \   173C  74FF              MOV     A,#255
   \   173E  F9                MOV     R1,A
   \   173F  FA                MOV     R2,A
   \   1740  FB                MOV     R3,A
   \   1741  120000            LCALL   ?L_ADD_L01
   1109                      tmpFile->offset = writeAddress - tmpFile->startAddress;
   \   1744  900000            MOV     DPTR,#$LOCBX fopenA
   \   1747  E0                MOVX    A,@DPTR
   \   1748  FB                MOV     R3,A
   \   1749  A3                INC     DPTR
   \   174A  E0                MOVX    A,@DPTR
   \   174B  FA                MOV     R2,A
   \   174C  A3                INC     DPTR
   \   174D  E0                MOVX    A,@DPTR
   \   174E  F9                MOV     R1,A
   \   174F  900000            MOV     DPTR,#writeAddress
   \   1752  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1755  90000D            MOV     DPTR,#13
   \   1758  120000            LCALL   ?LD_R4567_R123_DISP_L17
   \   175B  C3                CLR     C
   \   175C  E4                CLR     A
   \   175D  9C                SUBB    A,R4
   \   175E  FC                MOV     R4,A
   \   175F  E4                CLR     A
   \   1760  9D                SUBB    A,R5
   \   1761  FD                MOV     R5,A
   \   1762  E4                CLR     A
   \   1763  9E                SUBB    A,R6
   \   1764  FE                MOV     R6,A
   \   1765  E4                CLR     A
   \   1766  9F                SUBB    A,R7
   \   1767  FF                MOV     R7,A
   \   1768  900000            MOV     DPTR,#writeAddress
   \   176B  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   176E  120000            LCALL   ?L_ADD_L01
   \   1771  900000            MOV     DPTR,#$LOCBX fopenA
   \   1774  E0                MOVX    A,@DPTR
   \   1775  FB                MOV     R3,A
   \   1776  A3                INC     DPTR
   \   1777  E0                MOVX    A,@DPTR
   \   1778  FA                MOV     R2,A
   \   1779  A3                INC     DPTR
   \   177A  E0                MOVX    A,@DPTR
   \   177B  F9                MOV     R1,A
   \   177C  900015            MOV     DPTR,#21
   \   177F  120000            LCALL   ?ST_R4567_R123_DISP_L17
   1110                  } else {       
   \   1782  8049              SJMP    ?0327
   \   1784            ?0306:
   1111                      writeAddress = offset + tmpFile->startAddress;
   \   1784  900000            MOV     DPTR,#$LOCBX fopenA
   \   1787  E0                MOVX    A,@DPTR
   \   1788  FF                MOV     R7,A
   \   1789  A3                INC     DPTR
   \   178A  E0                MOVX    A,@DPTR
   \   178B  FE                MOV     R6,A
   \   178C  A3                INC     DPTR
   \   178D  E0                MOVX    A,@DPTR
   \   178E  FD                MOV     R5,A
   \   178F  90000D            MOV     DPTR,#13
   \   1792  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   1795  900000            MOV     DPTR,#$LOCBX fopenA+37
   \   1798  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   179B  120000            LCALL   ?L_ADD_L01
   1112                      readAddress  = writeAddress - 1;
   \   179E  900000            MOV     DPTR,#writeAddress
   \   17A1  120000            LCALL   ?STO_R4567_DPTR_L20
   \   17A4  74FF              MOV     A,#255
   \   17A6  F8                MOV     R0,A
   \   17A7  F9                MOV     R1,A
   \   17A8  FA                MOV     R2,A
   \   17A9  FB                MOV     R3,A
   \   17AA  120000            LCALL   ?L_ADD_L01
   \   17AD  9000E4            MOV     DPTR,#readAddress
   \   17B0  120000            LCALL   ?STO_R4567_DPTR_L20
   1113                      SetupReadSeq();
   \   17B3  120000            LCALL   $REFFN SetupReadSeq
   1114          //            ReadFLASH();
   1115                      tmpFile->offset = offset;
   \   17B6  900000            MOV     DPTR,#$LOCBX fopenA+37
   \   17B9  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   17BC  900000            MOV     DPTR,#$LOCBX fopenA
   \   17BF  E0                MOVX    A,@DPTR
   \   17C0  FB                MOV     R3,A
   \   17C1  A3                INC     DPTR
   \   17C2  E0                MOVX    A,@DPTR
   \   17C3  FA                MOV     R2,A
   \   17C4  A3                INC     DPTR
   \   17C5  E0                MOVX    A,@DPTR
   \   17C6  F9                MOV     R1,A
   \   17C7  900015            MOV     DPTR,#21
   \   17CA  120000            LCALL   ?ST_R4567_R123_DISP_L17
   \   17CD            ?0327:
   1116                  } 
   1117          
   1118          /*        myLong2HexStr(tmpFile->offset, msg);
   1119                  SendStringRS232("Offset: ");
   1120                  SendStringEOLRS232(msg);
   1121                   
   1122                  myLong2HexStr(tmpFile->startAddress, msg);
   1123                  SendStringRS232("Start address: ");
   1124                  SendStringEOLRS232(msg);
   1125           
   1126                  myLong2HexStr(writeAddress, msg);
   1127                  SendStringRS232("Write Address: ");
   1128                  SendStringEOLRS232(msg);
   1129          */
   1130              } else {
   \   17CD  8062              SJMP    ?0328
   \   17CF            ?0304:
   1131          /*    
   1132                  SendStringEOLRS232("New append file");
   1133                  SendStringEOLRS232(name);
   1134                  SendStringRS232("Size: ");
   1135                  myLong2HexStr(maxSize, msg);
   1136                  SendStringEOLRS232(msg);
   1137          */  
   1138                  writeAddress = tmpFile->startAddress;
   \   17CF  90000D            MOV     DPTR,#13
   \   17D2  120000            LCALL   ?LD_R4567_R123_DISP_L17
   \   17D5  900000            MOV     DPTR,#writeAddress
   \   17D8  120000            LCALL   ?STO_R4567_DPTR_L20
   1139                  
   1140                  WriteFileHead(name, maxSize);
   \   17DB  900000            MOV     DPTR,#$LOCBX fopenA+33
   \   17DE  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   17E1  900000            MOV     DPTR,#$PRMBX WriteFileHead+3
   \   17E4  120000            LCALL   ?STO_R4567_DPTR_L20
   \   17E7  900000            MOV     DPTR,#$LOCBX fopenA+30
   \   17EA  E0                MOVX    A,@DPTR
   \   17EB  FF                MOV     R7,A
   \   17EC  A3                INC     DPTR
   \   17ED  E0                MOVX    A,@DPTR
   \   17EE  FE                MOV     R6,A
   \   17EF  A3                INC     DPTR
   \   17F0  E0                MOVX    A,@DPTR
   \   17F1  FD                MOV     R5,A
   \   17F2  120000            LCALL   $REFFN WriteFileHead
   1141          
   1142                  tmpFile->length = maxSize;
   \   17F5  900000            MOV     DPTR,#$LOCBX fopenA+33
   \   17F8  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   17FB  900000            MOV     DPTR,#$LOCBX fopenA
   \   17FE  E0                MOVX    A,@DPTR
   \   17FF  FB                MOV     R3,A
   \   1800  A3                INC     DPTR
   \   1801  E0                MOVX    A,@DPTR
   \   1802  FA                MOV     R2,A
   \   1803  A3                INC     DPTR
   \   1804  E0                MOVX    A,@DPTR
   \   1805  F9                MOV     R1,A
   \   1806  900011            MOV     DPTR,#17
   \   1809  120000            LCALL   ?ST_R4567_R123_DISP_L17
   1143                  tmpFile->offset = 0;
   \   180C  E4                CLR     A
   \   180D  FC                MOV     R4,A
   \   180E  FD                MOV     R5,A
   \   180F  FE                MOV     R6,A
   \   1810  FF                MOV     R7,A
   \   1811  900015            MOV     DPTR,#21
   \   1814  120000            LCALL   ?ST_R4567_R123_DISP_L17
   1144                  tmpFile->write = 0;
   \   1817  EC                MOV     A,R4
   \   1818  900019            MOV     DPTR,#25
   \   181B  120000            LCALL   ?ST_A_R123_DISP_L17
   1145                  tmpFile->append = 1;
   \   181E  04                INC     A
   \   181F  90001A            MOV     DPTR,#26
   \   1822  120000            LCALL   ?ST_A_R123_DISP_L17
   1146          
   1147                  writeAddress = tmpFile->startAddress;
   \   1825  90000D            MOV     DPTR,#13
   \   1828  120000            LCALL   ?LD_R4567_R123_DISP_L17
   \   182B  900000            MOV     DPTR,#writeAddress
   \   182E  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1831            ?0328:
   1148              }        
   1149          
   1150              SetupWriteSeq();
   \   1831  120000            LCALL   $REFFN SetupWriteSeq
   1151              fs_currFilePtr = tmpFile;            
   \   1834  900000            MOV     DPTR,#$LOCBX fopenA
   \   1837  E0                MOVX    A,@DPTR
   \   1838  FF                MOV     R7,A
   \   1839  A3                INC     DPTR
   \   183A  E0                MOVX    A,@DPTR
   \   183B  FE                MOV     R6,A
   \   183C  A3                INC     DPTR
   \   183D  E0                MOVX    A,@DPTR
   \   183E  FD                MOV     R5,A
   \   183F  9000DE            MOV     DPTR,#fs_currFilePtr
   \   1842  EF                MOV     A,R7
   \   1843  F0                MOVX    @DPTR,A
   \   1844  A3                INC     DPTR
   \   1845  EE                MOV     A,R6
   \   1846  F0                MOVX    @DPTR,A
   \   1847  A3                INC     DPTR
   \   1848  ED                MOV     A,R5
   \   1849  F0                MOVX    @DPTR,A
   1152              writeInProgress = 1; 
   \   184A  7401              MOV     A,#1
   \   184C  9000EC            MOV     DPTR,#writeInProgress
   \   184F  F0                MOVX    @DPTR,A
   1153              
   1154              return tmpFile;
   \   1850  900000            MOV     DPTR,#$LOCBX fopenA
   \   1853  E0                MOVX    A,@DPTR
   \   1854  FF                MOV     R7,A
   \   1855  A3                INC     DPTR
   \   1856  E0                MOVX    A,@DPTR
   \   1857  FE                MOV     R6,A
   \   1858  A3                INC     DPTR
   \   1859  E0                MOVX    A,@DPTR
   \   185A  FD                MOV     R5,A
   1155          }
   \   185B            ?0329:
   \   185B  900000            MOV     DPTR,#$LOCBX fopenA+28
   \   185E  E0                MOVX    A,@DPTR
   \   185F  F8                MOV     R0,A
   \   1860  A3                INC     DPTR
   \   1861  E0                MOVX    A,@DPTR
   \   1862  C0E0              PUSH    ACC
   \   1864  E8                MOV     A,R0
   \   1865  C0E0              PUSH    ACC
   \   1867  22                RET
   1156          
   1157          
   1158          
   1159          void    WriteFileHead(const char* name, long size)
   1160          {
   \   1868            WriteFileHead:
   \   1868  900000            MOV     DPTR,#$LOCBX WriteFileHead+3
   \   186B  D0E0              POP     ACC
   \   186D  F0                MOVX    @DPTR,A
   \   186E  A3                INC     DPTR
   \   186F  D0E0              POP     ACC
   \   1871  F0                MOVX    @DPTR,A
   1161              xdata char    i, c, j;
   1162          
   1163              SetupSpareWriteSeq();
   \   1872  A3                INC     DPTR
   \   1873  EF                MOV     A,R7
   \   1874  F0                MOVX    @DPTR,A
   \   1875  A3                INC     DPTR
   \   1876  EE                MOV     A,R6
   \   1877  F0                MOVX    @DPTR,A
   \   1878  A3                INC     DPTR
   \   1879  ED                MOV     A,R5
   \   187A  F0                MOVX    @DPTR,A
   \   187B  120000            LCALL   $REFFN SetupSpareWriteSeq
   1164          
   1165              WriteFLASH(0xAA);                                   //Huvud
   \   187E  7CAA              MOV     R4,#170
   \   1880  120000            LCALL   $REFFN WriteFLASH
   1166              WriteFLASH((size >> 24) & 0xFF);         //Length MSB
   \   1883  900000            MOV     DPTR,#$LOCBX WriteFileHead+8
   \   1886  E0                MOVX    A,@DPTR
   \   1887  FC                MOV     R4,A
   \   1888  120000            LCALL   $REFFN WriteFLASH
   1167              WriteFLASH((size >> 16) & 0xFF);
   \   188B  900000            MOV     DPTR,#$LOCBX WriteFileHead+9
   \   188E  E0                MOVX    A,@DPTR
   \   188F  FC                MOV     R4,A
   \   1890  120000            LCALL   $REFFN WriteFLASH
   1168              WriteFLASH((size >> 8) & 0xFF);
   \   1893  900000            MOV     DPTR,#$LOCBX WriteFileHead+10
   \   1896  E0                MOVX    A,@DPTR
   \   1897  FC                MOV     R4,A
   \   1898  120000            LCALL   $REFFN WriteFLASH
   1169              WriteFLASH(size & 0xFF);                 //Length LSB
   1170           
   \   189B  900000            MOV     DPTR,#$LOCBX WriteFileHead+11
   \   189E  E0                MOVX    A,@DPTR
   \   189F  FC                MOV     R4,A
   \   18A0  120000            LCALL   $REFFN WriteFLASH
   1171              i = 0;                                                //Filtitel
   1172              j = 0;
   \   18A3  E4                CLR     A
   \   18A4  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   18A7  F0                MOVX    @DPTR,A
   \   18A8  A3                INC     DPTR
   \   18A9  A3                INC     DPTR
   \   18AA  F0                MOVX    @DPTR,A
   \   18AB            ?0331:
   1173              while(((c = name[j++]) != 0) && (c != '.') && (i < 8)) {
   \   18AB  900000            MOV     DPTR,#$LOCBX WriteFileHead+5
   \   18AE  E0                MOVX    A,@DPTR
   \   18AF  FF                MOV     R7,A
   \   18B0  A3                INC     DPTR
   \   18B1  E0                MOVX    A,@DPTR
   \   18B2  FE                MOV     R6,A
   \   18B3  A3                INC     DPTR
   \   18B4  E0                MOVX    A,@DPTR
   \   18B5  FD                MOV     R5,A
   \   18B6  900000            MOV     DPTR,#$LOCBX WriteFileHead+2
   \   18B9  E0                MOVX    A,@DPTR
   \   18BA  FC                MOV     R4,A
   \   18BB  04                INC     A
   \   18BC  F0                MOVX    @DPTR,A
   \   18BD  8C82              MOV     DPL,R4
   \   18BF  758300            MOV     DPH,#0
   \   18C2  120000            LCALL   ?LD_A_R567_DISP_L17
   \   18C5  900000            MOV     DPTR,#$LOCBX WriteFileHead+1
   \   18C8  F0                MOVX    @DPTR,A
   \   18C9  6017              JZ      ?0330
   \   18CB  642E              XRL     A,#46
   \   18CD  6013              JZ      ?0330
   \   18CF  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   18D2  E0                MOVX    A,@DPTR
   \   18D3  24F8              ADD     A,#248
   \   18D5  400B              JC      ?0330
   \   18D7            ?0334:
   \   18D7            ?0333:
   \   18D7            ?0332:
   1174                  i++;
   \   18D7  E0                MOVX    A,@DPTR
   \   18D8  04                INC     A
   \   18D9  F0                MOVX    @DPTR,A
   1175                  WriteFLASH(c);
   \   18DA  A3                INC     DPTR
   \   18DB  E0                MOVX    A,@DPTR
   \   18DC  FC                MOV     R4,A
   \   18DD  120000            LCALL   $REFFN WriteFLASH
   \   18E0  80C9              SJMP    ?0331
   \   18E2            ?0330:
   \   18E2            ?0336:
   1176              }
   1177              for ( ; i<8 ; i++) {
   \   18E2  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   18E5  E0                MOVX    A,@DPTR
   \   18E6  24F8              ADD     A,#248
   \   18E8  400D              JC      ?0335
   \   18EA            ?0337:
   1178                  WriteFLASH(0);
   \   18EA  7C00              MOV     R4,#0
   \   18EC  120000            LCALL   $REFFN WriteFLASH
   \   18EF  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   18F2  E0                MOVX    A,@DPTR
   \   18F3  04                INC     A
   \   18F4  F0                MOVX    @DPTR,A
   \   18F5  80EB              SJMP    ?0336
   \   18F7            ?0335:
   1179              }
   1180              if (c != 0) {                                             //Filext
   \   18F7  A3                INC     DPTR
   \   18F8  E0                MOVX    A,@DPTR
   \   18F9  6036              JZ      ?0340
   \   18FB            ?0339:
   1181                  i = 9; 
   \   18FB  7409              MOV     A,#9
   \   18FD  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   1900  F0                MOVX    @DPTR,A
   \   1901            ?0342:
   1182                  while(((c = name[j++]) != 0) && (i < 12)) {
   \   1901  900000            MOV     DPTR,#$LOCBX WriteFileHead+5
   \   1904  E0                MOVX    A,@DPTR
   \   1905  FF                MOV     R7,A
   \   1906  A3                INC     DPTR
   \   1907  E0                MOVX    A,@DPTR
   \   1908  FE                MOV     R6,A
   \   1909  A3                INC     DPTR
   \   190A  E0                MOVX    A,@DPTR
   \   190B  FD                MOV     R5,A
   \   190C  900000            MOV     DPTR,#$LOCBX WriteFileHead+2
   \   190F  E0                MOVX    A,@DPTR
   \   1910  FC                MOV     R4,A
   \   1911  04                INC     A
   \   1912  F0                MOVX    @DPTR,A
   \   1913  8C82              MOV     DPL,R4
   \   1915  758300            MOV     DPH,#0
   \   1918  120000            LCALL   ?LD_A_R567_DISP_L17
   \   191B  900000            MOV     DPTR,#$LOCBX WriteFileHead+1
   \   191E  F0                MOVX    @DPTR,A
   \   191F  6010              JZ      ?0341
   \   1921  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   1924  E0                MOVX    A,@DPTR
   \   1925  24F4              ADD     A,#244
   \   1927  4008              JC      ?0341
   \   1929            ?0345:
   \   1929            ?0344:
   \   1929            ?0343:
   1183                      WriteFLASH(c);
   \   1929  A3                INC     DPTR
   \   192A  E0                MOVX    A,@DPTR
   \   192B  FC                MOV     R4,A
   \   192C  120000            LCALL   $REFFN WriteFLASH
   1184                  }
   1185              }
   \   192F  80D0              SJMP    ?0342
   \   1931            ?0341:
   \   1931            ?0340:
   \   1931            ?0347:
   1186              for ( ; i<12 ; i++) {
   \   1931  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   1934  E0                MOVX    A,@DPTR
   \   1935  24F4              ADD     A,#244
   \   1937  400D              JC      ?0346
   \   1939            ?0348:
   1187                  WriteFLASH(0);
   \   1939  7C00              MOV     R4,#0
   \   193B  120000            LCALL   $REFFN WriteFLASH
   \   193E  900000            MOV     DPTR,#$LOCBX WriteFileHead
   \   1941  E0                MOVX    A,@DPTR
   \   1942  04                INC     A
   \   1943  F0                MOVX    @DPTR,A
   \   1944  80EB              SJMP    ?0347
   \   1946            ?0346:
   1188              }
   1189              PerformWriteSeq();
   \   1946  120000            LCALL   $REFFN PerformWriteSeq
   1190              TerminateWriteSeq();
   \   1949  120000            LCALL   $REFFN TerminateWriteSeq
   1191          }    
   \   194C  900000            MOV     DPTR,#$LOCBX WriteFileHead+3
   \   194F  E0                MOVX    A,@DPTR
   \   1950  F8                MOV     R0,A
   \   1951  A3                INC     DPTR
   \   1952  E0                MOVX    A,@DPTR
   \   1953  C0E0              PUSH    ACC
   \   1955  E8                MOV     A,R0
   \   1956  C0E0              PUSH    ACC
   \   1958  22                RET
   1192              
   1193              
   1194          
   1195          void    StartDynamic( void )
   1196          {
   \   1959            StartDynamic:
   \   1959  900000            MOV     DPTR,#$LOCBX StartDynamic+36
   \   195C  D0E0              POP     ACC
   \   195E  F0                MOVX    @DPTR,A
   \   195F  A3                INC     DPTR
   \   1960  D0E0              POP     ACC
   \   1962  F0                MOVX    @DPTR,A
   1197              xdata FILE_HEAD   fh;
   1198              xdata FILE*       fp;
   1199              xdata long        lastStart;
   1200              xdata long        lastLength;
   1201              xdata long        dynamicBreak;
   1202              xdata long        breakLen;
   1203              
   1204              fs_currFilePtr = NULL;
   \   1963  9000DE            MOV     DPTR,#fs_currFilePtr
   \   1966  E4                CLR     A
   \   1967  F0                MOVX    @DPTR,A
   \   1968  A3                INC     DPTR
   \   1969  F0                MOVX    @DPTR,A
   \   196A  A3                INC     DPTR
   \   196B  F0                MOVX    @DPTR,A
   1205              readAddress = 0;
   \   196C  9000E4            MOV     DPTR,#readAddress
   \   196F  F0                MOVX    @DPTR,A
   \   1970  A3                INC     DPTR
   \   1971  F0                MOVX    @DPTR,A
   \   1972  A3                INC     DPTR
   \   1973  F0                MOVX    @DPTR,A
   \   1974  A3                INC     DPTR
   \   1975  F0                MOVX    @DPTR,A
   1206              lastStart = 0;
   \   1976  900000            MOV     DPTR,#$LOCBX StartDynamic+20
   \   1979  F0                MOVX    @DPTR,A
   \   197A  A3                INC     DPTR
   \   197B  F0                MOVX    @DPTR,A
   \   197C  A3                INC     DPTR
   \   197D  F0                MOVX    @DPTR,A
   \   197E  A3                INC     DPTR
   \   197F  F0                MOVX    @DPTR,A
   \   1980            ?0351:
   1207                  
   1208                  
   1209              while (GetFileHead(&fh)) {
   \   1980  7D00              MOV     R5,#LOW $LOCBX StartDynamic
   \   1982  7E00              MOV     R6,#HIGH $LOCBX StartDynamic
   \   1984  7F01              MOV     R7,#1
   \   1986  120000            LCALL   $REFFN GetFileHead
   \   1989  EC                MOV     A,R4
   \   198A  6066              JZ      ?0350
   \   198C            ?0352:
   1210                  lastStart = readAddress;
   \   198C  9000E4            MOV     DPTR,#readAddress
   \   198F  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1992  900000            MOV     DPTR,#$LOCBX StartDynamic+20
   \   1995  120000            LCALL   ?STO_R4567_DPTR_L20
   1211                  lastLength = fh.length;
   \   1998  900000            MOV     DPTR,#$LOCBX StartDynamic
   \   199B  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   199E  900000            MOV     DPTR,#$LOCBX StartDynamic+24
   \   19A1  120000            LCALL   ?STO_R4567_DPTR_L20
   1212                  readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   19A4  900000            MOV     DPTR,#$LOCBX StartDynamic
   \   19A7  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   19AA  E4                CLR     A
   \   19AB  F8                MOV     R0,A
   \   19AC  74FE              MOV     A,#254
   \   19AE  F9                MOV     R1,A
   \   19AF  04                INC     A
   \   19B0  FA                MOV     R2,A
   \   19B1  FB                MOV     R3,A
   \   19B2  120000            LCALL   ?L_AND_L01
   \   19B5  E4                CLR     A
   \   19B6  F8                MOV     R0,A
   \   19B7  FA                MOV     R2,A
   \   19B8  FB                MOV     R3,A
   \   19B9  7902              MOV     R1,#2
   \   19BB  120000            LCALL   ?L_ADD_L01
   \   19BE  EF                MOV     A,R7
   \   19BF  C0E0              PUSH    ACC
   \   19C1  EE                MOV     A,R6
   \   19C2  C0E0              PUSH    ACC
   \   19C4  ED                MOV     A,R5
   \   19C5  C0E0              PUSH    ACC
   \   19C7  EC                MOV     A,R4
   \   19C8  C0E0              PUSH    ACC
   \   19CA  9000E4            MOV     DPTR,#readAddress
   \   19CD  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   19D0  E4                CLR     A
   \   19D1  F8                MOV     R0,A
   \   19D2  74FE              MOV     A,#254
   \   19D4  F9                MOV     R1,A
   \   19D5  04                INC     A
   \   19D6  FA                MOV     R2,A
   \   19D7  FB                MOV     R3,A
   \   19D8  120000            LCALL   ?L_AND_L01
   \   19DB  D0E0              POP     ACC
   \   19DD  F8                MOV     R0,A
   \   19DE  D0E0              POP     ACC
   \   19E0  F9                MOV     R1,A
   \   19E1  D0E0              POP     ACC
   \   19E3  FA                MOV     R2,A
   \   19E4  D0E0              POP     ACC
   \   19E6  FB                MOV     R3,A
   \   19E7  120000            LCALL   ?L_ADD_L01
   \   19EA  9000E4            MOV     DPTR,#readAddress
   \   19ED  120000            LCALL   ?STO_R4567_DPTR_L20
   \   19F0  808E              SJMP    ?0351
   \   19F2            ?0350:
   1213                  
   1214              }
   1215              dynamicBreak = ((lastStart + lastLength) & 0xFFFFE000) + 0x2000;
   \   19F2  900000            MOV     DPTR,#$LOCBX StartDynamic+20
   \   19F5  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   19F8  A3                INC     DPTR
   \   19F9  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   19FC  120000            LCALL   ?L_ADD_L01
   \   19FF  E4                CLR     A
   \   1A00  F8                MOV     R0,A
   \   1A01  79E0              MOV     R1,#224
   \   1A03  14                DEC     A
   \   1A04  FA                MOV     R2,A
   \   1A05  FB                MOV     R3,A
   \   1A06  120000            LCALL   ?L_AND_L01
   \   1A09  E4                CLR     A
   \   1A0A  F8                MOV     R0,A
   \   1A0B  FA                MOV     R2,A
   \   1A0C  FB                MOV     R3,A
   \   1A0D  7920              MOV     R1,#32
   \   1A0F  120000            LCALL   ?L_ADD_L01
   1216              breakLen = dynamicBreak - lastStart;
   \   1A12  A3                INC     DPTR
   \   1A13  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1A16  900000            MOV     DPTR,#$LOCBX StartDynamic+20
   \   1A19  120000            LCALL   ?LD_R0123_XDPTR_L20
   \   1A1C  120000            LCALL   ?L_SUB_L01
   1217          
   1218          //    SendStringRS232("Creating file with size: ");
   1219          //    myLong2HexStr(breakLen, msg);
   1220          //    SendStringEOLRS232(msg);
   1221           
   1222              fp = fopenA("StrtDymk.xxx", breakLen, -1);
   \   1A1F  900000            MOV     DPTR,#$LOCBX StartDynamic+32
   \   1A22  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1A25  900000            MOV     DPTR,#$PRMBX fopenA+7
   \   1A28  74FF              MOV     A,#255
   \   1A2A  F0                MOVX    @DPTR,A
   \   1A2B  A3                INC     DPTR
   \   1A2C  F0                MOVX    @DPTR,A
   \   1A2D  A3                INC     DPTR
   \   1A2E  F0                MOVX    @DPTR,A
   \   1A2F  A3                INC     DPTR
   \   1A30  F0                MOVX    @DPTR,A
   \   1A31  900000            MOV     DPTR,#$PRMBX fopenA+3
   \   1A34  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1A37  7D07              MOV     R5,#LOW(?0353)
   \   1A39  7E00              MOV     R6,#HIGH(?0353)
   \   1A3B  7F02              MOV     R7,#2
   \   1A3D  120000            LCALL   $REFFN fopenA
   1223              if (!fp) {
   \   1A40  900000            MOV     DPTR,#$LOCBX StartDynamic+17
   \   1A43  EF                MOV     A,R7
   \   1A44  F0                MOVX    @DPTR,A
   \   1A45  A3                INC     DPTR
   \   1A46  EE                MOV     A,R6
   \   1A47  F0                MOVX    @DPTR,A
   \   1A48  A3                INC     DPTR
   \   1A49  ED                MOV     A,R5
   \   1A4A  F0                MOVX    @DPTR,A
   \   1A4B  4E                ORL     A,R6
   \   1A4C  700B              JNZ     ?0355
   \   1A4E            ?0354:
   1224                  SendStringEOLRS232("Could not create dynamic break");
   \   1A4E  7D14              MOV     R5,#LOW(?0356)
   \   1A50  7E00              MOV     R6,#HIGH(?0356)
   \   1A52  7F02              MOV     R7,#2
   \   1A54  120000            LCALL   $REFFN SendStringEOLRS232
   1225              } else {
   \   1A57  8013              SJMP    ?0357
   \   1A59            ?0355:
   1226                  fputc(fp, 'A');
   \   1A59  7C41              MOV     R4,#65
   \   1A5B  120000            LCALL   $REFFN fputc
   1227                  fclose(fp);
   \   1A5E  900000            MOV     DPTR,#$LOCBX StartDynamic+17
   \   1A61  E0                MOVX    A,@DPTR
   \   1A62  FF                MOV     R7,A
   \   1A63  A3                INC     DPTR
   \   1A64  E0                MOVX    A,@DPTR
   \   1A65  FE                MOV     R6,A
   \   1A66  A3                INC     DPTR
   \   1A67  E0                MOVX    A,@DPTR
   \   1A68  FD                MOV     R5,A
   \   1A69  120000            LCALL   $REFFN fclose
   \   1A6C            ?0357:
   1228              }
   1229          }
   \   1A6C  900000            MOV     DPTR,#$LOCBX StartDynamic+36
   \   1A6F  E0                MOVX    A,@DPTR
   \   1A70  F8                MOV     R0,A
   \   1A71  A3                INC     DPTR
   \   1A72  E0                MOVX    A,@DPTR
   \   1A73  C0E0              PUSH    ACC
   \   1A75  E8                MOV     A,R0
   \   1A76  C0E0              PUSH    ACC
   \   1A78  22                RET
   1230          
   1231          void    EraseDynamic( void )
   1232          {    
   \   1A79            EraseDynamic:
   \   1A79  900000            MOV     DPTR,#$LOCBX EraseDynamic+3
   \   1A7C  D0E0              POP     ACC
   \   1A7E  F0                MOVX    @DPTR,A
   \   1A7F  A3                INC     DPTR
   \   1A80  D0E0              POP     ACC
   \   1A82  F0                MOVX    @DPTR,A
   1233              xdata FILE*   fp;
   1234              
   1235              fp = fopen("StrtDymk.xxx", "r");
   \   1A83  7F02              MOV     R7,#2
   \   1A85  900000            MOV     DPTR,#$PRMBX fopen+3
   \   1A88  EF                MOV     A,R7
   \   1A89  F0                MOVX    @DPTR,A
   \   1A8A  A3                INC     DPTR
   \   1A8B  7400              MOV     A,#HIGH(?0258)
   \   1A8D  F0                MOVX    @DPTR,A
   \   1A8E  A3                INC     DPTR
   \   1A8F  7402              MOV     A,#LOW(?0258)
   \   1A91  F0                MOVX    @DPTR,A
   \   1A92  7D07              MOV     R5,#LOW(?0353)
   \   1A94  7E00              MOV     R6,#HIGH(?0353)
   \   1A96  120000            LCALL   $REFFN fopen
   1236              if (fp) {
   \   1A99  900000            MOV     DPTR,#$LOCBX EraseDynamic
   \   1A9C  EF                MOV     A,R7
   \   1A9D  F0                MOVX    @DPTR,A
   \   1A9E  A3                INC     DPTR
   \   1A9F  EE                MOV     A,R6
   \   1AA0  F0                MOVX    @DPTR,A
   \   1AA1  A3                INC     DPTR
   \   1AA2  ED                MOV     A,R5
   \   1AA3  F0                MOVX    @DPTR,A
   \   1AA4  4E                ORL     A,R6
   \   1AA5  6065              JZ      ?0359
   \   1AA7            ?0358:
   1237                  eraseAddress = fp->startAddress + fp->length;
   \   1AA7  900011            MOV     DPTR,#17
   \   1AAA  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   1AAD  EB                MOV     A,R3
   \   1AAE  C0E0              PUSH    ACC
   \   1AB0  EA                MOV     A,R2
   \   1AB1  C0E0              PUSH    ACC
   \   1AB3  E9                MOV     A,R1
   \   1AB4  C0E0              PUSH    ACC
   \   1AB6  E8                MOV     A,R0
   \   1AB7  C0E0              PUSH    ACC
   \   1AB9  90000D            MOV     DPTR,#13
   \   1ABC  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   1ABF  D0E0              POP     ACC
   \   1AC1  FC                MOV     R4,A
   \   1AC2  D0E0              POP     ACC
   \   1AC4  FD                MOV     R5,A
   \   1AC5  D0E0              POP     ACC
   \   1AC7  FE                MOV     R6,A
   \   1AC8  D0E0              POP     ACC
   \   1ACA  FF                MOV     R7,A
   \   1ACB  120000            LCALL   ?L_ADD_L01
   \   1ACE  9000E8            MOV     DPTR,#eraseAddress
   \   1AD1  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1AD4            ?0361:
   1238                  for ( ; eraseAddress < 0x800000 ; eraseAddress += 0x2000) {
   \   1AD4  9000E8            MOV     DPTR,#eraseAddress
   \   1AD7  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1ADA  E4                CLR     A
   \   1ADB  F8                MOV     R0,A
   \   1ADC  F9                MOV     R1,A
   \   1ADD  FB                MOV     R3,A
   \   1ADE  7A80              MOV     R2,#128
   \   1AE0  740A              MOV     A,#10
   \   1AE2  120000            LCALL   ?L_CMP_L01
   \   1AE5  7017              JNZ     ?0360
   \   1AE7            ?0362:
   1239                      FLASHKey = 0xAA;
   \   1AE7  74AA              MOV     A,#170
   \   1AE9  9000E1            MOV     DPTR,#FLASHKey
   \   1AEC  F0                MOVX    @DPTR,A
   1240                      EraseBlock();
   \   1AED  120000            LCALL   $REFFN EraseBlock
   \   1AF0  9000E8            MOV     DPTR,#eraseAddress
   \   1AF3  E4                CLR     A
   \   1AF4  FC                MOV     R4,A
   \   1AF5  FE                MOV     R6,A
   \   1AF6  FF                MOV     R7,A
   \   1AF7  7D20              MOV     R5,#32
   \   1AF9  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
   \   1AFC  80D6              SJMP    ?0361
   \   1AFE            ?0360:
   1241                  }
   1242                  fclose(fp);
   \   1AFE  900000            MOV     DPTR,#$LOCBX EraseDynamic
   \   1B01  E0                MOVX    A,@DPTR
   \   1B02  FF                MOV     R7,A
   \   1B03  A3                INC     DPTR
   \   1B04  E0                MOVX    A,@DPTR
   \   1B05  FE                MOV     R6,A
   \   1B06  A3                INC     DPTR
   \   1B07  E0                MOVX    A,@DPTR
   \   1B08  FD                MOV     R5,A
   \   1B09  120000            LCALL   $REFFN fclose
   \   1B0C            ?0359:
   1243              }
   1244          }    
   \   1B0C  900000            MOV     DPTR,#$LOCBX EraseDynamic+3
   \   1B0F  E0                MOVX    A,@DPTR
   \   1B10  F8                MOV     R0,A
   \   1B11  A3                INC     DPTR
   \   1B12  E0                MOVX    A,@DPTR
   \   1B13  C0E0              PUSH    ACC
   \   1B15  E8                MOV     A,R0
   \   1B16  C0E0              PUSH    ACC
   \   1B18  22                RET
   1245          
   1246          void    EraseAll( void )
   1247          {
   \   1B19            EraseAll:
   \   1B19  900000            MOV     DPTR,#$LOCBX EraseAll
   \   1B1C  D0E0              POP     ACC
   \   1B1E  F0                MOVX    @DPTR,A
   \   1B1F  A3                INC     DPTR
   \   1B20  D0E0              POP     ACC
   \   1B22  F0                MOVX    @DPTR,A
   1248              for (eraseAddress = 10 ; eraseAddress < 0x800000 ; eraseAddress += 0x2000){
   \   1B23  9000E8            MOV     DPTR,#eraseAddress
   \   1B26  E4                CLR     A
   \   1B27  F0                MOVX    @DPTR,A
   \   1B28  A3                INC     DPTR
   \   1B29  F0                MOVX    @DPTR,A
   \   1B2A  A3                INC     DPTR
   \   1B2B  F0                MOVX    @DPTR,A
   \   1B2C  A3                INC     DPTR
   \   1B2D  740A              MOV     A,#10
   \   1B2F  F0                MOVX    @DPTR,A
   \   1B30            ?0365:
   \   1B30  9000E8            MOV     DPTR,#eraseAddress
   \   1B33  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1B36  E4                CLR     A
   \   1B37  F8                MOV     R0,A
   \   1B38  F9                MOV     R1,A
   \   1B39  FB                MOV     R3,A
   \   1B3A  7A80              MOV     R2,#128
   \   1B3C  740A              MOV     A,#10
   \   1B3E  120000            LCALL   ?L_CMP_L01
   \   1B41  7017              JNZ     ?0364
   \   1B43            ?0366:
   1249                  FLASHKey = 0xAA;
   \   1B43  74AA              MOV     A,#170
   \   1B45  9000E1            MOV     DPTR,#FLASHKey
   \   1B48  F0                MOVX    @DPTR,A
   1250                  EraseBlock();
   \   1B49  120000            LCALL   $REFFN EraseBlock
   1251              }
   \   1B4C  9000E8            MOV     DPTR,#eraseAddress
   \   1B4F  E4                CLR     A
   \   1B50  FC                MOV     R4,A
   \   1B51  FE                MOV     R6,A
   \   1B52  FF                MOV     R7,A
   \   1B53  7D20              MOV     R5,#32
   \   1B55  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
   1252          }
   \   1B58  80D6              SJMP    ?0365
   \   1B5A            ?0364:
   \   1B5A  900000            MOV     DPTR,#$LOCBX EraseAll
   \   1B5D  E0                MOVX    A,@DPTR
   \   1B5E  F8                MOV     R0,A
   \   1B5F  A3                INC     DPTR
   \   1B60  E0                MOVX    A,@DPTR
   \   1B61  C0E0              PUSH    ACC
   \   1B63  E8                MOV     A,R0
   \   1B64  C0E0              PUSH    ACC
   \   1B66  22                RET
   1253          
   1254          
   1255          
   1256          void TypeA( void )
   1257          {
   \   1B67            TypeA:
   \   1B67  900000            MOV     DPTR,#$LOCBX TypeA+8
   \   1B6A  D0E0              POP     ACC
   \   1B6C  F0                MOVX    @DPTR,A
   \   1B6D  A3                INC     DPTR
   \   1B6E  D0E0              POP     ACC
   \   1B70  F0                MOVX    @DPTR,A
   1258              xdata FILE*   fp;
   1259              xdata long    i;
   1260              xdata char    c;
   1261              
   1262              fp = fopen(commandLine[1], "r");
   \   1B71  7F02              MOV     R7,#2
   \   1B73  900000            MOV     DPTR,#$PRMBX fopen+3
   \   1B76  EF                MOV     A,R7
   \   1B77  F0                MOVX    @DPTR,A
   \   1B78  A3                INC     DPTR
   \   1B79  7400              MOV     A,#HIGH(?0258)
   \   1B7B  F0                MOVX    @DPTR,A
   \   1B7C  A3                INC     DPTR
   \   1B7D  7402              MOV     A,#LOW(?0258)
   \   1B7F  F0                MOVX    @DPTR,A
   \   1B80  7D10              MOV     R5,#LOW(commandLine+16)
   \   1B82  7E00              MOV     R6,#HIGH(commandLine+16)
   \   1B84  1F                DEC     R7
   \   1B85  120000            LCALL   $REFFN fopen
   1263              if (fp) {
   \   1B88  900000            MOV     DPTR,#$LOCBX TypeA
   \   1B8B  EF                MOV     A,R7
   \   1B8C  F0                MOVX    @DPTR,A
   \   1B8D  A3                INC     DPTR
   \   1B8E  EE                MOV     A,R6
   \   1B8F  F0                MOVX    @DPTR,A
   \   1B90  A3                INC     DPTR
   \   1B91  ED                MOV     A,R5
   \   1B92  F0                MOVX    @DPTR,A
   \   1B93  4E                ORL     A,R6
   \   1B94  607B              JZ      ?0369
   \   1B96            ?0368:
   1264                  for (i=0 ; i<fp->length ; i++) {
   \   1B96  A3                INC     DPTR
   \   1B97  E4                CLR     A
   \   1B98  F0                MOVX    @DPTR,A
   \   1B99  A3                INC     DPTR
   \   1B9A  F0                MOVX    @DPTR,A
   \   1B9B  A3                INC     DPTR
   \   1B9C  F0                MOVX    @DPTR,A
   \   1B9D  A3                INC     DPTR
   \   1B9E  F0                MOVX    @DPTR,A
   \   1B9F            ?0371:
   \   1B9F  900000            MOV     DPTR,#$LOCBX TypeA
   \   1BA2  E0                MOVX    A,@DPTR
   \   1BA3  FF                MOV     R7,A
   \   1BA4  A3                INC     DPTR
   \   1BA5  E0                MOVX    A,@DPTR
   \   1BA6  FE                MOV     R6,A
   \   1BA7  A3                INC     DPTR
   \   1BA8  E0                MOVX    A,@DPTR
   \   1BA9  FD                MOV     R5,A
   \   1BAA  900011            MOV     DPTR,#17
   \   1BAD  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   1BB0  900000            MOV     DPTR,#$LOCBX TypeA+3
   \   1BB3  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1BB6  740B              MOV     A,#11
   \   1BB8  120000            LCALL   ?L_CMP_L01
   \   1BBB  7044              JNZ     ?0370
   \   1BBD            ?0372:
   1265                      c = fgetc(fp);
   \   1BBD  900000            MOV     DPTR,#$LOCBX TypeA
   \   1BC0  E0                MOVX    A,@DPTR
   \   1BC1  FF                MOV     R7,A
   \   1BC2  A3                INC     DPTR
   \   1BC3  E0                MOVX    A,@DPTR
   \   1BC4  FE                MOV     R6,A
   \   1BC5  A3                INC     DPTR
   \   1BC6  E0                MOVX    A,@DPTR
   \   1BC7  FD                MOV     R5,A
   \   1BC8  120000            LCALL   $REFFN fgetc
   1266                      if (c == 0xFF) {
   \   1BCB  EC                MOV     A,R4
   \   1BCC  900000            MOV     DPTR,#$LOCBX TypeA+7
   \   1BCF  F0                MOVX    @DPTR,A
   \   1BD0  04                INC     A
   \   1BD1  7019              JNZ     ?0375
   \   1BD3            ?0374:
   1267                          i = fp->length;
   \   1BD3  900000            MOV     DPTR,#$LOCBX TypeA
   \   1BD6  E0                MOVX    A,@DPTR
   \   1BD7  FF                MOV     R7,A
   \   1BD8  A3                INC     DPTR
   \   1BD9  E0                MOVX    A,@DPTR
   \   1BDA  FE                MOV     R6,A
   \   1BDB  A3                INC     DPTR
   \   1BDC  E0                MOVX    A,@DPTR
   \   1BDD  FD                MOV     R5,A
   \   1BDE  900011            MOV     DPTR,#17
   \   1BE1  120000            LCALL   ?LD_R0123_R567_DISP_L17
   \   1BE4  900000            MOV     DPTR,#$LOCBX TypeA+3
   \   1BE7  120000            LCALL   ?STO_R0123_DPTR_L20
   1268                      } else {
   \   1BEA  8003              SJMP    ?0376
   \   1BEC            ?0375:
   1269                          SendRS232(c);
   \   1BEC  120000            LCALL   $REFFN SendRS232
   \   1BEF            ?0376:
   1270                      }
   1271                      WDT = 1;
   \   1BEF  D2AE              SETB    IE.6
   1272                      SWDT = 1;
   \   1BF1  D2BE              SETB    IP.6
   \   1BF3  900000            MOV     DPTR,#$LOCBX TypeA+3
   \   1BF6  E4                CLR     A
   \   1BF7  FD                MOV     R5,A
   \   1BF8  FE                MOV     R6,A
   \   1BF9  FF                MOV     R7,A
   \   1BFA  04                INC     A
   \   1BFB  FC                MOV     R4,A
   \   1BFC  120000            LCALL   ?L_ADD_ASG_DPTR_R4567_L01
   \   1BFF  809E              SJMP    ?0371
   \   1C01            ?0370:
   1273                  }
   1274                  fclose(fp);
   \   1C01  900000            MOV     DPTR,#$LOCBX TypeA
   \   1C04  E0                MOVX    A,@DPTR
   \   1C05  FF                MOV     R7,A
   \   1C06  A3                INC     DPTR
   \   1C07  E0                MOVX    A,@DPTR
   \   1C08  FE                MOV     R6,A
   \   1C09  A3                INC     DPTR
   \   1C0A  E0                MOVX    A,@DPTR
   \   1C0B  FD                MOV     R5,A
   \   1C0C  120000            LCALL   $REFFN fclose
   1275              } else {
   \   1C0F  8009              SJMP    ?0377
   \   1C11            ?0369:
   1276                  SendStringEOLRS232("Unable to open file");
   \   1C11  7D33              MOV     R5,#LOW(?0378)
   \   1C13  7E00              MOV     R6,#HIGH(?0378)
   \   1C15  7F02              MOV     R7,#2
   \   1C17  120000            LCALL   $REFFN SendStringEOLRS232
   \   1C1A            ?0377:
   1277              }
   1278          }
   \   1C1A  900000            MOV     DPTR,#$LOCBX TypeA+8
   \   1C1D  E0                MOVX    A,@DPTR
   \   1C1E  F8                MOV     R0,A
   \   1C1F  A3                INC     DPTR
   \   1C20  E0                MOVX    A,@DPTR
   \   1C21  C0E0              PUSH    ACC
   \   1C23  E8                MOV     A,R0
   \   1C24  C0E0              PUSH    ACC
   \   1C26  22                RET
   1279          
   1280          
   1281          char MemUsage( void )
   1282          //Retunerar 0 till 16 som andel av använt minne, dvs 0 = inget minne använt, 16 = minnet fullt
   1283          {
   \   1C27            MemUsage:
   \   1C27  900000            MOV     DPTR,#$LOCBX MemUsage+17
   \   1C2A  D0E0              POP     ACC
   \   1C2C  F0                MOVX    @DPTR,A
   \   1C2D  A3                INC     DPTR
   \   1C2E  D0E0              POP     ACC
   \   1C30  F0                MOVX    @DPTR,A
   1284              xdata FILE_HEAD   fh;
   1285              
   1286              readAddress = 0;
   \   1C31  9000E4            MOV     DPTR,#readAddress
   \   1C34  E4                CLR     A
   \   1C35  F0                MOVX    @DPTR,A
   \   1C36  A3                INC     DPTR
   \   1C37  F0                MOVX    @DPTR,A
   \   1C38  A3                INC     DPTR
   \   1C39  F0                MOVX    @DPTR,A
   \   1C3A  A3                INC     DPTR
   \   1C3B  F0                MOVX    @DPTR,A
   \   1C3C            ?0380:
   1287                  
   1288              while (GetFileHead(&fh)) {
   \   1C3C  7D00              MOV     R5,#LOW $LOCBX MemUsage
   \   1C3E  7E00              MOV     R6,#HIGH $LOCBX MemUsage
   \   1C40  7F01              MOV     R7,#1
   \   1C42  120000            LCALL   $REFFN GetFileHead
   \   1C45  EC                MOV     A,R4
   \   1C46  604E              JZ      ?0379
   \   1C48            ?0381:
   1289                  readAddress = (readAddress & 0xFFFFFE00) + ((fh.length & 0xFFFFFE00) + 0x200);
   \   1C48  900000            MOV     DPTR,#$LOCBX MemUsage
   \   1C4B  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1C4E  E4                CLR     A
   \   1C4F  F8                MOV     R0,A
   \   1C50  74FE              MOV     A,#254
   \   1C52  F9                MOV     R1,A
   \   1C53  04                INC     A
   \   1C54  FA                MOV     R2,A
   \   1C55  FB                MOV     R3,A
   \   1C56  120000            LCALL   ?L_AND_L01
   \   1C59  E4                CLR     A
   \   1C5A  F8                MOV     R0,A
   \   1C5B  FA                MOV     R2,A
   \   1C5C  FB                MOV     R3,A
   \   1C5D  7902              MOV     R1,#2
   \   1C5F  120000            LCALL   ?L_ADD_L01
   \   1C62  EF                MOV     A,R7
   \   1C63  C0E0              PUSH    ACC
   \   1C65  EE                MOV     A,R6
   \   1C66  C0E0              PUSH    ACC
   \   1C68  ED                MOV     A,R5
   \   1C69  C0E0              PUSH    ACC
   \   1C6B  EC                MOV     A,R4
   \   1C6C  C0E0              PUSH    ACC
   \   1C6E  9000E4            MOV     DPTR,#readAddress
   \   1C71  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1C74  E4                CLR     A
   \   1C75  F8                MOV     R0,A
   \   1C76  74FE              MOV     A,#254
   \   1C78  F9                MOV     R1,A
   \   1C79  04                INC     A
   \   1C7A  FA                MOV     R2,A
   \   1C7B  FB                MOV     R3,A
   \   1C7C  120000            LCALL   ?L_AND_L01
   \   1C7F  D0E0              POP     ACC
   \   1C81  F8                MOV     R0,A
   \   1C82  D0E0              POP     ACC
   \   1C84  F9                MOV     R1,A
   \   1C85  D0E0              POP     ACC
   \   1C87  FA                MOV     R2,A
   \   1C88  D0E0              POP     ACC
   \   1C8A  FB                MOV     R3,A
   \   1C8B  120000            LCALL   ?L_ADD_L01
   \   1C8E  9000E4            MOV     DPTR,#readAddress
   \   1C91  120000            LCALL   ?STO_R4567_DPTR_L20
   \   1C94  80A6              SJMP    ?0380
   \   1C96            ?0379:
   1290              }
   1291              
   1292              return (readAddress >> 19) & 0xF;
   \   1C96  9000E4            MOV     DPTR,#readAddress
   \   1C99  120000            LCALL   ?LD_R4567_XDPTR_L20
   \   1C9C  7813              MOV     R0,#19
   \   1C9E  120000            LCALL   ?SL_SHR_L01
   \   1CA1  EC                MOV     A,R4
   \   1CA2  540F              ANL     A,#15
   \   1CA4  FC                MOV     R4,A
   1293          }
   \   1CA5  900000            MOV     DPTR,#$LOCBX MemUsage+17
   \   1CA8  E0                MOVX    A,@DPTR
   \   1CA9  F8                MOV     R0,A
   \   1CAA  A3                INC     DPTR
   \   1CAB  E0                MOVX    A,@DPTR
   \   1CAC  C0E0              PUSH    ACC
   \   1CAE  E8                MOV     A,R0
   \   1CAF  C0E0              PUSH    ACC
   \   1CB1  22                RET
   1294          
   1295              
   1296              
   \   0000                    RSEG    CSTR
   \   0000            ?0186:
   \   0000  7700              DB      'w',0
   \   0002            ?0258:
   \   0002  7200              DB      'r',0
   \   0004            ?0278:
   \   0004  090900            DB      9,9,0
   \   0007            ?0353:
   \   0007  53747274          DB      'StrtDymk.xxx',0
   \   000B  44796D6B
   \   000F  2E787878
   \   0013  00
   \   0014            ?0356:
   \   0014  436F756C          DB      'Could not create dynamic break',0
   \   0018  64206E6F
   \   001C  74206372
   \   0020  65617465
   \   0024  2064796E
   \   0028  616D6963
   \   002C  20627265
   \   0030  616B00
   \   0033            ?0378:
   \   0033  556E6162          DB      'Unable to open file',0
   \   0037  6C652074
   \   003B  6F206F70
   \   003F  656E2066
   \   0043  696C6500
   \   0000                    RSEG    X_UDATA
   \   0000            writeAddress:
   \   0004                    DS      4
   \   0004            FLASHWriteState:
   \   0006                    DS      2
   \   0006            fs_files:
   \   00DE                    DS      216
   \   00DE            fs_currFilePtr:
   \   00E1                    DS      3
   \   00E1            FLASHKey:
   \   00E2                    DS      1
   \   00E2            dataFieldCounter:
   \   00E4                    DS      2
   \   00E4            readAddress:
   \   00E8                    DS      4
   \   00E8            eraseAddress:
   \   00EC                    DS      4
   \   00EC            writeInProgress:
   \   00ED                    DS      1
   \   00ED                    END


                                       S Y M B O L - T A B L E
                                       =======================


            #include file(s):

       [1]       c:\iar\ew\8051\inc\io517a.h
       [2]       c:\iar\ew\8051\inc\stdio.h
       [3]       c:\iar\ew\8051\inc\string.h
       [4]       main.h
       [5]       filesystem.h
       [6]       errorcodes.h
       [7]       filesystem.h
       [8]       rs232.h


            Symbol                     Type     Mem     Class   Defline   Refline(s)
            ------                     ----     ---     -----   -------   ----------

?0186                                 array    code    static      799        799
?0258                                 array    code    static      923        923     1001     1235     1262
?0278                                 array    code    static      975        975
?0353                                 array    code    static     1222       1222     1235
?0356                                 array    code    static     1224       1224
?0378                                 array    code    static     1276       1276
AC                                      bit             ---      166:1  
ACC                                     sfr             ---       14:1  
ADCON0                                  sfr             ---       99:1  
ADCON1                                  sfr             ---      100:1  
ADDATH                                  sfr             ---      101:1  
ADDATL                                  sfr             ---      102:1  
ADEX                                    bit             ---      133:1  
ADM                                     bit             ---      135:1  
ARCON                                   sfr             ---      105:1  
B                                       sfr             ---       15:1  
BD                                      bit             ---      131:1  
BSY                                     bit             ---      134:1  
CC4EN                                   sfr             ---       34:1  
CCEN                                    sfr             ---       33:1  
CCH1                                    sfr             ---       36:1  
CCH2                                    sfr             ---       38:1  
CCH3                                    sfr             ---       40:1  
CCH4                                    sfr             ---       42:1  
CCL1                                    sfr             ---       35:1  
CCL2                                    sfr             ---       37:1  
CCL3                                    sfr             ---       39:1  
CCL4                                    sfr             ---       41:1  
CLK                                     bit             ---      132:1  
CLRMSK                                  sfr             ---       74:1  
CMEN                                    sfr             ---       43:1  
CMH0                                    sfr             ---       45:1  
CMH1                                    sfr             ---       47:1  
CMH2                                    sfr             ---       49:1  
CMH3                                    sfr             ---       51:1  
CMH4                                    sfr             ---       53:1  
CMH5                                    sfr             ---       55:1  
CMH6                                    sfr             ---       57:1  
CMH7                                    sfr             ---       59:1  
CML0                                    sfr             ---       44:1  
CML1                                    sfr             ---       46:1  
CML2                                    sfr             ---       48:1  
CML3                                    sfr             ---       50:1  
CML4                                    sfr             ---       52:1  
CML5                                    sfr             ---       54:1  
CML6                                    sfr             ---       56:1  
CML7                                    sfr             ---       58:1  
CMSEL                                   sfr             ---       60:1  
COMCLRH                                 sfr             ---       72:1  
COMCLRL                                 sfr             ---       71:1  
COMSETH                                 sfr             ---       70:1  
COMSETL                                 sfr             ---       69:1  
CRCH                                    sfr             ---       62:1  
CRCL                                    sfr             ---       61:1  
CTCON                                   sfr             ---       63:1  
CTRELH                                  sfr             ---       65:1  
CTRELL                                  sfr             ---       64:1  
CY                                      bit             ---      165:1  
DPH                                     sfr             ---       18:1  
DPL                                     sfr             ---       17:1  
DPSEL                                   sfr             ---       19:1  
Dir                                function    code    public      965      113:5
EADC                                    bit             ---      205:1  
EAL                                     bit             ---      187:1  
ES0                                     bit             ---      190:1  
ET0                                     bit             ---      193:1  
ET1                                     bit             ---      191:1  
ET2                                     bit             ---      189:1  
EX0                                     bit             ---      194:1  
EX1                                     bit             ---      192:1  
EX2                                     bit             ---      204:1  
EX3                                     bit             ---      203:1  
EX4                                     bit             ---      202:1  
EX5                                     bit             ---      201:1  
EX6                                     bit             ---      200:1  
EXEN2                                   bit             ---      198:1  
EXF2                                    bit             ---      143:1  
EraseAll                           function    code    public     1247      109:5
EraseBlock                         function    code    public      353       94:5     1240     1250
EraseDynamic                       function    code    public     1232      111:5
F0                                      bit             ---      167:1  
F1                                      bit             ---      171:1  
FLASHKey                               char   xdata    public       67        354      356     1239     1249
FLASHWriteState                         int   xdata    public       54        226      233      260      269
                                                                              274      297      306      309
                                                                              317      328      334      341
                                                                              344      687      704      838
FileOpen                           function    code    public      481        498     1039
FindEmptyFileStruct                function    code    public      469        503     1044
GetFileHead                        function    code    public      430        518      557      879      918
                                                                              973     1058     1209     1288
I2FR                                    bit             ---      156:1  
I3FR                                    bit             ---      155:1  
IADC                                    bit             ---      150:1  
IE0                                     bit             ---      182:1  
IE1                                     bit             ---      180:1  
IEN0                                    sfr             ---      114:1  
IEN1                                    sfr             ---      116:1  
IEN2                                    sfr             ---      118:1  
IEX2                                    bit             ---      149:1  
IEX3                                    bit             ---      148:1  
IEX4                                    bit             ---      147:1  
IEX5                                    bit             ---      146:1  
IEX6                                    bit             ---      145:1  
INT0                                    bit             ---      214:1  
INT1                                    bit             ---      213:1  
IP0                                     sfr             ---      115:1  
IP1                                     sfr             ---      117:1  
IRCON0                                  sfr             ---      119:1  
IRCON1                                  sfr             ---      120:1  
IT0                                     bit             ---      183:1  
IT1                                     bit             ---      181:1  
InitializeFileSystem               function    code    public       81       84:5
InitializeFlash                    function    code    public       95       85:5
MD0                                     sfr             ---      106:1  
MD1                                     sfr             ---      107:1  
MD2                                     sfr             ---      108:1  
MD3                                     sfr             ---      109:1  
MD4                                     sfr             ---      110:1  
MD5                                     sfr             ---      111:1  
MX0                                     bit             ---      138:1  
MX1                                     bit             ---      137:1  
MX2                                     bit             ---      136:1  
MemUsage                           function    code    public     1283      112:5
OV                                      bit             ---      170:1  
P                                       bit             ---      172:1  
P0                                      sfr             ---       77:1  
P1                                      sfr             ---       78:1  
P2                                      sfr             ---       79:1  
P3                                      sfr             ---       80:1  
P4                                      sfr             ---       81:1         96       99      100      114
                                                                              118      119      124      125
                                                                              131      138      146      150
                                                                              151      155      156      162
                                                                              169      178      236      240
                                                                              241      249      250      256
                                                                              275      279      280      286
                                                                              287      293      310      329
                                                                              342      345      360      361
                                                                              365      366      371      372
                                                                              376      378
P5                                      sfr             ---       82:1  
P6                                      sfr             ---       83:1  
P7                                      sfr             ---       84:1  
P8                                      sfr             ---       85:1  
PCON                                    sfr             ---       88:1  
PSW                                     sfr             ---       20:1  
PerformWriteSeq                    function    code    public      340        320     93:5      688      705
                                                                             1189
RB80                                    bit             ---      225:1  
RD                                      bit             ---      209:1  
REN0                                    bit             ---      223:1  
RI0                                     bit             ---      227:1  
RS0                                     bit             ---      169:1  
RS1                                     bit             ---      168:1  
RXD                                     bit             ---      216:1  
ReadFLASH                          function    code    public      175       87:5      437      441      442
                                                                              443      444      448      451
                                                                              456      458      660     1098
                                                                             1103
ReleaseCurrFile                    function    code    public      685        597      647    108:5
S0BUF                                   sfr             ---       90:1  
S0CON                                   sfr             ---       89:1  
S0RELH                                  sfr             ---       94:1  
S0RELL                                  sfr             ---       93:1  
S1BUF                                   sfr             ---       92:1  
S1CON                                   sfr             ---       91:1  
S1RELH                                  sfr             ---       96:1  
S1RELL                                  sfr             ---       95:1  
SETMSK                                  sfr             ---       73:1  
SM0                                     bit             ---      220:1  
SM1                                     bit             ---      221:1  
SM20                                    bit             ---      222:1  
SP                                      sfr             ---       16:1  
SWDT                                    bit             ---      199:1        380      943     1006     1100
                                                                             1272
SYSCON                                  sfr             ---       22:1  
SendRS232                          function    code    extern     36:8        780      786      793      801
                                                                              803      812      834      836
                                                                              859      875      884      886
                                                                              897      901      926      928
                                                                              929      930      931      932
                                                                              941      945      946      959
                                                                             1004     1269
SendStringEOLRS232                 function    code    extern     38:8        978     1224     1276
SendStringRS232                    function    code    extern     37:8        885      974      975
SetupReadSeq                       function    code    public      113       86:5      182      541      650
                                                                              761     1093     1113
SetupSpareReadSeq                  function    code    public      145        436
SetupSpareWriteSeq                 function    code    public      268       1163
SetupWriteSeq                      function    code    public      225       90:5      311      577      604
                                                                             1150
StartDynamic                       function    code    public     1196      110:5
T0                                      bit             ---      212:1  
T1                                      bit             ---      211:1  
T2CM                                    bit             ---      159:1  
T2CON                                   sfr             ---       68:1  
T2I0                                    bit             ---      161:1  
T2I1                                    bit             ---      160:1  
T2PS                                    bit             ---      154:1  
T2R0                                    bit             ---      158:1  
T2R1                                    bit             ---      157:1  
TB80                                    bit             ---      224:1  
TCON                                    sfr             ---       25:1  
TF0                                     bit             ---      178:1  
TF1                                     bit             ---      176:1  
TF2                                     bit             ---      144:1  
TH0                                     sfr             ---       29:1  
TH1                                     sfr             ---       30:1  
TH2                                     sfr             ---       67:1  
TI0                                     bit             ---      226:1  
TL0                                     sfr             ---       27:1  
TL1                                     sfr             ---       28:1  
TL2                                     sfr             ---       66:1  
TMOD                                    sfr             ---       26:1  
TR0                                     bit             ---      179:1  
TR1                                     bit             ---      177:1  
TXD                                     bit             ---      215:1  
TerminateReadSeq                   function    code    public      189       88:5      438      463      692
                                                                              715      759
TerminateWriteSeq                  function    code    public      327       92:5      689      706     1190
Type                               function    code    public      997      114:5
TypeA                              function    code    public     1257      115:5
WDT                                     bit             ---      188:1        379      942     1005     1099
                                                                             1271
WDTREL                                  sfr             ---      124:1  
WR                                      bit             ---      210:1  
WaitAndReceiveRS232                function    code    extern     39:8        782      790      805      807
                                                                              815      824      880      891
                                                                              898      906      909      933
WriteFLASH                         function    code    public      305       91:5      610      614     1165
                                                                             1166     1167     1168     1169
                                                                             1175     1178     1183     1187
WriteFileHead                      function    code    public     1160        710     1140     95:5
XPAGE                                   sfr             ---       21:1  
commandLine                           array   xdata    extern       49       1001     1262
dataFieldCounter                        int   xdata    public       69        258      295      315      319
eraseAddress                           long   xdata    public       72        358      368      369     1237
                                                                             1238     1238     1248     1248
                                                                             1248
error                                   int   xdata    extern       46        228      234      271      307
                                                                              475      499      505      519
                                                                              523      548      560      564
                                                                              591      593      641      643
                                                                              700      754     1040     1046
fSetPos                            function    code    public      752      107:5
fclose                             function    code    public      698      104:5      854      948     1008
                                                                             1227     1242     1274
fdownLoad                          function    code    public      864      103:5
fgetLine                           function    code    public      671      102:5
fgetc                              function    code    public      637      101:5      676      680      939
                                                                             1004     1265
fopen                              function    code    public      493       96:5      799      923     1001
                                                                             1235     1262
fopenA                             function    code    public     1030       97:5     1222
fputc                              function    code    public      589       98:5      832     1226
fs_currFilePtr                      pointer   xdata    public       66         88      434      513      542
                                                                              554      578      595      605
                                                                              645      651      686      694
                                                                              702      717      758     1052
                                                                             1151     1204
fs_files                              array   xdata    public       65         85      473      473      485
ftell                              function    code    public      724      105:5
fupLoad                            function    code    public      769      100:5
msg                                   array   xdata    extern       48        977      978
myLong2HexStr                      function    code    extern    126:4        977
myStrCmpNoCase                     function    code    extern    130:4        485      526      563     1065
myStrCpy                           function    code    extern    124:4        533      569     1076
readAddress                            long   xdata    public       71        117      121      127      128
                                                                              129      149      158      159
                                                                              160      179      182      511
                                                                              522      527      527      534
                                                                              540      552      558      558
                                                                              559      570      649      760
                                                                              877      887      887      916
                                                                              920      920      971      987
                                                                              987     1050     1061     1066
                                                                             1066     1077     1089     1091
                                                                             1097     1098     1102     1108
                                                                             1112     1205     1210     1212
                                                                             1212     1286     1289     1289
                                                                             1292
timeout                                char   xdata    extern       47        791      808      816      825
                                                                              907      910
writeAddress                           long   xdata    public       53        232      239      243      252
                                                                              253      254      258      278
                                                                              289      290      291      295
                                                                              316      576      600      602
                                                                              709     1108     1109     1111
                                                                             1112     1138     1147
writeInProgress                        char   xdata    public       74         89      547      579      713
                                                                             1152


Errors: none
Warnings: none
Code size: 7346
Constant size: 71
Static variable size: Data(0) Idata(0) Bit(0) Xdata(237) Pdata(0) Bdata(0)

